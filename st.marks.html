<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes ST LMD - Semestre 1 - ISET'COM</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> <!-- Using Font Awesome 6 -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script id="aclib" type="text/javascript" src="//acscdn.com/script/aclib.js"></script>

    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --primary: 221.2 83.2% 53.3%; /* Blueish for ST */
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 142.1 76.2% 36.3%; /* Green accent */
            --accent-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 221.2 83.2% 53.3%; /* Same as primary */
            --radius: 0.75rem;
            --success: 142.1 76.2% 36.3%; /* Green */
            --warning: 38 92% 50%;
            --error: 0 84.2% 60.2%;
        }

        .dark {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --primary: 217.2 91.2% 59.8%; /* Darker Blue */
            --primary-foreground: 222.2 47.4% 11.2%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 142.1 70.6% 45.3%; /* Darker Green */
            --accent-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 224.3 76.3% 48%;
            --success: 142.1 70.6% 45.3%;
            --warning: 48 96.5% 53.9%;
            --error: 0 84.2% 60.2%;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s ease, color 0.3s ease;
            padding-top: 80px; /* Add padding to prevent content from going under sticky header */
        }

        .hero-bg { position: fixed; inset: 0; z-index: -10; overflow: hidden; } /* Use fixed position */
        .gradient-blob { position: absolute; border-radius: 9999px; filter: blur(80px); opacity: 0.4; }
        .gradient-blob-1 { top: 0; left: 0; right: 0; height: 500px; background: linear-gradient(to bottom right, hsl(var(--primary) / 0.4), hsl(var(--accent) / 0.2), hsl(var(--secondary) / 0.1)); transform: translateY(-50%); }
        .gradient-blob-2 { bottom: 0; right: 0; width: 500px; height: 500px; background: linear-gradient(to top right, hsl(var(--accent) / 0.3), hsl(var(--primary) / 0.2), transparent); }
        .floating-dot { position: absolute; border-radius: 9999px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } }

        .header-section {
            position: fixed; /* Make header sticky */
            top: 0;
            left: 0;
            right: 0;
            background: hsl(var(--card) / 0.85);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid hsl(var(--border));
            z-index: 50;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            padding: 1rem 0; /* Adjust padding */
        }
        .dark .header-section {
            background: hsl(var(--card) / 0.9);
            border-bottom-color: hsl(var(--border));
        }


        .main-content-card {
            background: hsl(var(--card) / 0.85); backdrop-filter: blur(12px); border: 1px solid hsl(var(--border));
            border-radius: var(--radius); padding: 2rem; box-shadow: 0 10px 35px rgba(0, 0, 0, 0.1); margin-top: 1rem; /* Reduced margin top */
            visibility: hidden; /* Hidden initially, shown after login */
        }
        .dark .main-content-card { background: hsl(var(--card) / 0.9); }

        .filters-container {
            margin-bottom: 2rem; padding: 1.5rem; background: hsl(var(--secondary) / 0.5);
            border-radius: var(--radius); border: 1px solid hsl(var(--border));
        }
        .dark .filters-container { background: hsl(var(--secondary) / 0.3); border-color: hsl(var(--border) / 0.5); }

        .page-title {
            font-size: 1.75rem; font-weight: 600; margin-bottom: 1.5rem; text-align: center;
            color: hsl(var(--primary));
        }
        .dark .page-title { color: hsl(var(--primary)); }

        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-label { font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; color: hsl(var(--muted-foreground)); }
        .filter-select {
            padding: 0.6rem 0.8rem; border: 1px solid hsl(var(--border)); border-radius: calc(var(--radius) / 1.5);
            background: hsl(var(--card)); color: hsl(var(--foreground)); transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .filter-select:focus { outline: none; border-color: hsl(var(--primary)); box-shadow: 0 0 0 2px hsl(var(--primary) / 0.2); }
        .dark .filter-select { background: hsl(var(--input)); border-color: hsl(var(--border)); color: hsl(var(--foreground)); }

        .back-button {
            display: inline-flex; align-items: center; gap: 0.5rem; color: hsl(var(--primary)); font-weight: 500;
            transition: all 0.3s ease; padding: 0.5rem 1rem; border-radius: 9999px; background: hsl(var(--primary) / 0.08);
        }
        .back-button:hover { background: hsl(var(--primary) / 0.15); transform: translateX(-3px); }
        .dark .back-button { color: hsl(var(--primary)); background: hsl(var(--primary) / 0.2); }
        .dark .back-button:hover { background: hsl(var(--primary) / 0.3); }


        /* Table Styles */
        .table-wrapper { overflow-x: auto; }
        .table-scroll { max-height: 60vh; overflow-y: auto; border: 1px solid hsl(var(--border)); border-radius: var(--radius); }
        #marksTable { width: 100%; border-collapse: collapse; }
        #marksTable th, #marksTable td {
            padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid hsl(var(--border)); white-space: nowrap;
        }
        #marksTable th {
            background: hsl(var(--secondary)); font-weight: 600; color: hsl(var(--secondary-foreground));
            font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .dark #marksTable th { background: hsl(var(--secondary)); color: hsl(var(--secondary-foreground)); }
        #marksTable tbody tr:hover { background-color: hsl(var(--secondary) / 0.5); }
        .dark #marksTable tbody tr:hover { background-color: hsl(var(--secondary) / 0.3); }

        .sticky-header { position: sticky; top: 0; z-index: 10; background: inherit; } /* Inherit background from th */
        .name-column { min-width: 200px; }
        .grade-column { text-align: center; min-width: 80px; }
        .text-cell { font-size: 0.875rem; color: hsl(var(--muted-foreground)); }
        .dark .text-cell { color: hsl(var(--muted-foreground)); }
        .grade-cell { text-align: center; font-weight: 500; font-size: 0.9rem; }
        .name-cell { font-weight: 500; }

        /* Grade Coloring */
        .grade-passing { color: hsl(var(--success)); }
        .dark .grade-passing { color: hsl(var(--success)); }
        .grade-failing { color: hsl(var(--error)); }
        .dark .grade-failing { color: hsl(var(--error)); }

        /* Founder Styling */
        .founder-row { background-color: hsl(var(--warning) / 0.1) !important; }
        .dark .founder-row { background-color: hsl(var(--warning) / 0.15) !important; }
        .founder-badge {
            display: inline-block; margin-left: 0.5rem; padding: 0.1rem 0.4rem; font-size: 0.7rem;
            font-weight: bold; color: hsl(var(--warning) / 1.2); background-color: hsl(var(--warning) / 0.2);
            border: 1px solid hsl(var(--warning) / 0.5); border-radius: 9999px; vertical-align: middle;
        }
        .dark .founder-badge { color: hsl(var(--warning)); background-color: hsl(var(--warning) / 0.25); border-color: hsl(var(--warning) / 0.6); }


        /* Sorting */
        .sortable { cursor: pointer; position: relative; padding-right: 1.5rem !important; }
        .sort-indicator {
            position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%);
            width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent;
            opacity: 0.4; transition: opacity 0.2s ease;
        }
        .sortable:hover .sort-indicator { opacity: 0.7; }
        .sort-indicator.sort-asc { border-bottom: 6px solid hsl(var(--foreground)); border-top: 0; opacity: 1; }
        .sort-indicator.sort-desc { border-top: 6px solid hsl(var(--foreground)); border-bottom: 0; opacity: 1; }
        .dark .sort-indicator.sort-asc { border-bottom-color: hsl(var(--foreground)); }
        .dark .sort-indicator.sort-desc { border-top-color: hsl(var(--foreground)); }

        /* Auth Overlay (Login Popup) Styles */
        .popup { /* General popup styles */
            position: fixed; inset: 0; background: hsla(var(--background), 0.5); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; opacity: 0; transition: opacity 0.3s ease;
        }
        .popup.active { display: flex; opacity: 1; }
        .popup-content-wrapper { /* Specific wrapper for content */
            background: hsl(var(--card)); border: 1px solid hsl(var(--border)); border-radius: var(--radius);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15); width: 100%; max-width: 450px; /* Adjusted max-width */
            overflow: hidden; display: flex; flex-direction: column; transform: scale(0.95) translateY(10px);
            transition: transform 0.3s ease, opacity 0.3s ease; padding: 2.5rem; text-align: center; /* Added padding & text-align */
        }
        .popup.active .popup-content-wrapper { transform: scale(1) translateY(0); opacity: 1; }
        .dark .popup-content-wrapper { background: hsl(var(--card) / 0.95); }
        
        .popup-content-wrapper h2 { /* Title inside the box */
            margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: 600; color: hsl(var(--primary));
        }
        .popup-content-wrapper input[type="password"] {
            width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid hsl(var(--border)); border-radius: calc(var(--radius) / 1.5);
            margin-bottom: 1.5rem; background: hsl(var(--background)); color: hsl(var(--foreground));
        }
        .dark .popup-content-wrapper input[type="password"] { background: hsl(var(--input)); border-color: hsl(var(--border)); color: hsl(var(--foreground)); }
        .popup-content-wrapper input[type="password"]:focus { outline: none; border-color: hsl(var(--primary)); box-shadow: 0 0 0 2px hsl(var(--primary) / 0.2); }
        
        .popup-content-wrapper button { /* Login button */
            width: 100%; padding: 0.75rem; font-size: 1rem; background: hsl(var(--primary)); color: hsl(var(--primary-foreground));
            border: none; border-radius: calc(var(--radius) / 1.5); cursor: pointer; transition: background-color 0.3s ease;
        }
        .popup-content-wrapper button:hover { background: hsl(var(--primary) / 0.9); }
        .dark .popup-content-wrapper button { background: hsl(var(--primary)); color: hsl(var(--primary-foreground)); }
        .dark .popup-content-wrapper button:hover { background: hsl(var(--primary) / 0.9); }
        
        .popup-content-wrapper .login-error {
            display: none; color: hsl(var(--error)); margin-top: 1rem; font-size: 0.9rem;
        }
        .popup-content-wrapper .auth-message {
            margin-top: 1.5rem; font-size: 0.85rem; color: hsl(var(--muted-foreground)); line-height: 1.5;
        }
        .instagram-link { color: #E1306C; text-decoration: none; font-weight: 500; }
        .instagram-link:hover { text-decoration: underline; }

        .theme-toggle {
            position: fixed; bottom: 1rem; right: 1rem; z-index: 1001; /* Above overlay */
            width: 3rem; height: 3rem; border-radius: 9999px;
            background: hsl(var(--card)); border: 1px solid hsl(var(--border)); display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .theme-toggle:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15); }
        .theme-toggle i { font-size: 1.25rem; color: hsl(var(--primary)); transition: transform 0.4s ease, color 0.3s ease; }
        .dark .theme-toggle i { color: hsl(var(--warning)); }
        .theme-toggle:hover i { transform: rotate(20deg) scale(1.1); }
        .dark .theme-toggle { background: hsl(var(--card) / 0.9); border-color: hsl(var(--border)); }

        .floating-particles { position: fixed; inset: 0; overflow: hidden; pointer-events: none; z-index: -5; } /* Use fixed position */
        .particle { position: absolute; border-radius: 50%; opacity: 0.7; animation: float 10s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.3; } 50% { transform: translate(var(--x), var(--y)) scale(1.2); opacity: 0.8; } }

        img[alt="ISET'COM Logo"] { max-width: 100px; transition: transform 0.3s ease; } /* Adjusted size */
        img[alt="ISET'COM Logo"]:hover { transform: scale(1.05); }
        .dark img[alt="ISET'COM Logo"] { filter: contrast(1.1) brightness(0.9); }

    </style>
</head>
<body class="flex flex-col"> <!-- Removed min-h-screen as body takes full height -->
    <!-- Hero Background -->
    <div class="hero-bg">
        <div class="gradient-blob gradient-blob-1"></div>
        <div class="gradient-blob gradient-blob-2"></div>
        <div class="floating-dot w-4 h-4 bg-blue-500 top-1/4 left-1/4"></div>
        <div class="floating-dot w-3 h-3 bg-green-500 top-1/3 right-1/4"></div>
        <div class="floating-dot w-2 h-2 bg-blue-400 bottom-1/4 left-1/3"></div>
        <div class="floating-dot w-3 h-3 bg-green-400 top-2/3 right-1/3"></div>
    </div>

    <!-- Floating Particles -->
    <div class="floating-particles" id="particles"></div>

    <!-- Header -->
    <header class="header-section">
        <div class="container mx-auto px-4 max-w-7xl flex items-center justify-between"> <!-- Wider container -->
            <div class="flex items-center gap-3">
                <img src="assets/img/LOGO.png" alt="ISET'COM Logo" />
                 <h1 class="text-xl md:text-2xl font-semibold text-gray-700 dark:text-gray-200">
                    Notes ST LMD - Semestre 1
                </h1>
            </div>
            <!-- Optional: Add navigation or other elements here -->
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 max-w-7xl flex-grow py-8"> <!-- Wider container -->
        <!-- This card wraps filters and table, initially hidden -->
        <div id="mainContentCard" class="main-content-card" data-aos="fade-up">
            <div class="filters-container">
              <h1 class="page-title">Consulter les Notes - Science et Technologie LMD</h1>
              <div class="filters-grid">
                <div class="filter-group">
                  <label for="sectionSelect" class="filter-label">Section:</label>
                  <select id="sectionSelect" class="filter-select">
                    <option value="">Toutes</option>
                    <option>A</option><option>B</option><option>C</option><option>D</option>
                    <option>E</option><option>F</option><option>G</option><option>H</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label for="groupSelect" class="filter-label">Groupe:</label>
                  <select id="groupSelect" class="filter-select">
                    <option value="">Tous</option>
                    <option>1</option><option>2</option><option>3</option><option>4</option>
                    <option>5</option><option>6</option><option>7</option><option>8</option>
                  </select>
                </div>
              </div>
              <div class="text-center mt-6">
                <a href="#" class="back-button" onclick="goBack()">
                  <i class="fas fa-arrow-left"></i>
                  <span>Retour S√©lection</span>
                </a>
              </div>
            </div>
            
            <div class="table-wrapper mt-6">
              <div class="table-scroll">
                <table id="marksTable">
                  <thead>
                    <tr>
                      <th class="name-column sticky-header">Nom et Pr√©nom</th>
                      <th class="sticky-header">Matricule</th>
                      <th class="sticky-header">Groupe</th>
                      <th class="grade-column sticky-header sortable" onclick="sortTable('Maths 1')">
                        Maths 1 <span class="sort-indicator"></span>
                      </th>
                      <th class="grade-column sticky-header sortable" onclick="sortTable('Phys1')">
                        Phys1 <span class="sort-indicator"></span>
                      </th>
                      <th class="grade-column sticky-header sortable" onclick="sortTable('Chimie 1')">
                        Chimie 1 <span class="sort-indicator"></span>
                      </th>
                      <th class="grade-column sticky-header sortable" onclick="sortTable('Info 1')">
                        Info 1 <span class="sort-indicator"></span>
                      </th>
                      <th class="grade-column sticky-header sortable" onclick="sortTable('MR')">
                        MR <span class="sort-indicator"></span>
                      </th>
                      <th class="grade-column sticky-header sortable" onclick="sortTable('MST1')">
                        MST1 <span class="sort-indicator"></span>
                      </th>
                      <th class="grade-column sticky-header sortable" onclick="sortTable('DED')">
                        DED <span class="sort-indicator"></span>
                      </th>
                      <th class="grade-column sticky-header sortable" onclick="sortTable('Angl 1')">
                        Angl 1 <span class="sort-indicator"></span>
                      </th>
                      <th class="grade-column sticky-header">Moyenne G√©n√©rale</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Table body will be populated by JavaScript -->
                     <tr><td colspan="12" class="text-center py-10 text-gray-500">Chargement des donn√©es...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
        </div> <!-- End main content card -->
    </main>

    <!-- Authentication Overlay -->
    <div id="loginOverlay" class="popup active"> <!-- Start as active -->
      <div class="popup-content-wrapper">
        <h2>Authentification Requise</h2>
        <input type="password" id="passwordInput" placeholder="Entrez le mot de passe">
        <button onclick="checkPassword()">Se Connecter</button>
        <p id="loginError" class="login-error">Mot de passe incorrect.</p>
        <p class="auth-message">
          Si tu es un √©tudiant ST LMD, contacte l'admin de la page 
          <a href="https://www.instagram.com/spot_campuselkseur" target="_blank" class="instagram-link">@spot_campuselkseur</a> 
          sur Instagram pour obtenir le mot de passe.
        </p>
      </div>
    </div>

    <footer class="text-center text-gray-600 dark:text-gray-400 text-sm py-6 border-t border-gray-200 dark:border-gray-700 mt-12">
         ¬© <span id="currentYear"></span> Universit√© de Bejaia. D√©velopp√© par 
         <a href="mailto:mehdi.amara@tech.univ-bejaia.dz" class="text-blue-500 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 font-semibold">Amara Mehdi</a>
         <p class="text-xs mt-1">Initiative √©tudiante non officielle √† des fins √©ducatives.</p>
     </footer>

    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
        <i class="fas fa-moon"></i>
    </button>

    <script>
        AOS.init({ duration: 800, once: true, offset: 50 });
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        function toggleTheme() {
            const body = document.body;
            const themeToggleIcon = document.querySelector('.theme-toggle i');
            if (body.classList.contains('dark')) {
                body.classList.remove('dark');
                themeToggleIcon.classList.remove('fa-sun'); themeToggleIcon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark');
                themeToggleIcon.classList.remove('fa-moon'); themeToggleIcon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            }
        }

        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            if (!particlesContainer) return;
            const colors = ['hsl(var(--primary))', 'hsl(var(--accent))', 'hsl(var(--warning))']; // Blue, Green, Yellow
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                particle.style.left = `${Math.random() * 100}vw`; particle.style.top = `${Math.random() * 100}vh`;
                const size = Math.random() * 2.5 + 1;
                particle.style.width = `${size}px`; particle.style.height = particle.style.width;
                particle.style.setProperty('--x', `${Math.random() * 150 - 75}px`); particle.style.setProperty('--y', `${Math.random() * 150 - 75}px`);
                particle.style.animationDuration = `${Math.random() * 15 + 8}s`; particle.style.animationDelay = `${Math.random() * 3}s`;
                particlesContainer.appendChild(particle);
            }
        }
        
        function closePopup(popupId) { // General close function (though only login uses it now)
            const popup = document.getElementById(popupId);
            if (popup) {
                popup.classList.remove('active');
                // Optional: Add outro animation class
                 setTimeout(() => {
                     if (!document.querySelector('.popup.active')) { // Re-enable scroll only if no popups are active
                          document.body.style.overflow = '';
                     }
                 }, 300); // Match animation duration
            }
        }

        // --- Existing ST Marks JS (slightly adapted) ---
        let marksData = [];
        let currentSort = { column: '', direction: 'asc' };

        function getBaseUrl() {
            const currentUrl = window.location.href;
            if (currentUrl.includes('icosium.store')) { return 'https://icosium.store/'; }
            if (currentUrl.includes('github.io')) { return 'https://amarameh.github.io/moyensy.github.io/'; }
            return './'; // Default for local testing
        }

        async function loadData() {
            try {
                const fullUrl = `${getBaseUrl()}data/Marks.json`;
                console.log('Attempting to load data from:', fullUrl);
                const response = await fetch(fullUrl, { method: 'GET', headers: { 'Accept': 'application/json', 'Cache-Control': 'no-cache' }});
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}, URL: ${fullUrl}`);
                const data = await response.json();
                if (!Array.isArray(data)) throw new Error('Invalid data format: expected array');

                marksData = data.filter(item => item.hasOwnProperty("N¬∞") || item.hasOwnProperty("Angl 1")); // Keep original filter logic
                console.log('Filtered data:', marksData.length, 'records');
                
                // Render table (initially hidden, shown on password success)
                renderTable(marksData);

            } catch (error) {
                console.error('Error loading data:', error);
                const tbody = document.querySelector('#marksTable tbody');
                tbody.innerHTML = `<tr><td colspan="12" class="text-center py-4 text-red-600 dark:text-red-400"><i class="fas fa-exclamation-triangle mr-2"></i>Erreur chargement donn√©es: ${error.message}</td></tr>`;
            }
        }

        function applyFilters() {
          const section = document.getElementById('sectionSelect').value;
          const group = document.getElementById('groupSelect').value;
          let filtered = marksData.filter(item => {
            const rowGroup = item["Group"] || "";
            const matchesSection = section ? rowGroup.startsWith(section) : true;
            const matchesGroup = group ? rowGroup.endsWith(group) : true;
            return matchesSection && matchesGroup;
          });
          
          // Re-apply sort if active
          if (currentSort.column) {
            sortData(filtered, currentSort.column, currentSort.direction); // Use a helper
          }
          renderTable(filtered);
        }
        
        function sortData(dataArray, column, direction) {
             dataArray.sort((a, b) => {
                let aVal = parseFloat(a[column]) || -1; // Treat NaN/missing as -1 for sorting
                let bVal = parseFloat(b[column]) || -1;
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            });
        }


        function renderTable(data) {
          const tbody = document.querySelector('#marksTable tbody');
          tbody.innerHTML = ''; // Clear previous rows
          
          if (data.length === 0) {
              tbody.innerHTML = `<tr><td colspan="12" class="text-center py-10 text-gray-500 dark:text-gray-400">Aucun r√©sultat trouv√© pour ces filtres.</td></tr>`;
              return;
          }
          
          data.forEach(item => {
            const tr = document.createElement('tr');
            const isFounder = item["N¬∞"] === "942" && item["Nom"] === "AMARA" && item["Pr√©nom"] === "MEHDI";
            if (isFounder) { tr.classList.add('founder-row'); }
            
            // Use || "" to handle potentially missing fields gracefully
            tr.innerHTML = `
              <td class="name-cell">
                ${item["Nom"] || ""} ${item["Pr√©nom"] || ""}
                ${isFounder ? '<span class="founder-badge">üëë Fondateur</span>' : ''}
              </td>
              <td class="text-cell">${item["Matricule"] || ""}</td>
              <td class="text-cell">${item["Group"] || ""}</td>
              <td class="grade-cell ${colorMark(item["Maths 1"])}">${item["Maths 1"] !== undefined ? item["Maths 1"] : ""}</td>
              <td class="grade-cell ${colorMark(item["Phys1"])}">${item["Phys1"] !== undefined ? item["Phys1"] : ""}</td>
              <td class="grade-cell ${colorMark(item["Chimie 1"])}">${item["Chimie 1"] !== undefined ? item["Chimie 1"] : ""}</td>
              <td class="grade-cell ${colorMark(item["Info 1"])}">${item["Info 1"] !== undefined ? item["Info 1"] : ""}</td>
              <td class="grade-cell ${colorMark(item["MR"])}">${item["MR"] !== undefined ? item["MR"] : ""}</td>
              <td class="grade-cell ${colorMark(item["MST1"])}">${item["MST1"] !== undefined ? item["MST1"] : ""}</td>
              <td class="grade-cell ${colorMark(item["DED"])}">${item["DED"] !== undefined ? item["DED"] : ""}</td>
              <td class="grade-cell ${colorMark(item["Angl 1"])}">${item["Angl 1"] !== undefined ? item["Angl 1"] : ""}</td>
              <td class="grade-cell text-gray-400 dark:text-gray-500 italic">N/A</td> <!-- Placeholder for Moyenne -->
            `;
            tbody.appendChild(tr);
          });
        }

        function colorMark(mark) {
          const num = parseFloat(mark);
          if (isNaN(num)) return 'text-gray-400 dark:text-gray-500'; // Style for missing marks
          return num < 10 ? 'grade-failing' : 'grade-passing';
        }

        function sortTable(column) {
          const moduleColumns = ['Maths 1', 'Phys1', 'Chimie 1', 'Info 1', 'MR', 'MST1', 'DED', 'Angl 1'];
          if (!moduleColumns.includes(column)) return;

          if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            currentSort.column = column;
            currentSort.direction = 'asc';
          }

          // Get currently filtered data to sort
          const section = document.getElementById('sectionSelect').value;
          const group = document.getElementById('groupSelect').value;
          let dataToSort = marksData.filter(item => {
             const rowGroup = item["Group"] || "";
             const matchesSection = section ? rowGroup.startsWith(section) : true;
             const matchesGroup = group ? rowGroup.endsWith(group) : true;
             return matchesSection && matchesGroup;
           });

          sortData(dataToSort, column, currentSort.direction); // Sort the filtered data

          updateSortIndicators(column);
          renderTable(dataToSort); // Render the sorted filtered data
        }

        function updateSortIndicators(column) {
          document.querySelectorAll('.sort-indicator').forEach(indicator => {
            indicator.classList.remove('sort-asc', 'sort-desc');
          });
          const th = document.querySelector(`th[onclick="sortTable('${column}')"]`);
          if (th) {
            const indicator = th.querySelector('.sort-indicator');
            indicator.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
          }
        }

        function goBack() {
            // Simplified: Go back to a general selection page or index. Adjust if needed.
            window.location.href = 'notes-science-technologie.html'; // Or your main notes page
        }

        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            const errorMsg = document.getElementById('loginError');
            const correctPassword = 'rattrapage'; // Keep original password
            
            if (input === correctPassword) {
                closePopup('loginOverlay'); // Use the general close function
                document.getElementById('mainContentCard').style.visibility = 'visible'; // Show main content
            } else {
                errorMsg.style.display = 'block';
                // Add shake animation to input on error
                const passInput = document.getElementById('passwordInput');
                passInput.classList.add('animate-shake'); // Requires animate-shake CSS
                setTimeout(() => {
                    errorMsg.style.display = 'none';
                    passInput.classList.remove('animate-shake');
                }, 3000);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark');
                document.querySelector('.theme-toggle i').classList.replace('fa-moon', 'fa-sun');
            }
            createParticles();
            loadData(); // Load data but content card remains hidden until login

            // Add filter listeners
             document.getElementById('sectionSelect').addEventListener('change', applyFilters);
             document.getElementById('groupSelect').addEventListener('change', applyFilters);

             // Handle closing the overlay if user clicks outside (optional, good UX)
             const loginOverlay = document.getElementById('loginOverlay');
             loginOverlay.addEventListener('click', (e) => {
                 if (e.target === loginOverlay) {
                     // Maybe don't close automatically on outside click for login?
                     // closePopup('loginOverlay'); 
                 }
             });

             // Handle Escape key for login overlay
             document.addEventListener('keydown', (e) => {
                 if (e.key === 'Escape' && loginOverlay.classList.contains('active')) {
                     // Don't close login with Esc, force password entry
                     // closePopup('loginOverlay'); 
                 }
             });
        });

    </script>

    <!-- Add shake animation -->
    <style>
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; transform: translate3d(0, 0, 0); }
    </style>
</body>
</html>