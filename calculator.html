<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculateur de Moyenne - Université de Bejaia</title>
    <meta name="description" content="Calculateur de moyenne simple et efficace pour les étudiants de l'Université de Bejaia. Calculez votre moyenne par semestre et module.">
    <meta name="author" content="Amara Mehdi">
    <meta name="keywords" content="Université de Bejaia, Moyenne, Calcul, Notes, Étudiant, E-Campus, FS sciences, calculatrice moyenne, rattrapage, compensation, LMD">
    <meta name="robots" content="index, follow">
    <link rel="icon" type="image/png" href="assets/img/icon.png">
    <meta property="og:url" content="https://amaramehdi.github.io/moyenne-universite-bejaia/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Calculateur de Moyenne Université de Bejaia">
    <meta property="og:description" content="Calculez facilement votre moyenne universitaire par semestre à l'Université de Bejaia.">
    <meta property="og:image"
        content="https://masterpiecer-images.s3.yandex.net/b08e69b27e0b11eeb532aaafe6635749:upscaled">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Orbitron:wght@400..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css">
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico">

    <!-- Google AdSense -->
    <!-- Removed AdSense script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7539806376887582"
        crossorigin="anonymous"></script>


    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4QK3R858YJ"></script>

    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config', 'G-4QK3R858YJ');
    </script>

    <!-- Firebase SDK -->
    <script type="module">
        import {
            initializeApp
        } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import {
            getFirestore,
            collection,
            getDocs,
            query,
            where,
            orderBy
        } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        // --- IMPORTANT: REPLACE WITH YOUR ACTUAL FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyB5XYqWKhHdiVDXJx4iOwtpxD8eUCPRfKU", // Replace with your actual API Key
            authDomain: "universite-de-bejaia-547fc.firebaseapp.com", // Replace with your actual Auth Domain
            projectId: "universite-de-bejaia-547fc", // Replace with your actual Project ID
            storageBucket: "universite-de-bejaia-547fc.firebasestorage.app", // Replace with your actual Storage Bucket
            messagingSenderId: "517622731583", // Replace with your actual Messaging Sender ID
            appId: "1:517622731583:web:25453d5e01226585bf798a", // Replace with your actual App ID
            measurementId: "G-SQ0WWSCS7B" // Replace with your actual Measurement ID
        };
        // ---------------------------------------------------------

        try {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.firestoreFunctions = {
                collection,
                getDocs,
                query,
                where,
                orderBy
            };
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            const placeholder = document.getElementById('module-placeholder');
            if (placeholder) {
                placeholder.textContent = 'Erreur d\'initialisation de la base de données. Veuillez réessayer plus tard.';
            }
        }
    </script>

    <style>
        /* --- Theme Variables (Copied from index.html) --- */
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --primary: 221.2 83.2% 53.3%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96.1%; /* Muted/Border like in index */
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 221.2 83.2% 53.3%; /* Using primary for general accent */
            --accent-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 221.2 83.2% 53.3%; /* Using primary again for ring, consistent with index */

            /* Calculator Specific Status Colors (Derived from shadcn/ui defaults) */
            --error: 0 84.2% 60.2%; /* Red */
            --success: 142.1 76.2% 36.3%; /* Green */
            --warning: 48 95.7% 64.9%; /* Amber */

            --radius: 0.5rem;
        }

        .dark {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --primary: 217.2 91.2% 59.8%;
            --primary-foreground: 222.2 47.4% 11.2%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 91.2% 59.8%; /* Using primary for general accent */
            --accent-foreground: 222.2 47.4% 11.2%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 224.3 76.3% 48%; /* Slightly different blue for ring */

            /* Calculator Specific Status Colors (Derived from shadcn/ui defaults) */
            --error: 0 84.2% 60.2%; /* Red */
            --success: 142.1 70.6% 45.3%; /* Green */
            --warning: 48 91.9% 69.2%; /* Amber */
        }

        /* --- Background Effects (Copied from index.html) --- */
         .hero-bg {
             position: absolute;
             inset: 0;
             z-index: -10;
             overflow: hidden;
         }

         .gradient-blob {
             position: absolute;
             border-radius: 9999px;
             filter: blur(60px);
             opacity: 0.4; /* Slightly less opaque than index */
         }

         .gradient-blob-1 {
             top: 0;
             left: 0;
             right: 0;
             height: 500px;
             background: linear-gradient(to bottom right, hsl(var(--primary) / 0.4), hsl(var(--ring) / 0.2), hsl(var(--accent) / 0.1));
             transform: translateY(-50%);
         }

         .gradient-blob-2 {
             bottom: 0;
             right: 0;
             width: 500px;
             height: 500px;
             background: linear-gradient(to top right, hsl(var(--ring) / 0.3), hsl(var(--accent) / 0.2), transparent);
         }

         .floating-dot {
             position: absolute;
             border-radius: 9999px;
             animation: pulse 2s infinite;
             z-index: -9; /* Ensure dots are above blobs but below content */
         }

         @keyframes pulse {
             0%, 100% { opacity: 0.5; transform: scale(1); }
             50% { opacity: 1; transform: scale(1.2); }
         }

        .floating-particles {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: -5; /* Below content, above blobs/dots */
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            opacity: 0.7;
            animation: float 10s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.3;
            }
            50% {
                transform: translate(var(--x), var(--y)) scale(1.2);
                opacity: 0.8;
            }
        }


        /* --- General Reset and Theme Application ---
        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            min-height: 100vh;
            background: hsl(var(--background)); /* Use theme variable */
            color: hsl(var(--foreground)); /* Use theme variable */
            display: flex;
            flex-direction: column;
             transition: background-color 0.3s ease, color 0.3s ease; /* Smooth theme transition */
             -webkit-tap-highlight-color: transparent;
        }

        .container {
            width: 90%;
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            flex-grow: 1;
            position: relative; /* Needed for z-index of content */
            z-index: 1; /* Ensure content is above background */
        }

        /* Header - Updated to match index.html style */
        .main-header {
            background: hsl(var(--background) / 0.8); /* Use background with transparency */
            backdrop-filter: blur(8px); /* Add blur */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Add shadow */
            padding: 1rem 0; /* Vertical padding */
            margin-bottom: 2.5rem; /* Space below header */
            position: relative; /* For back button positioning */
            border-bottom: 1px solid hsl(var(--border)); /* Add subtle border */
            text-align: center; /* Center content */
        }

        .main-header .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 1rem; /* Adjust container padding for header */
        }

         .main-header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0; /* No margin below title in simplified header */
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1); /* Keep dark shadow for contrast */
             color: hsl(var(--foreground)); /* Use foreground color for title */
         }


        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: hsl(var(--primary)); /* Use primary color */
            font-weight: 500;
            font-size: 0.9rem;
            padding: 0.4rem 0.8rem; /* Adjusted padding */
            border-radius: 9999px;
            background: hsl(var(--card) / 0.1); /* Use transparent card background */
            border: 1px solid hsl(var(--border)); /* Use border color */
            transition: all 0.3s ease;
            position: absolute;
            top: 50%;
            left: 1rem; /* Position to the far left */
            transform: translateY(-50%);
            z-index: 10;
             text-decoration: none;
             /* Added responsive adjustment */
             @media (max-width: 768px) {
                 position: static; /* Reset position on mobile */
                 transform: none; /* Reset transform */
                 margin-bottom: 1rem; /* Add space below button */
             }
        }

        .back-button:hover {
            background-color: hsl(var(--card) / 0.2);
            color: hsl(var(--foreground));
             /* Adjusted transform for static position on mobile */
             @media (min-width: 769px) { transform: translateY(-50%) scale(1.05); }
             @media (max-width: 768px) { transform: scale(1.05); }
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .back-button i {
            font-size: 1rem;
        }

        /* Removed logo container and image rules */
        /* .logo-container img { ... } */


        /* Main Card Styling */
        .glass-card {
            background: hsl(var(--card) / 0.07); /* Use transparent card background */
            backdrop-filter: blur(12px);
            border-radius: 1.2rem;
            padding: clamp(1.5rem, 5vw, 2.5rem);
            box-shadow: 0 8px 32px hsl(var(--background) / 0.1); /* Use background for shadow */
            border: 1px solid hsl(var(--border)); /* Use border color */
            margin-bottom: 2.5rem;
        }

        /* Selection Inputs Area */
        .selection-area {
            padding-bottom: 1.5rem;
            border-bottom: 1px solid hsl(var(--border)); /* Use border color */
            margin-bottom: 2rem;
        }

        .selection-inputs {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: hsl(var(--muted-foreground)); /* Use muted foreground for labels */
            font-size: 0.9rem;
        }

        select,
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 0.8rem 1rem;
            border-radius: 0.6rem;
            border: 1px solid hsl(var(--border)); /* Use border color */
            background-color: hsl(var(--input) / 0.1); /* Use transparent input background */
            color: hsl(var(--foreground)); /* Use foreground color for text */
            transition: all 0.3s ease;
            font-size: 0.95rem;
            line-height: 1.5;
             /* Remove default browser focus outline */
             outline: none;
        }
        select:hover,
        input[type="text"]:hover,
        input[type="number"]:hover {
             border-color: hsl(var(--primary) / 0.5);
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }


        select:focus,
        input:focus {
            border-color: hsl(var(--primary)); /* Use primary color for focus */
            box-shadow: 0 0 0 3px hsl(var(--primary) / 0.3); /* Use primary color for focus shadow */
        }

        .selection-input {
            padding: 12px 15px;
            border-radius: 10px;
             /* Removed inset shadow to be consistent with index inputs */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            /* Adjusted SVG fill color to be lighter */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23ccc' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2rem;
            touch-action: manipulation;
            cursor: pointer;
        }

        .selection-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .selection-input:focus {
            border-color: hsl(var(--primary)); /* Use primary color */
            box-shadow: 0 0 0 4px hsl(var(--primary) / 0.25); /* Use primary color for focus shadow */
        }

        /* Style options for better dark mode visibility */
        select option {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }


        /* Module card styles */
        .module-card {
            background: hsl(var(--card) / 0.08); /* Use transparent card background */
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            box-shadow: 0 4px 15px hsl(var(--background) / 0.1); /* Use background for shadow */
            border-left: 5px solid hsl(var(--primary)); /* Use primary color */
            transition: all 0.3s ease-out;
        }

        .module-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 25px hsl(var(--background) / 0.15); /* Use background for shadow */
            border-left-color: hsl(var(--accent)); /* Use accent color */
        }

        /* Note inputs grid */
        .note-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(85px, 1fr));
            gap: 1rem;
            margin: 0.75rem 0;
        }

        .note-field label {
            font-size: 0.85rem;
            font-weight: 600;
            color: hsl(var(--muted-foreground)); /* Use muted foreground */
            margin-bottom: 0.3rem;
        }

        .custom-input {
            text-align: center;
            font-weight: 500;
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
        }

        .custom-input:focus {
            border-color: hsl(var(--accent)); /* Use accent color */
            box-shadow: 0 0 0 3px hsl(var(--accent) / 0.3); /* Use accent color for shadow */
        }

        .input-error {
            border-color: hsl(var(--error)) !important; /* Use error color */
            background-color: hsl(var(--error) / 0.1) !important; /* Use transparent error background */
        }

        .module-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid hsl(var(--border)); /* Use border color */
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .avg-text {
            font-weight: 700;
            font-size: 1rem;
            color: hsl(var(--muted-foreground)); /* Default color */
        }

        /* Specific colors handled by JS inline style based on value */
        .avg-text[style*="--success)"] { color: hsl(var(--success)); }
        .avg-text[style*="--error)"] { color: hsl(var(--error)); }


        .elim-text {
            font-size: 0.8rem;
            font-style: italic;
            margin-left: 0.3rem;
            color: hsl(var(--error)); /* Use error color */
        }

        .min-exam-btn,
        .clear-module-btn {
            background: linear-gradient(to right, hsl(var(--primary)), hsl(var(--ring))); /* Use primary/ring gradient */
            color: hsl(var(--primary-foreground)); /* Use foreground on primary */
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clear-module-btn {
            background: linear-gradient(to right, hsl(var(--error)), hsl(var(--error) / 0.7)); /* Use error gradient */
            color: hsl(var(--error-foreground));
        }

        .min-exam-btn:hover,
        .clear-module-btn:hover {
            transform: translateY(-2px);
            filter: brightness(1.15);
        }

        /* Detailed results section */
        #resultats {
            transition: max-height 0.7s ease-out, opacity 0.5s ease-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            margin-top: 2.5rem;
        }

        #resultats.visible {
            max-height: 2000px;
            opacity: 1;
        }

        .module-result-card {
            border: 1px solid hsl(var(--border)); /* Use border color */
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
            font-size: 0.9rem;
            background: hsl(var(--card) / 0.05); /* Use transparent card background */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .module-result-card:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 15px hsl(var(--background) / 0.1); /* Use background for shadow */
        }

        .module-result-title {
            font-weight: 600;
            color: hsl(var(--foreground)); /* Use foreground color */
            margin-bottom: 0.3rem;
            font-size: 0.95rem;
        }

        .module-result-avg {
            font-weight: 700;
            font-size: 1.1rem;
             /* Colors set inline by JS based on value */
        }

        .module-result-elim {
            font-size: 0.75rem;
            font-style: italic;
            margin-left: 0.3rem;
            color: hsl(var(--error)); /* Use error color */
        }

        /* General average display - Improved Style */
        .moyenne-generale {
            background: hsl(var(--card) / 0.1); /* Use transparent card background */
            color: hsl(var(--foreground)); /* Use foreground color */
            border-radius: 1rem;
            padding: 2rem 1.5rem;
            box-shadow: 0 10px 35px hsl(var(--background) / 0.15); /* Use background for shadow */
            position: relative;
            overflow: hidden;
            animation: none; /* Remove subtlePulse for base state */
            text-align: center;
            transition: transform 0.4s ease, box-shadow 0.4s ease, background 0.4s ease, color 0.4s ease; /* Smooth transitions */
            border: 1px solid hsl(var(--border)); /* Use border color */
             /* Added a pseudo-element for a subtle background effect */
             &::before {
                 content: '';
                 position: absolute;
                 inset: 0;
                 background: linear-gradient(135deg, hsl(var(--primary) / 0.05), transparent 50%, hsl(var(--ring) / 0.05));
                 z-index: -1;
                 opacity: 0.5;
                 transition: opacity 0.4s ease;
             }
        }

        .moyenne-generale:hover {
            transform: translateY(-5px) scale(1.02); /* Adjusted hover slightly */
            box-shadow: 0 14px 45px hsl(var(--background) / 0.2); /* Use background for shadow */
            &::before {
                opacity: 0.7;
            }
        }


        .moyenne-generale.validated {
            background: linear-gradient(135deg, hsl(var(--success)) 0%, hsl(var(--success) / 0.7) 100%); /* Use success gradient */
            animation: subtlePulse 3s infinite alternate; /* Add pulse animation back when validated */
            box-shadow: 0 0 20px hsl(var(--success) / 0.5), 0 0 40px hsl(var(--success) / 0.3); /* Success glow */
            color: hsl(var(--success-foreground)); /* Set text color for validated state */
             &::before { display: none; } /* Hide subtle background when gradient is active */
        }
         .moyenne-generale.eliminated {
              background: linear-gradient(135deg, hsl(var(--error)) 0%, hsl(var(--error) / 0.7) 100%); /* Use error gradient */
              box-shadow: 0 0 20px hsl(var(--error) / 0.5), 0 0 40px hsl(var(--error) / 0.3); /* Error glow */
             color: hsl(var(--error-foreground)); /* Set text color for eliminated state */
             &::before { display: none; } /* Hide subtle background when gradient is active */
         }
         /* Add a style for the not-validated but not eliminated state */
         .moyenne-generale:not(.validated):not(.eliminated):has(.not-validated-status) {
             border-color: hsl(var(--warning)); /* Yellow border if close to validation */
             &::before {
                background: linear-gradient(135deg, hsl(var(--warning) / 0.05), transparent 50%, hsl(var(--warning) / 0.05));
                opacity: 0.6;
             }
         }


        .moyenne-generale-val {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.2rem;
            font-weight: 800;
            text-shadow: 0 2px 5px hsl(var(--background) / 0.1); /* Use background for shadow */
            transition: all 0.5s ease;
            margin-bottom: 0.75rem;
            line-height: 1;
            color: hsl(var(--foreground)); /* Default color */
        }

        .moyenne-generale.validated .moyenne-generale-val {
            color: hsl(var(--success-foreground)); /* Accent color when validated */
            text-shadow: 0 0 8px hsl(var(--success) / 0.8);
        }

        .moyenne-generale.eliminated .moyenne-generale-val {
            color: hsl(var(--error-foreground)); /* Foreground text on error gradient */
            text-shadow: 0 0 8px hsl(var(--error) / 0.8);
        }


        .progress-bar {
            width: 100%;
            height: 10px;
            background: hsl(var(--input) / 0.15); /* Use input color */
            border-radius: 5px;
            margin-top: 1.5rem;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(to right, hsl(var(--primary)), hsl(var(--ring))); /* Use primary/ring gradient */
            transition: width 1.5s cubic-bezier(0.25, 1, 0.5, 1);
            border-radius: 5px;
        }
        .moyenne-generale.eliminated .progress-bar-fill { background: linear-gradient(to right, hsl(var(--error)), hsl(var(--error) / 0.7)); }
         .moyenne-generale:not(.validated):not(.eliminated):has(.not-validated-status) .progress-bar-fill {
             background: linear-gradient(to right, hsl(var(--warning)), hsl(var(--warning) / 0.7)); /* Warning gradient */
         }


        #validation-status {
            margin-top: 1.2rem;
            font-weight: 600;
            font-size: 1.05rem;
            text-shadow: 1px 1px 2px hsl(var(--background) / 0.1); /* Use background for shadow */
            min-height: 1.5em;
             color: hsl(var(--muted-foreground)); /* Default color */
        }

        #validation-status.validated-status {
            color: hsl(var(--success)); /* Use success color */
        }

        #validation-status.eliminated-status {
            color: hsl(var(--error)); /* Use error color */
        }

        #validation-status.not-validated-status {
            color: hsl(var(--warning)); /* Use warning color */
        }

        .credits-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 1.2rem;
            padding-top: 1rem;
            border-top: 1px solid hsl(var(--border)); /* Use border color */
            font-size: 0.95rem;
            flex-wrap: wrap;
            gap: 0.75rem;
            color: hsl(var(--muted-foreground)); /* Default color for credits row */
        }

        .credits-row span {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 500;
        }

        .credits-row i {
            font-size: 1.1em;
        }

        #credits-validated {
            color: hsl(var(--success)); /* Use success color */
        }

        #credits-attempted {
            color: hsl(var(--foreground)); /* Use foreground color */
        }


        /* Guidance Section */
        #guidance-section {
            background: hsl(var(--card) / 0.05); /* Use transparent card background */
            border: 1px solid hsl(var(--border)); /* Use border color */
            border-left: 5px solid hsl(var(--primary)); /* Use primary accent border */
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
            box-shadow: 0 4px 15px hsl(var(--background) / 0.1); /* Use background for shadow */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
            color: hsl(var(--muted-foreground)); /* Default text color */
        }

        #guidance-section.visible {
            opacity: 1;
            transform: translateY(0);
        }
        #guidance-section.eliminated-guidance {
             border-left-color: hsl(var(--error)); /* Use error color */
        }
        #guidance-section.warning-guidance {
             border-left-color: hsl(var(--warning)); /* Use warning color */
        }
        #guidance-section.validated-guidance {
             border-left-color: hsl(var(--success)); /* Use success color */
        }


        #guidance-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: hsl(var(--primary)); /* Default title color */
        }
         #guidance-section.eliminated-guidance h3 { color: hsl(var(--error)); }
         #guidance-section.warning-guidance h3 { color: hsl(var(--warning)); }
         #guidance-section.validated-guidance h3 { color: hsl(var(--success)); }


        #guidance-section p {
            font-size: 0.95rem;
            line-height: 1.6;
            color: hsl(var(--muted-foreground)); /* Use muted foreground */
            margin-bottom: 1rem;
        }

        #guidance-section a {
            color: hsl(var(--primary)); /* Use primary color for links */
            font-weight: 500;
            transition: color 0.2s ease;
        }

        #guidance-section a:hover {
            color: hsl(var(--foreground)); /* Use foreground on hover */
            text-decoration: underline;
        }


        /* Instagram Button */
        .instagram-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-top: 1.5rem;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            /* Using specific Instagram gradient */
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            color: white; /* Keep white for Instagram gradient */
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .instagram-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            filter: brightness(1.1);
        }

        .instagram-btn i {
            font-size: 1.3em;
            margin-right: 0.5rem;
        }

        /* What-if section */
        .what-if-card {
            background: hsl(var(--card) / 0.05); /* Use transparent card background */
            border: 2px dashed hsl(var(--border)); /* Use border color */
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 2.5rem;
            box-shadow: 0 4px 15px hsl(var(--background) / 0.1); /* Use background for shadow */
        }

        .what-if-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .what-if-label {
            font-weight: 500;
            min-width: 120px;
            color: hsl(var(--foreground)); /* Use foreground color */
        }

        .what-if-input {
            padding: 8px 10px;
            border-radius: 6px;
            width: 90px;
            background: hsl(var(--input) / 0.1); /* Use transparent input background */
            color: hsl(var(--foreground)); /* Use foreground color */
            border: 1px solid hsl(var(--border)); /* Use border color */
            font-size: 0.9rem;
            text-align: center;
        }

        .what-if-input:focus {
            border-color: hsl(var(--accent)); /* Use accent color */
            box-shadow: 0 0 0 3px hsl(var(--accent) / 0.3); /* Use accent color for shadow */
        }

        .what-if-btn {
            background: linear-gradient(to right, hsl(var(--primary)), hsl(var(--ring))); /* Use primary/ring gradient */
            color: hsl(var(--primary-foreground)); /* Use foreground on primary */
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .what-if-btn:hover {
            background: linear-gradient(to right, hsl(var(--ring)), hsl(var(--primary)));
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        .what-if-btn i {
            margin-right: 0.4rem;
        }

        /* Action buttons row */
        .action-buttons-row {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid hsl(var(--border)); /* Use border color */
        }

        .action-btn {
            padding: 0.7rem 1.4rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 5px hsl(var(--background) / 0.1); /* Use background for shadow */
        }

        .action-btn:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 4px 10px hsl(var(--background) / 0.15); /* Use background for shadow */
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .tooltip {
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            background: hsl(var(--foreground) / 0.95); /* Use foreground with transparency */
            color: hsl(var(--background)); /* Use background color for text */
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.75rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
            z-index: 20;
            pointer-events: none;
        }

        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: hsl(var(--foreground) / 0.95) transparent transparent transparent; /* Match tooltip background */
        }

        .action-btn:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }


        .save-load-btn {
            background: linear-gradient(to right, hsl(var(--primary)), hsl(var(--ring))); /* Use primary/ring gradient */
            color: hsl(var(--primary-foreground)); /* Use foreground on primary */
        }

        .clear-btn {
            background: linear-gradient(to right, hsl(var(--error)), hsl(var(--error) / 0.7)); /* Use error gradient */
            color: hsl(var(--error-foreground)); /* Use foreground on error */
        }

        .calculate-btn {
            background: linear-gradient(135deg, hsl(var(--accent)), hsl(var(--primary))); /* Use accent/primary gradient */
            color: hsl(var(--accent-foreground)); /* Use foreground on accent */
        }


        /* Loader animation */
        .loader {
            border: 4px solid hsl(var(--border)); /* Use border color */
            border-top: 4px solid hsl(var(--primary)); /* Use primary color */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            display: inline-block;
            vertical-align: middle;
        }

        .action-btn .loader {
            width: 18px;
            height: 18px;
            border-width: 3px;
            margin-left: 0.5rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: hsl(var(--background) / 0.75); /* Darker overlay */
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: hsl(var(--card)); /* Use card background */
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 90%;
            width: 450px;
            box-shadow: 0 10px 40px hsl(var(--background) / 0.2); /* Use background for shadow */
            position: relative;
            animation: slideIn 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            color: hsl(var(--foreground)); /* Use foreground color */
            border: 1px solid hsl(var(--border)); /* Use border color */
        }

        @keyframes slideIn {
            from {
                transform: translateY(-30px) scale(0.95);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .modal-close {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: hsl(var(--error)); /* Use error color */
            color: hsl(var(--error-foreground)); /* Use foreground on error */
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1rem;
            line-height: 30px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: hsl(var(--error) / 0.8); /* Darker error on hover */
            transform: scale(1.1);
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-btn {
            padding: 0.6rem 1.8rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.2s ease;
            border: none;
            box-shadow: 0 2px 5px hsl(var(--background) / 0.1); /* Use background for shadow */
        }

        .modal-btn:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        .modal-btn.confirm {
            background: hsl(var(--primary)); /* Use primary color */
            color: hsl(var(--primary-foreground)); /* Use foreground on primary */
        }

        .modal-btn.cancel {
            background: hsl(var(--error)); /* Use error color */
            color: hsl(var(--error-foreground)); /* Use foreground on error */
        }

        /* Removed Ad Placeholder Styling */
        /* .ad-container { ... } */


        /* Responsive adjustments */
        @media (min-width: 768px) {
            .selection-inputs {
                flex-direction: row;
                justify-content: space-between;
                gap: 1.5rem;
            }

            .form-group {
                flex: 1;
                min-width: 0;
            }

            /* Back button handled in .back-button rule */
        }

        @media (max-width: 768px) {
            .note-inputs {
                grid-template-columns: repeat(auto-fit, minmax(75px, 1fr));
            }

            .glass-card {
                padding: 1.2rem;
            }

            .module-card {
                padding: 1rem;
            }

            body {
                padding-bottom: 60px;
            }

            .moyenne-generale-val {
                font-size: 2.8rem;
            }

             /* Header responsiveness handled in .main-header and .back-button */
             .main-header h1 { font-size: 1.8rem; }

            .selection-inputs {
                flex-direction: column;
                gap: 1rem;
            }

            .form-group {
                width: 100%;
            }

            .main-header {
                margin-bottom: 1rem;
            }

             /* Header content centering no longer needed with simplified header */
            /* .header-content { ... } */

            /* Back button responsiveness handled in .back-button rule */
            /* .back-button { ... } */

            /* Removed logo container responsiveness */
            /* .logo-container { ... } */


            .action-buttons-row {
                gap: 0.75rem;
            }

            .action-btn {
                padding: 0.7rem 1.2rem;
            }

            .modal-content {
                padding: 1.5rem;
                width: 95%;
            }

            .moyenne-generale-val {
                font-size: 2.5rem;
            }

             /* Title banner rules removed */
            /* .title-banner h1 { ... } */
            /* .title-banner { ... } */


            .credits-row {
                flex-direction: column;
                gap: 0.5rem;
            }
             .what-if-label { min-width: auto; }
             .what-if-row { justify-content: center; }
             .what-if-input { width: 100%; max-width: 120px; }
        }

        @media (max-width: 480px) {
            .selection-input,
            .custom-input {
                font-size: 0.9rem;
                padding: 10px 12px;
            }

            .what-if-row {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }

            .what-if-input {
                width: 100%;
                max-width: 120px;
                margin: 0 auto;
            }

            footer {
                padding: 1.5rem 0.75rem;
            }

            .container {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }

            .action-btn {
                padding: 0.7rem;
                font-size: 0.9rem;
                gap: 0.4rem;
            }

            .modal-content {
                padding: 1.5rem;
                width: 95%;
            }

            .moyenne-generale-val {
                font-size: 2.5rem;
            }

             /* Title banner rules removed */
            /* .title-banner h1 { ... } */
            /* .title-banner { ... } */

            .what-if-label {
                min-width: auto;
            }
        }

        /* Footer styles */
        footer {
            background: hsl(var(--background) / 0.8); /* Use background with transparency */
            backdrop-filter: blur(5px);
            color: hsl(var(--muted-foreground)); /* Use muted foreground */
            padding: 2.5rem 1rem;
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            box-shadow: 0 -5px 25px hsl(var(--background) / 0.25); /* Use background for shadow */
            margin-top: auto;
            border-top: 1px solid hsl(var(--border)); /* Use border color */
            text-align: center;
        }

        footer a {
            color: hsl(var(--primary)); /* Use primary color */
            transition: color 0.2s ease, text-shadow 0.2s ease;
        }

        footer a:hover {
            color: hsl(var(--foreground)); /* Use foreground on hover */
            text-shadow: 0 0 5px hsl(var(--primary) / 0.5); /* Glow effect */
        }

        .footer-icon {
            color: hsl(var(--muted-foreground)); /* Use muted foreground */
            transition: transform 0.3s ease, color 0.2s ease;
            font-size: 1.4rem;
        }

        .footer-icon:hover {
            transform: scale(1.2) translateY(-2px);
            color: hsl(var(--primary)); /* Use primary color on hover */
        }

        .footer-links {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            gap: 1.5rem;
        }

        footer p {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        footer .copyright {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 1.5rem;
        }

         /* --- Theme Toggle (Copied from index.html) --- */
         .theme-toggle {
             position: fixed;
             bottom: 1rem;
             right: 1rem;
             z-index: 50;
             width: 3rem;
             height: 3rem;
             border-radius: 9999px;
             background: hsl(var(--background) / 0.8);
             backdrop-filter: blur(8px);
             border: 1px solid hsl(var(--border));
             display: flex;
             align-items: center;
             justify-content: center;
             cursor: pointer;
             transition: all 0.3s ease;
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
         }

         .theme-toggle:hover {
             transform: translateY(-2px);
             box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
         }

         .theme-toggle i {
             font-size: 1.25rem;
             color: hsl(var(--primary));
             transition: color 0.3s ease;
         }
    </style>
</head>
<body class="min-h-screen">
     <!-- Hero Background (Copied from index.html) -->
    <div class="hero-bg">
        <div class="gradient-blob gradient-blob-1"></div>
        <div class="gradient-blob gradient-blob-2"></div>
        <div class="floating-dot w-4 h-4 bg-blue-500 top-1/4 left-1/4"></div>
        <div class="floating-dot w-3 h-3 bg-purple-500 top-1/3 right-1/4"></div>
        <div class="floating-dot w-2 h-2 bg-green-500 bottom-1/4 left-1/3"></div>
        <div class="floating-dot w-3 h-3 bg-amber-500 top-2/3 right-1/3"></div>
    </div>

    <!-- Floating Particles (Copied from index.html) -->
    <div class="floating-particles" id="particles"></div>

    <!-- Header - Updated structure -->
    <header class="main-header" data-aos="fade-down">
        <div class="container"> <!-- Keep container for centering -->
            <a href="index.html" class="back-button" aria-label="Retour à la page d'accueil"><i
                    class="fas fa-arrow-left"></i> Retour</a>
            <h1 class="text-3xl font-bold">Calculateur de Moyenne</h1>
            <!-- Removed logo container -->
        </div>
    </header>
    <!-- Removed Title Banner -->

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-5xl flex-grow py-6">


        <div class="glass-card">
            <div class="selection-area">
                <div class="selection-inputs">
                    <div class="form-group">
                        <label for="anneeSelect">Année</label>
                        <select id="anneeSelect" class="selection-input"></select>
                    </div>
                    <div class="form-group">
                        <label for="specialiteSelect">Spécialité</label>
                        <select id="specialiteSelect" class="selection-input" disabled></select>
                    </div>
                    <div class="form-group">
                        <label for="semestreSelect">Semestre</label>
                        <select id="semestreSelect" class="selection-input" disabled></select>
                    </div>
                </div>
            </div>

            <div id="noteForm" class="space-y-4">
                <p id="module-placeholder" class="text-center text-muted-foreground py-8">Chargement des données... <span
                        class="loader"></span></p>
            </div>

            <div id="what-if-section" class="what-if-card hidden" data-aos="fade-up" data-aos-delay="100">
                <h3 class="text-lg font-semibold mb-3 text-foreground">Calcul "Et Si ?"</h3>
                <p class="text-sm text-muted-foreground mb-4">Entrez vos notes de TD/TP pour calculer la note d'examen nécessaire afin d'atteindre une moyenne cible.</p>
                <div class="what-if-row">
                    <label for="targetAverage" class="what-if-label text-foreground">Moyenne Cible :</label>
                    <input type="number" id="targetAverage" class="what-if-input" min="0" max="20" step="0.01" value="10.00" aria-label="Moyenne cible pour le calcul Et Si">
                    <button onclick="calculateWhatIf()" class="what-if-btn" aria-label="Calculer la note minimale d'examen pour la moyenne cible"><i class="fas fa-flask mr-2"></i>
                        Calculer Notes Examen</button>
                </div>
            </div>

            <div class="action-buttons-row">
                <button id="saveBtn" onclick="saveGrades()" class="action-btn save-load-btn" disabled
                    aria-label="Sauvegarder les notes">
                    <i class="fas fa-save"></i> <span class="button-text">Sauvegarder</span> <span id="saveLoader"
                        class="loader hidden"></span>
                    <span class="tooltip">Sauvegarder vos notes dans votre navigateur</span>
                </button>
                <button id="loadBtn" onclick="loadGrades()" class="action-btn save-load-btn" disabled
                    aria-label="Charger les notes sauvegardées">
                    <i class="fas fa-download"></i> <span class="button-text">Charger</span> <span id="loadLoader"
                        class="loader hidden"></span>
                    <span class="tooltip">Charger les notes précédemment sauvegardées</span>
                </button>
                <button id="clearBtn" onclick="clearGrades()" class="action-btn clear-btn" disabled
                    aria-label="Effacer toutes les notes">
                    <i class="fas fa-trash-alt"></i> <span class="button-text">Effacer</span>
                    <span class="tooltip">Effacer toutes les notes de ce semestre</span>
                </button>
                <button id="calculateBtn" onclick="calculerMoyenneGenerale()" class="action-btn calculate-btn"
                    disabled aria-label="Calculer la moyenne générale du semestre">
                    <i class="fas fa-calculator mr-2"></i> <span class="button-text">Calculer Moyenne</span>
                    <span class="tooltip">Calculer la moyenne générale du semestre</span>
                </button>
            </div>

            <div id="resultats" class="mt-8" data-aos="fade-up" data-aos-delay="200">
                <h2 class="text-xl font-bold mb-4 text-center text-foreground border-b pb-3 border-border">Résultats
                    Détaillés</h2>
                <div id="modules-results" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"></div>
                <div id="moyenneGenerale" class="moyenne-generale">
                    <h3 class="text-lg font-semibold mb-2">Moyenne Générale du Semestre</h3>
                    <div id="moyenne-generale-val" class="moyenne-generale-val">--</div>
                    <div class="progress-bar">
                        <div id="progressBarFill" class="progress-bar-fill" style="width: 0%"></div>
                    </div>
                    <p id="validation-status" class="mt-3 font-medium text-base"></p>
                    <div id="credits-results" class="credits-row">
                        <span id="credits-attempted"><i class="fas fa-cube"></i> Crédits Semestre: --</span>
                        <span id="credits-validated"><i class="fas fa-check-circle"></i> Crédits Validés: --</span>
                    </div>
                    <!-- Instagram Button -->
                    <a href="https://www.instagram.com/spot_campuselkseur/" target="_blank" rel="noopener noreferrer"
                        class="instagram-btn">
                        <i class="fab fa-instagram"></i> Suivre Spot Campus El Kseur
                    </a>
                </div>
            </div>

            <!-- Guidance Section -->
            <div id="guidance-section" class="hidden" data-aos="fade-up" data-aos-delay="300">
                <h3 id="guidance-title"></h3>
                <p id="guidance-text"></p>
            </div>
            <!-- End Guidance Section -->

        </div>

        <!-- Removed AdSense Ad Unit 2 -->
        <!-- <div class="ad-container">...</div> -->

    </div>

    <footer class="text-center">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-5xl">
            <p>Conçu et développé avec <i class="fas fa-heart" style="color: hsl(var(--error));"></i> par <a
                    href="mailto:mehdi.amara@tech.univ-bejaia.dz" class="font-medium">Amara Mehdi</a>.</p>
            <div class="footer-links">
                <a href="https://github.com/AmaraMehdi" target="_blank" rel="noopener noreferrer" class="footer-icon" aria-label="GitHub"><i class="fab fa-github"></i></a>
                <a href="https://www.linkedin.com/in/amara-mehdi/" target="_blank" rel="noopener noreferrer" class="footer-icon" aria-label="LinkedIn"><i class="fab fa-linkedin"></i></a>
                <a href="mailto:mehdi.amara@tech.univ-bejaia.dz" class="footer-icon" aria-label="Contact Email"><i
                        class="fas fa-envelope"></i></a>
            </div>
            <p class="copyright">© <span id="currentYear">2024</span> Université de Bejaia. Tous droits réservés. | Version 0.5.1</p>
            <p class="text-xs opacity-70 mt-2">Pour toute question ou suggestion, <a
                    href="mailto:mehdi.amara@tech.univ-bejaia.dz" class="underline">contactez le développeur</a>.</p>
        </div>
    </footer>


    <!-- Modals -->
    <div id="minExamModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('minExamModal')" aria-label="Fermer">×</button>
            <h3 class="text-lg font-semibold mb-3">Note Requise</h3>
            <p id="minExamMessage" class="text-foreground"></p>
        </div>
    </div>

    <div id="clearConfirmModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('clearConfirmModal')" aria-label="Fermer">×</button>
            <h3 class="text-lg font-semibold mb-3">Confirmer l'effacement</h3>
            <p class="text-foreground">Voulez-vous vraiment effacer toutes les notes ? Cette action est irréversible et les
                notes sauvegardées localement pour cette sélection seront supprimées.</p>
            <div class="modal-buttons">
                <button class="modal-btn confirm" onclick="confirmClearGrades()">Oui, Effacer</button>
                <button class="modal-btn cancel" onclick="closeModal('clearConfirmModal')">Annuler</button>
            </div>
        </div>
    </div>

     <!-- Theme Toggle Button (Copied from index.html) -->
    <button class="theme-toggle" onclick="toggleTheme()">
        <i class="fas fa-moon"></i>
    </button>


    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({
            duration: 800,
            once: true,
            offset: 100
        });

        // Set current year in footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();


        // --- DOM Element Caching ---
        const anneeSelect = document.getElementById('anneeSelect');
        const specialiteSelect = document.getElementById('specialiteSelect');
        const semestreSelect = document.getElementById('semestreSelect');
        const noteForm = document.getElementById('noteForm');
        const modulePlaceholder = document.getElementById('module-placeholder');
        const resultatsDiv = document.getElementById('resultats');
        const modulesResultsDiv = document.getElementById('modules-results');
        const moyenneGeneraleDiv = document.getElementById('moyenne-generale-val');
        const validationStatusDiv = document.getElementById('validation-status');
        const creditsAttemptedSpan = document.getElementById('credits-attempted');
        const creditsValidatedSpan = document.getElementById('credits-validated');
        const progressBarFill = document.getElementById('progressBarFill');
        const moyenneGeneraleContainer = document.getElementById('moyenneGenerale');
        const calculateBtn = document.getElementById('calculateBtn');
        const saveBtn = document.getElementById('saveBtn');
        const loadBtn = document.getElementById('loadBtn');
        const clearBtn = document.getElementById('clearBtn');
        const whatIfSection = document.getElementById('what-if-section');
        const targetAverageInput = document.getElementById('targetAverage');
        const saveLoader = document.getElementById('saveLoader');
        const loadLoader = document.getElementById('loadLoader');
        const guidanceSection = document.getElementById('guidance-section');
        const guidanceTitle = document.getElementById('guidance-title');
        const guidanceText = document.getElementById('guidance-text');


        // --- State Variables ---
        let years = [];
        let specialties = [];
        let allModules = []; // Cache for modules of the selected specialty
        let currentModulesData = []; // Modules currently displayed for the selected semester
        let calculatedResults = {}; // Store results from the last calculation


        // --- Modal Functions ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'flex';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
        }

        // --- Debounce Utility ---
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // --- Event Delegation for Inputs ---
        noteForm.addEventListener('input', debounce((event) => {
            if (event.target.classList.contains('module-grade-input')) {
                validateGradeInput(event.target);
            }
        }, 350));


        // --- Data Fetching ---
        async function fetchInitialData() {
            if (!window.db || !window.firestoreFunctions) {
                console.error("Firestore non initialisé. Impossible de récupérer les données.");
                modulePlaceholder.textContent = 'Erreur: Connexion base de données échouée.';
                enableDisableControls(); // Ensure controls are disabled on failure
                return;
            }
            modulePlaceholder.innerHTML = 'Chargement initial... <span class="loader"></span>';
            try {
                const [yearsSnapshot, specialtiesSnapshot] = await Promise.all([
                    window.firestoreFunctions.getDocs(window.firestoreFunctions.query(
                        window.firestoreFunctions.collection(window.db, 'years'),
                        window.firestoreFunctions.orderBy('order', 'asc')
                    )),
                    window.firestoreFunctions.getDocs(window.firestoreFunctions.collection(window.db, 'specialties'))
                ]);

                years = yearsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                specialties = specialtiesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                populateAnneeSelect(); // This will chain to populateSpecialiteSelect
                // Initial placeholder text is set in populateSpecialiteSelect
            } catch (error) {
                console.error('Erreur fetchInitialData:', error);
                modulePlaceholder.textContent = 'Erreur de chargement initial. Veuillez vérifier votre connexion ou réessayer.';
                enableDisableControls(); // Ensure controls are disabled on failure
            }
        }

        async function fetchModules() {
            if (!window.db || !window.firestoreFunctions) {
                console.error("Firestore non initialisé. Impossible de récupérer les modules.");
                modulePlaceholder.textContent = 'Erreur: Chargement modules impossible.';
                return;
            }
            const selectedSpecialtyId = specialiteSelect.value;
            allModules = []; // Reset cache before fetching
            populateSemestreSelect(); // Update semester dropdown (will show 'loading' or 'none')

            if (!selectedSpecialtyId) {
                modulePlaceholder.textContent = 'Sélectionnez une spécialité.';
                enableDisableControls();
                return; // Exit if no specialty selected
            }

            modulePlaceholder.innerHTML = 'Chargement des modules... <span class="loader"></span>';
            try {
                const modulesQuery = window.firestoreFunctions.query(
                    window.firestoreFunctions.collection(window.db, 'modules'),
                    window.firestoreFunctions.where('specialtyId', '==', selectedSpecialtyId)
                );
                const modulesSnapshot = await window.firestoreFunctions.getDocs(modulesQuery);
                allModules = modulesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log(`Fetched ${allModules.length} modules for specialty ${selectedSpecialtyId}`);
            } catch (error) {
                console.error('Erreur fetchModules:', error);
                modulePlaceholder.textContent = 'Erreur chargement modules.';
            } finally {
                populateSemestreSelect(); // Populate semesters based on fetched modules (or show error)
                enableDisableControls(); // Update control states after fetching
            }
        }


        // --- Dropdown Population ---
        function populateAnneeSelect() {
            anneeSelect.innerHTML = '<option value="">-- Sélection Année --</option>';
            years.forEach(year => {
                anneeSelect.add(new Option(year.name, year.id));
            });
            anneeSelect.disabled = false;
            populateSpecialiteSelect(); // Always trigger the next dropdown state
        }

        function populateSpecialiteSelect() {
            const selectedYearId = anneeSelect.value;
            specialiteSelect.innerHTML = '<option value="">-- Sélection Spécialité --</option>';
            specialiteSelect.disabled = true;

            semestreSelect.innerHTML = '<option value="">-- Sélection Semestre --</option>';
            semestreSelect.disabled = true;

            resetCalculatorState(); // Clear form and results

            if (selectedYearId) {
                const filteredSpecialties = specialties.filter(s => s.yearId === selectedYearId);
                if (filteredSpecialties.length > 0) {
                    filteredSpecialties.forEach(spec => {
                        specialiteSelect.add(new Option(spec.name, spec.id));
                    });
                    specialiteSelect.disabled = false;
                    modulePlaceholder.textContent = 'Sélectionnez une spécialité.';
                } else {
                    specialiteSelect.innerHTML = '<option value="">-- Aucune Spécialité --</option>';
                    modulePlaceholder.textContent = 'Aucune spécialité trouvée pour cette année.';
                }
                // Fetch modules only when a year is selected. They will be filtered by specialty later.
                // Delaying fetch until specialty selected is also a valid approach, depends on data size.
                // Let's stick to fetching all for the year for now, as it simplifies semester population.
                 fetchModules();

            } else {
                modulePlaceholder.textContent = 'Sélectionnez une année.';
                allModules = []; // Clear modules if year is unselected
            }
            enableDisableControls();
        }

        function populateSemestreSelect() {
            const selectedSpecialtyId = specialiteSelect.value;
            semestreSelect.innerHTML = '<option value="">-- Sélection Semestre --</option>';
            semestreSelect.disabled = true;

            resetCalculatorState(); // Clear form and results

            if (selectedSpecialtyId && allModules.length > 0) {
                // Filter from the fetched allModules based on *both* specialty and semester
                const modulesForSpecialty = allModules.filter(m => m.specialtyId === selectedSpecialtyId);
                const semesterKeys = [...new Set(modulesForSpecialty.map(m => m.semesterKey).filter(Boolean))].sort(); // Filter out undefined/null keys

                if (semesterKeys.length > 0) {
                    semesterKeys.forEach(key => {
                        semestreSelect.add(new Option(key, key));
                    });
                    semestreSelect.disabled = false;
                    modulePlaceholder.textContent = 'Sélectionnez un semestre.';
                } else {
                    semestreSelect.innerHTML = '<option value="">-- Aucun Semestre --</option>';
                    modulePlaceholder.textContent = 'Aucun semestre défini pour cette spécialité.';
                }
            } else if (selectedSpecialtyId) {
                // Case where specialty is selected but no modules were fetched (error or empty)
                modulePlaceholder.textContent = allModules.length === 0 ? 'Chargement des modules ou aucun module trouvé pour cette spécialité.' : 'Sélectionnez un semestre.';
            } else {
                modulePlaceholder.textContent = 'Sélectionnez une spécialité.';
            }
            enableDisableControls();
        }


        // --- Reset UI State ---
        function resetCalculatorState() {
            noteForm.innerHTML = '';
            currentModulesData = [];
            resultatsDiv.classList.remove('visible');
            whatIfSection.classList.add('hidden');
            modulePlaceholder.classList.remove('hidden');
            guidanceSection.classList.add('hidden'); // Hide guidance
            guidanceSection.className = ''; // Reset guidance classes
            calculatedResults = {}; // Clear results cache
            // Reset overall average display
            moyenneGeneraleDiv.textContent = '--';
            validationStatusDiv.textContent = '';
            validationStatusDiv.className = 'mt-3 font-medium text-base'; // Reset classes
            creditsAttemptedSpan.innerHTML = '<i class="fas fa-cube"></i> Crédits Semestre: --'; // Reset with icon
            creditsValidatedSpan.innerHTML = '<i class="fas fa-check-circle"></i> Crédits Validés: --'; // Reset with icon
            progressBarFill.style.width = '0%';
            moyenneGeneraleContainer.classList.remove('validated', 'eliminated'); // Remove status classes
            // Reset pseudo-element background color
             moyenneGeneraleContainer.style.setProperty('--base-bg', 'transparent');
        }


        // --- Module Display & Card Creation ---
        function displayModules() {
            const selectedSpecialtyId = specialiteSelect.value;
            const selectedSemesterKey = semestreSelect.value;

            resetCalculatorState(); // Start fresh

            if (selectedSpecialtyId && selectedSemesterKey) {
                // Filter from the fetched allModules based on *both* specialty and semester
                currentModulesData = allModules.filter(m =>
                    m.specialtyId === selectedSpecialtyId &&
                    m.semesterKey === selectedSemesterKey
                );

                if (currentModulesData.length > 0) {
                    currentModulesData.forEach((module, index) => {
                        const card = createModuleCard(module, index);
                        noteForm.appendChild(card);
                    });
                    modulePlaceholder.classList.add('hidden');
                    whatIfSection.classList.remove('hidden');
                    loadGrades(); // Attempt to load grades for this selection
                    const firstInput = noteForm.querySelector('.module-grade-input');
                    if (firstInput) firstInput.focus();
                } else {
                    modulePlaceholder.textContent = 'Aucun module trouvé pour ce semestre et spécialité.';
                }
            } else {
                // These cases are handled by populateSemestreSelect now, but good fallback
                if (!selectedSpecialtyId) modulePlaceholder.textContent = 'Sélectionnez une spécialité.';
                else if (!selectedSemesterKey) modulePlaceholder.textContent = 'Sélectionnez un semestre.';
            }
            enableDisableControls();
        }

        function createModuleCard(moduleData, index) { // Renamed parameter to avoid conflict
            const card = document.createElement('div');
            card.className = 'module-card';
            card.setAttribute('data-aos', 'fade-up');
            card.setAttribute('data-aos-delay', index * 50);
            card.dataset.moduleId = moduleData.id;
            card.dataset.coefficient = moduleData.coefficient || 0;
            card.dataset.credits = moduleData.credits || 0;
            card.dataset.noteElim = moduleData.noteEliminatoire ?? '';

            const evaluations = Array.isArray(moduleData.evaluations) ? moduleData.evaluations : [];
            let inputsHTML = evaluations.map(type => {
                const inputId = `${moduleData.id}-${type.toLowerCase().replace(/\s+/g, '-')}`; // Sanitize type for ID
                return `
                    <div class="note-field">
                        <label for="${inputId}">${type}</label>
                        <input type="text" id="${inputId}" inputmode="decimal" class="custom-input module-grade-input" placeholder="--">
                    </div>
                `;
            }).join('');

            if (evaluations.length === 0) {
                inputsHTML = '<p class="text-xs text-muted-foreground col-span-full text-center">Aucun type d\'évaluation défini pour ce module.</p>';
            }

            const hasExam = evaluations.map(e => e.toLowerCase()).includes('examen');
            const minExamButtonHTML = hasExam ? `<button class="min-exam-btn" onclick="calculateMinExamGrade('${moduleData.id}')">Note Min. Examen</button>` : '';

            card.innerHTML = `
                <h3 class="text-base font-semibold mb-2 text-foreground">${moduleData.name || 'Module Sans Nom'}</h3>
                <div class="flex flex-wrap gap-2 mb-3 text-xs">
                    <span class="badge text-foreground bg-card/50 border border-border px-2 py-1 rounded-full">Coef: ${moduleData.coefficient || 'N/A'}</span>
                    <span class="badge text-foreground bg-card/50 border border-border px-2 py-1 rounded-full">Crédits: ${moduleData.credits || 'N/A'}</span>
                    ${moduleData.noteEliminatoire !== undefined && moduleData.noteEliminatoire !== '' ? `<span class="badge text-error bg-error/10 border border-error/20 px-2 py-1 rounded-full">Élim: ${moduleData.noteEliminatoire}</span>` : ''}
                </div>
                <div class="note-inputs">${inputsHTML}</div>
                <div class="module-footer">
                    <div class="avg-text" id="avg-${moduleData.id}">Moy: --</div>
                    <div class="flex gap-2 flex-wrap justify-end">
                        ${minExamButtonHTML}
                        <button class="clear-module-btn" onclick="clearModuleGrades('${moduleData.id}')">Effacer</button>
                    </div>
                </div>
            `;
            return card;
        }


        // --- Input Handling & Validation ---
        function validateGradeInput(inputElement) {
            let value = inputElement.value.trim();
            const card = inputElement.closest('.module-card');

            if (value === '') {
                inputElement.classList.remove('input-error');
                if (card) calculateModuleAverage(card);
                return;
            }

            value = value.replace(',', '.').replace(/[^0-9.]/g, '');
            const parts = value.split('.');
            if (parts.length > 2) value = parts[0] + '.' + parts.slice(1).join('');

            inputElement.value = value;

            const numericValue = parseFloat(value);
            const isInvalidFormat = value === '.' || (value.endsWith('.') && value.length > 1 && isNaN(parseFloat(value.slice(0, -1))));


            if (isInvalidFormat || isNaN(numericValue) || numericValue < 0 || numericValue > 20) {
                inputElement.classList.add('input-error');
                if (card) {
                    const avgDisplay = card.querySelector('.avg-text');
                    if (avgDisplay) avgDisplay.textContent = 'Moy: --';
                    avgDisplay.style.color = 'hsl(var(--muted-foreground))'; // Reset color
                }
            } else {
                inputElement.classList.remove('input-error');
                if (card) calculateModuleAverage(card);
            }
        }

        function parseGrade(value) {
            if (!value || typeof value !== 'string') return {
                num: null,
                valid: false
            };
            value = value.trim();
            if (value === '' || value === '.') return {
                num: null,
                valid: false
            };

            const cleaned = value.replace(',', '.');
            if (cleaned.endsWith('.') && cleaned.length > 1) return {
                num: null,
                valid: false
            };

            const num = parseFloat(cleaned);

            const isValid = !isNaN(num) && num >= 0 && num <= 20;
            return {
                num: isValid ? num : null,
                valid: isValid
            };
        }


        // --- Calculation Logic ---
        function calculateModuleAverage(moduleCardElement) {
            const moduleId = moduleCardElement.dataset.moduleId;
            const moduleData = currentModulesData.find(m => m.id === moduleId); // Get the module data object
            const avgDisplay = moduleCardElement.querySelector(`#avg-${moduleId}`);

            if (!moduleData || !avgDisplay) {
                if (avgDisplay) avgDisplay.textContent = 'Moy: Err';
                avgDisplay.style.color = 'hsl(var(--error))';
                return {
                    average: null,
                    isEliminated: false,
                    isValid: false,
                    grades: {}
                };
            }

            const evals = Array.isArray(moduleData.evaluations) ? moduleData.evaluations.map(type => type.toLowerCase().replace(/\s+/g, '-')) : [];
            const grades = {};
            let allInputsValidAndFilled = true;

            for (const type of evals) {
                const inputId = `${moduleData.id}-${type}`; // Use sanitized type
                const input = moduleCardElement.querySelector(`#${inputId}`);
                const gradeInfo = input ? parseGrade(input.value) : {
                    num: null,
                    valid: false
                };
                grades[type] = gradeInfo;
                if (!gradeInfo.valid) {
                    allInputsValidAndFilled = false;
                }
            }

            if (!allInputsValidAndFilled) {
                avgDisplay.textContent = 'Moy: --';
                avgDisplay.style.color = 'hsl(var(--muted-foreground))'; // Reset color
                return {
                    average: null,
                    isEliminated: false,
                    isValid: false,
                    grades
                };
            }

            let sum = 0,
                weightSum = 0;
            const elimNote = parseFloat(moduleData.noteEliminatoire); // Use moduleData for elim note

            // Determine weights based on defined evals (must match the logic in createModuleCard and WhatIf)
            let tdWeight = 0,
                tpWeight = 0,
                examWeight = 0;
            const hasTD = evals.includes('td');
            const hasTP = evals.includes('tp');
            const hasExam = evals.includes('examen');

            if (hasTD && hasTP && hasExam) { tdWeight = 0.2; tpWeight = 0.2; examWeight = 0.6; weightSum = 1.0; }
            else if (hasTD && hasExam) { tdWeight = 0.4; examWeight = 0.6; weightSum = 1.0; }
            else if (hasTP && hasExam) { tpWeight = 0.4; examWeight = 0.6; weightSum = 1.0; }
            else if (hasExam) { examWeight = 1.0; weightSum = 1.0; }
            else if (hasTD) { tdWeight = 1.0; weightSum = 1.0; }
            else if (hasTP) { tpWeight = 1.0; weightSum = 1.0; }
             // Add logic for other combinations if they exist in your data
             else { // No standard evaluation types found or combination not supported
                 console.warn(`Module ${moduleData.name} has evaluations ${evals.join(', ')} but no matching standard weight pattern. Average N/A.`);
                 avgDisplay.textContent = 'Moy: N/A';
                 avgDisplay.style.color = 'hsl(var(--muted-foreground))'; // Reset color
                 return { average: null, isEliminated: false, isValid: false, grades };
             }


            sum += (grades['td']?.num ?? 0) * tdWeight;
            sum += (grades['tp']?.num ?? 0) * tpWeight;
            sum += (grades['examen']?.num ?? 0) * examWeight;

            const average = weightSum > 0 ? sum / weightSum : null;

            let isEliminated = false;
            if (average !== null && !isNaN(elimNote) && average < elimNote) {
                isEliminated = true;
            }

            const avgText = average !== null ? average.toFixed(2) : '--';
            avgDisplay.textContent = `Moy: ${avgText}${isEliminated ? ' (Élim.)' : ''}`;
            avgDisplay.style.color = average !== null ?
                (average >= 10 && !isEliminated ? 'hsl(var(--success))' : 'hsl(var(--error))') :
                'hsl(var(--muted-foreground))'; // Reset color


            return {
                average,
                isEliminated,
                isValid: average !== null,
                grades
            };
        }

        function calculerMoyenneGenerale() {
            let totalWeightedSum = 0;
            let totalCoeff = 0;
            let totalCreditsAttempted = 0; // Sum of credits for all modules in the semester
            let totalCreditsValidatedModules = 0; // Credits from individual validated modules
            let hasEliminations = false;
            let allModulesHaveValidAverage = true;
            let moduleCalculationResults = {};

            const moduleCards = document.querySelectorAll('.module-card');
            if (moduleCards.length === 0) {
                alert("Aucun module affiché pour calculer la moyenne.");
                resetOverallResultsAndGuidance(); // Clear previous results if any
                return;
            }

            // First pass: Calculate and store results for each module
            moduleCards.forEach(card => {
                const moduleId = card.dataset.moduleId;
                const result = calculateModuleAverage(card);
                moduleCalculationResults[moduleId] = result;

                if (!result.isValid) {
                    allModulesHaveValidAverage = false;
                }

                // Sum up total credits attempted using the module data, regardless of validity
                const moduleData = currentModulesData.find(m => m.id === moduleId);
                if (moduleData) {
                     totalCreditsAttempted += parseFloat(moduleData.credits) || 0;
                }
            });

            // Update detailed results display first
            modulesResultsDiv.innerHTML = '';
            currentModulesData.forEach(module => {
                const result = moduleCalculationResults[module.id] || {
                    average: null,
                    isEliminated: false,
                    isValid: false
                };
                const moduleResultCard = document.createElement('div');
                moduleResultCard.className = 'module-result-card';
                const avgText = result.average !== null ? result.average.toFixed(2) : '--';
                const elimText = result.isEliminated ? `<span class="module-result-elim">(Élim.)</span>` : '';
                const color = result.isValid ?
                    (result.average >= 10 && !result.isEliminated ? 'hsl(var(--success))' : 'hsl(var(--error))') :
                    'hsl(var(--muted-foreground))'; // Use muted foreground color
                moduleResultCard.innerHTML = `
                    <div class="module-result-title">${module.name || 'Module Inconnu'}</div>
                    <div class="module-result-avg" style="color: ${color}">${avgText} ${elimText}</div>
                `;
                modulesResultsDiv.appendChild(moduleResultCard);
            });


            if (!allModulesHaveValidAverage) {
                alert("Veuillez entrer toutes les notes valides (0-20) pour chaque module avant de calculer la moyenne générale.");
                // Update UI to reflect error state
                moyenneGeneraleDiv.textContent = '--';
                validationStatusDiv.textContent = 'Notes manquantes/invalides';
                validationStatusDiv.className = 'mt-3 font-medium text-base eliminated-status'; // Use error color for clear failure
                creditsAttemptedSpan.innerHTML = `<i class="fas fa-cube"></i> Crédits Semestre: ${totalCreditsAttempted}`; // Still show total credits possible
                creditsValidatedSpan.innerHTML = '<i class="fas fa-check-circle"></i> Crédits Validés: --';
                progressBarFill.style.width = '0%';
                moyenneGeneraleContainer.classList.remove('validated', 'eliminated');
                resultatsDiv.classList.add('visible');
                guidanceSection.classList.add('hidden');
                // Clear calculated results to prevent guidance display on subsequent theme change
                 calculatedResults = {};
                return;
            }

            // Second pass: Calculate totals now that we know all modules are valid
            currentModulesData.forEach(module => {
                const result = moduleCalculationResults[module.id];
                const coeff = parseFloat(module.coefficient) || 0;
                const credits = parseFloat(module.credits) || 0; // Use module data for credits

                totalWeightedSum += result.average * coeff;
                totalCoeff += coeff;

                if (result.average >= 10 && !result.isEliminated) {
                    totalCreditsValidatedModules += credits; // Credits from modules >= 10 and not eliminated
                }
                if (result.isEliminated) {
                    hasEliminations = true;
                }
            });


            // Calculate and display final results
            const moyenneFinale = totalCoeff > 0 ? totalWeightedSum / totalCoeff : 0;
            moyenneGeneraleDiv.textContent = moyenneFinale.toFixed(2);

            const isValidatedByAverage = moyenneFinale >= 10;
            const isValidated = isValidatedByAverage && !hasEliminations;

            validationStatusDiv.className = 'mt-3 font-medium text-base';
            moyenneGeneraleContainer.classList.remove('validated', 'eliminated');

            let validationMessage = '';
            let totalCreditsValidatedFinal = 0;

            if (isValidated) {
                validationMessage = 'Semestre Validé';
                validationStatusDiv.classList.add('validated-status');
                moyenneGeneraleContainer.classList.add('validated');
                totalCreditsValidatedFinal = totalCreditsAttempted; // All credits if semester is validated
            } else if (hasEliminations) {
                 validationMessage = 'Non Validé (Élimination)';
                 validationStatusDiv.classList.add('eliminated-status');
                 moyenneGeneraleContainer.classList.add('eliminated');
                 totalCreditsValidatedFinal = totalCreditsValidatedModules; // Only credits from individually validated modules
            } else if (moyenneFinale < 10) {
                validationMessage = 'Non Validé';
                 if (moyenneFinale >= 9.5) {
                      validationStatusDiv.classList.add('not-validated-status'); // Warning color for close call
                 } else {
                       validationStatusDiv.classList.add('eliminated-status'); // Error color for clearly failed
                       moyenneGeneraleContainer.classList.add('eliminated'); // Apply eliminated class for red background
                 }
                totalCreditsValidatedFinal = totalCreditsValidatedModules; // Only credits from individually validated modules
            }


            validationStatusDiv.textContent = validationMessage;
            creditsAttemptedSpan.innerHTML = `<i class="fas fa-cube"></i> Crédits Semestre: ${totalCreditsAttempted}`;
            creditsValidatedSpan.innerHTML = `<i class="fas fa-check-circle"></i> Crédits Validés: ${totalCreditsValidatedFinal}`;

            const progress = Math.min(100, Math.max(0, (moyenneFinale / 20) * 100));
            progressBarFill.style.width = `${progress}%`;

            resultatsDiv.classList.add('visible');
            resultatsDiv.scrollIntoView({
                behavior: 'smooth',
                block: 'nearest'
            });

            // Store results for guidance
            calculatedResults = {
                 moyenneFinale,
                 isValidated,
                 hasEliminations,
                 totalCreditsAttempted,
                 totalCreditsValidatedFinal,
                 isValidatedByAverage, // Useful for guidance messages
                 validationStatusClass: validationStatusDiv.className // Store the class for re-applying color
            };

            displayGuidance(calculatedResults);
        }

        // --- Post-Calculation Guidance ---
        function displayGuidance(results) {
            guidanceSection.classList.remove('hidden', 'visible', 'validated-guidance', 'eliminated-guidance', 'warning-guidance');

            let title = "Conseils pour votre Semestre";
            let text = "";

            if (results.isValidated) {
                title = "Félicitations ! Semestre Validé ! 🎉";
                text = "Excellent travail ! Votre persévérance a porté ses fruits. Continuez sur cette lancée pour le semestre prochain. Chaque semestre réussi vous rapproche de votre objectif. Keep up the great work!";
                 guidanceSection.classList.add('validated-guidance');
            } else if (results.moyenneFinale >= 9.5 && results.moyenneFinale < 10 && !results.hasEliminations) {
                title = "Presque ! Le Semestre est à Portée ! 💪";
                text = `Votre moyenne de ${results.moyenneFinale.toFixed(2)} est très encourageante ! Vous êtes à la limite. Ne perdez pas espoir.`;
                if (results.totalCreditsValidatedFinal > 0) {
                     text += ` Vous avez déjà validé ${results.totalCreditsValidatedFinal} crédits sur ${results.totalCreditsAttempted}.`;
                }
                 text += ` Vous pouvez peut-être valider par compensation avec le Semestre 2, ou en ciblant les rattrapages pour améliorer certaines notes. Identifiez les modules où une petite augmentation ferait une grande différence.`;
                 guidanceSection.classList.add('warning-guidance');
            } else if (results.hasEliminations) {
                 title = "Attention : Modules Éliminés ❌";
                 text = `Votre moyenne actuelle est de ${results.moyenneFinale.toFixed(2)}. La présence de modules éliminés rend la validation directe impossible. Concentrez-vous sur les rattrapages des modules éliminés pour les valider individuellement.`;
                 if (results.totalCreditsValidatedFinal > 0) {
                     text += ` Vous avez validé ${results.totalCreditsValidatedFinal} crédits via les modules non éliminés.`;
                 }
                 text += ` Courage pour les rattrapages !`;
                 guidanceSection.classList.add('eliminated-guidance');
            }
             else if (results.moyenneFinale < 9.5) {
                 title = "Courage pour la Suite ! 🙏";
                 text = `Votre moyenne actuelle est de ${results.moyenneFinale.toFixed(2)}. Un semestre non validé n'est pas une fin en soi. Analysez les modules qui vous ont posé problème.`;
                 if (results.totalCreditsValidatedFinal > 0) {
                     text += ` Vous avez validé ${results.totalCreditsValidatedFinal} crédits sur ${results.totalCreditsAttempted}.`;
                 }
                 text += ` Préparez-vous pour les rattrapages ou concentrez-vous sur l'excellence au Semestre 2 pour viser la compensation. N'hésitez pas à demander de l'aide si nécessaire.`;
                 guidanceSection.classList.add('eliminated-guidance'); // Use error color for low average
            } else {
                 title = "Résultats du Semestre";
                 text = `Votre moyenne est de ${results.moyenneFinale.toFixed(2)}.`; // Default message
                 guidanceSection.classList.add('warning-guidance'); // Neutral color
            }

            // Add the contact info always
            text += `\n\nPour des analyses plus détaillées, des conseils personnalisés ou toute autre question, n'hésitez pas à contacter <a href="https://www.instagram.com/spot_campuselkseur/" target="_blank" rel="noopener noreferrer">@spot_campuselkseur</a> sur Instagram.`;


            guidanceTitle.textContent = title;
            guidanceText.innerHTML = text.replace(/\n/g, '<br>'); // Use innerHTML to parse the link
            // Re-trigger AOS animation by adding the visible class after a small delay
            setTimeout(() => {
                 guidanceSection.classList.add('visible');
            }, 50);

             // Re-apply validation status class based on stored value
             if (results.validationStatusClass) {
                 validationStatusDiv.className = results.validationStatusClass;
             }
        }


        // --- Storage Functions ---
        function getStorageKey() {
            const year = anneeSelect.value;
            const spec = specialiteSelect.value;
            const sem = semestreSelect.value;
            return year && spec && sem ? `@calculatorGrades_${year}_${spec}_${sem}` : null;
        }

        function saveGrades() {
            const key = getStorageKey();
            if (!key) {
                alert('Sélectionnez Année, Spécialité et Semestre pour sauvegarder.');
                return;
            }
            const gradesToSave = {};
            let hasAnyGrade = false;
            noteForm.querySelectorAll('.module-card').forEach(card => {
                 const moduleId = card.dataset.moduleId;
                 if (!moduleId) return;
                 const moduleGrades = {};
                 let hasModuleGrade = false;
                 card.querySelectorAll('.module-grade-input').forEach(input => {
                      const type = input.id.split('-').pop();
                      if (type) {
                           const value = input.value.trim();
                           moduleGrades[type] = value;
                           if (value !== '') hasModuleGrade = true;
                      }
                 });
                 if (hasModuleGrade) {
                      gradesToSave[moduleId] = moduleGrades;
                      hasAnyGrade = true;
                 }
            });

            // Allow saving empty state (e.g., clearing everything and saving)
             saveLoader.classList.remove('hidden');
             saveBtn.disabled = true;
             saveBtn.querySelector('.button-text').textContent = 'Sauvegarde...';

            try {
                localStorage.setItem(key, JSON.stringify(gradesToSave));
                setTimeout(() => {
                    saveBtn.querySelector('.button-text').textContent = 'Sauvegardé';
                    saveBtn.querySelector('i').className = 'fas fa-check';
                    setTimeout(() => {
                        saveBtn.querySelector('.button-text').textContent = 'Sauvegarder';
                        saveBtn.querySelector('i').className = 'fas fa-save';
                        enableDisableControls();
                    }, 1500);
                    saveLoader.classList.add('hidden');
                }, 300);
            } catch (e) {
                console.error("Erreur sauvegarde localStorage:", e);
                alert("Erreur lors de la sauvegarde.");
                saveLoader.classList.add('hidden');
                saveBtn.querySelector('.button-text').textContent = 'Sauvegarder'; // Reset text
                 saveBtn.querySelector('i').className = 'fas fa-save'; // Reset icon
                enableDisableControls();
            }
        }

        function loadGrades() {
            const key = getStorageKey();
            const wasClicked = event?.target && event.target.closest('#loadBtn');

            if (!key) {
                if (wasClicked) alert('Sélectionnez Année, Spécialité et Semestre pour charger.');
                return;
            }

            loadLoader.classList.remove('hidden');
            loadBtn.disabled = true;
            if (wasClicked) loadBtn.querySelector('.button-text').textContent = 'Chargement...';

            const savedGrades = localStorage.getItem(key);

            setTimeout(() => {
                let loadedSuccessfully = false;
                if (savedGrades) {
                    try {
                        const parsedGrades = JSON.parse(savedGrades);
                        noteForm.querySelectorAll('.module-card').forEach(card => {
                            const moduleId = card.dataset.moduleId;
                            if (!moduleId || !parsedGrades[moduleId]) {
                                // Clear inputs if no saved data for this module
                                card.querySelectorAll('.module-grade-input').forEach(input => {
                                    input.value = '';
                                    validateGradeInput(input);
                                });
                                return; // Skip to next module
                            }

                            card.querySelectorAll('.module-grade-input').forEach(input => {
                                const type = input.id.split('-').pop();
                                if (type && parsedGrades[moduleId][type] !== undefined) {
                                    input.value = parsedGrades[moduleId][type];
                                } else {
                                     input.value = ''; // Clear if no saved data for this specific input
                                }
                                validateGradeInput(input);
                            });
                        });
                        loadedSuccessfully = true;
                        if (wasClicked) {
                            loadBtn.querySelector('.button-text').textContent = 'Chargé';
                            loadBtn.querySelector('i').className = 'fas fa-check';
                            setTimeout(() => {
                                loadBtn.querySelector('.button-text').textContent = 'Charger';
                                loadBtn.querySelector('i').className = 'fas fa-download';
                                enableDisableControls();
                            }, 1500);
                        }
                    } catch (e) {
                        console.error("Erreur analyse localStorage:", e);
                        if (wasClicked) alert("Erreur lors du chargement des notes sauvegardées.");
                        // If error, still clear potentially bad inputs
                        noteForm.querySelectorAll('.module-grade-input').forEach(input => {
                            input.value = '';
                            validateGradeInput(input);
                        });
                    }
                } else {
                    if (wasClicked) alert('Aucune note sauvegardée pour cette sélection.');
                    // Clear inputs if nothing was saved for this specific selection
                    noteForm.querySelectorAll('.module-grade-input').forEach(input => {
                        input.value = '';
                        validateGradeInput(input);
                    });
                }
                loadLoader.classList.add('hidden');
                if (!wasClicked || !loadedSuccessfully) {
                    enableDisableControls();
                }
                 // Clear results/guidance after loading, as grades might have changed
                 resetOverallResultsAndGuidance();
            }, 300);
        }


        function clearGrades() {
            openModal('clearConfirmModal');
        }

        function confirmClearGrades() {
            noteForm.querySelectorAll('.module-grade-input').forEach(input => {
                input.value = '';
                input.classList.remove('input-error');
                const card = input.closest('.module-card');
                if (card) calculateModuleAverage(card);
            });
            resetOverallResultsAndGuidance(); // Also clear results and guidance

            const key = getStorageKey();
            if (key) {
                localStorage.removeItem(key);
                console.log("Cleared saved grades for key:", key);
            }

            clearBtn.querySelector('.button-text').textContent = 'Effacé';
            clearBtn.querySelector('i').className = 'fas fa-check';
            setTimeout(() => {
                clearBtn.querySelector('.button-text').textContent = 'Effacer';
                clearBtn.querySelector('i').className = 'fas fa-trash-alt';
            }, 1500);

            closeModal('clearConfirmModal');
        }

        function clearModuleGrades(moduleId) {
            const card = noteForm.querySelector(`.module-card[data-module-id="${moduleId}"]`);
            if (card) {
                card.querySelectorAll('.module-grade-input').forEach(input => {
                    input.value = '';
                    input.classList.remove('input-error');
                });
                // Temporarily change color for feedback, then recalculate
                const avgDisplay = card.querySelector('.avg-text');
                if (avgDisplay) {
                     avgDisplay.style.transition = 'color 0.3s ease';
                     avgDisplay.style.color = 'hsl(var(--warning))'; // Use warning color for feedback
                     setTimeout(() => { calculateModuleAverage(card); }, 500); // Recalculate to set final color
                }
                 // After clearing a module, also clear the overall results/guidance
                 resetOverallResultsAndGuidance();
            }
        }

        function resetOverallResultsAndGuidance() {
            resultatsDiv.classList.remove('visible');
            guidanceSection.classList.add('hidden');
            guidanceSection.className = ''; // Reset guidance classes
            moyenneGeneraleDiv.textContent = '--';
            validationStatusDiv.textContent = '';
            validationStatusDiv.className = 'mt-3 font-medium text-base';
            creditsAttemptedSpan.innerHTML = '<i class="fas fa-cube"></i> Crédits Semestre: --';
            creditsValidatedSpan.innerHTML = '<i class="fas fa-check-circle"></i> Crédits Validés: --';
            progressBarFill.style.width = '0%';
            moyenneGeneraleContainer.classList.remove('validated', 'eliminated');
            // Reset pseudo-element background color explicitly
             moyenneGeneraleContainer.style.setProperty('--base-bg', 'transparent');
             calculatedResults = {}; // Clear results cache
        }


        // --- "What If" Calculation ---
        function calculateWhatIf() {
            const targetAvgInput = document.getElementById('targetAverage');
            let targetAvg;
            try {
                targetAvg = parseFloat(targetAvgInput.value.replace(',', '.'));
                if (isNaN(targetAvg) || targetAvg < 0 || targetAvg > 20) throw new Error("Invalid range");
                targetAvgInput.classList.remove('input-error');
            } catch (e) {
                targetAvgInput.classList.add('input-error');
                alert('Moyenne cible invalide (entrez une valeur entre 0 et 20).');
                return;
            }

            let weightedSumOfFixedParts = 0; // Sum of weighted averages for modules *excluding* the exam part
            let totalCoeff = 0;
            let examWeightCoeffSum = 0; // Sum of (exam weight * coefficient) for modules needing exam fill
            const modulesToFillExam = [];
            let hasMissingOrInvalidNonExamInputs = false; // Flag if any TD/TP input is bad

            currentModulesData.forEach(moduleData => { // Iterate through module data
                const card = noteForm.querySelector(`.module-card[data-module-id="${moduleData.id}"]`);
                if (!card) {
                    console.warn(`Card not found for module ${moduleData.id}`);
                    hasMissingOrInvalidNonExamInputs = true; // Treat as error if card is missing
                    return;
                }

                const evals = Array.isArray(moduleData.evaluations) ? moduleData.evaluations.map(type => type.toLowerCase().replace(/\s+/g, '-')) : [];
                const coeff = parseFloat(moduleData.coefficient) || 0;
                totalCoeff += coeff; // Sum up total coefficient

                const tdInput = card.querySelector(`#${moduleData.id}-td`);
                const tpInput = card.querySelector(`#${moduleData.id}-tp`);
                const examInput = card.querySelector(`#${moduleData.id}-examen`);

                const tdInfo = tdInput ? parseGrade(tdInput.value) : { num: null, valid: true }; // Assume valid if input element doesn't exist
                const tpInfo = tpInput ? parseGrade(tpInput.value) : { num: null, valid: true };
                const examInfo = examInput ? parseGrade(examInput.value) : { num: null, valid: true }; // Assume valid if input element doesn't exist

                const hasTD = evals.includes('td');
                const hasTP = evals.includes('tp');
                const hasExam = evals.includes('examen');

                 // Check if mandatory non-exam inputs for *this* module are missing/invalid
                 if ((hasTD && !tdInfo.valid) || (hasTP && !tpInfo.valid)) {
                     hasMissingOrInvalidNonExamInputs = true;
                     return; // Cannot calculate this module's non-exam part, skip it
                 }

                let currentModuleSumWithoutExam = 0;
                let moduleExamWeight = 0;
                let moduleWeightSum = 0; // Total weight for this module

                 // Determine weights and current sum based on common structures
                 if (hasTD && hasTP && hasExam) { currentModuleSumWithoutExam = (tdInfo.num ?? 0) * 0.2 + (tpInfo.num ?? 0) * 0.2; moduleExamWeight = 0.6; moduleWeightSum = 1.0; }
                 else if (hasTD && hasExam) { currentModuleSumWithoutExam = (tdInfo.num ?? 0) * 0.4; moduleExamWeight = 0.6; moduleWeightSum = 1.0; }
                 else if (hasTP && hasExam) { currentModuleSumWithoutExam = (tpInfo.num ?? 0) * 0.4; moduleExamWeight = 0.6; moduleWeightSum = 1.0; }
                 else if (hasExam) { moduleExamWeight = 1.0; moduleWeightSum = 1.0; }
                 else if (hasTD) { currentModuleSumWithoutExam = (tdInfo.num ?? 0) * 1.0; moduleWeightSum = 1.0; } // Only TD? Assume 100% TD
                 else if (hasTP) { currentModuleSumWithoutExam = (tpInfo.num ?? 0) * 1.0; moduleWeightSum = 1.0; } // Only TP? Assume 100% TP
                 else { // Module has no standard structure for averaging, or no evals
                      console.warn(`Module ${moduleData.name} cannot be used in What-If calculation due to unconventional evaluation structure or missing data.`);
                      // If the module has valid grades and can calculate its own average, add it as a fixed contribution
                     const moduleAvgResult = calculateModuleAverage(card); // Recalculate to check validity
                     if(moduleAvgResult.isValid) {
                          weightedSumOfFixedParts += moduleAvgResult.average * coeff;
                     } else {
                          // If a non-exam module also has invalid grades, flag it
                          hasMissingOrInvalidNonExamInputs = true;
                     }
                     return; // Skip this module for the exam calculation part
                 }

                // Add the fixed part of this module's average to the total weighted sum
                 // Only add if the non-exam inputs were valid (checked above)
                 if (!hasMissingOrInvalidNonExamInputs) {
                     weightedSumOfFixedParts += currentModuleSumWithoutExam * coeff;
                 }


                if (hasExam && examInput && examInfo.num === null) {
                    // This is a module where we need to fill the exam grade
                    modulesToFillExam.push({ examInput, moduleExamWeight, coeff });
                    examWeightCoeffSum += moduleExamWeight * coeff;
                } else if (hasExam && examInput && examInfo.num !== null) {
                     // This module has an exam and it's already filled with a valid grade
                     weightedSumOfFixedParts += examInfo.num * moduleExamWeight * coeff; // Add its full contribution
                } else if (hasExam && !examInput) {
                     // Module has 'Examen' defined but no input element found - critical error or data mismatch
                     console.error(`Exam input element not found for module ${moduleData.name} (${moduleId}). Cannot perform What-If.`);
                     hasMissingOrInvalidNonExamInputs = true; // Treat as uncalculable
                     return;
                }
                 // If hasExam is false, the module's contribution is already fully added as fixed (or flagged as invalid)
            }); // End moduleData.forEach

            if (hasMissingOrInvalidNonExamInputs) {
                 alert('Veuillez entrer toutes les notes valides pour TD et TP (dans tous les modules concernés) avant d\'utiliser le calcul "Et Si?". Certains modules ont des notes manquantes ou invalides.');
                 return;
            }

            if (totalCoeff === 0) {
                alert('Aucun module chargé.');
                return;
            }

            if (examWeightCoeffSum <= 0) {
                 const currentOverallAvg = totalCoeff > 0 ? (weightedSumOfFixedParts / totalCoeff) : 0;
                 if (Math.abs(targetAvg - currentOverallAvg) < 0.001) {
                      alert(`Votre moyenne actuelle est de ${currentOverallAvg.toFixed(2)}. Vous avez déjà atteint la moyenne cible de ${targetAvg.toFixed(2)}.`);
                 } else {
                      alert(`Impossible d'atteindre ${targetAvg.toFixed(2)}. Aucun examen à remplir pour ajuster la moyenne.`);
                 }
                 return;
            }


            // The total weighted sum needed across all modules is targetAvg * totalCoeff.
            // This must equal the sum of weighted fixed parts + the weighted contribution from exams to fill.
            // targetAvg * totalCoeff = weightedSumOfFixedParts + (Needed Exam Avg * examWeightCoeffSum)
            // (Needed Exam Avg * examWeightCoeffSum) = (targetAvg * totalCoeff) - weightedSumOfFixedParts
            // Needed Exam Avg = ((targetAvg * totalCoeff) - weightedSumOfFixedParts) / examWeightCoeffSum

            const neededExamWeightedSumContribution = (targetAvg * totalCoeff) - weightedSumOfFixedParts;

            const neededExamAvg = neededExamWeightedSumContribution / examWeightCoeffSum;


            let message = '';
            if (neededExamAvg < 0) {
                // Calculate the actual average if all exams were 0
                 const avgWithZeroExam = totalCoeff > 0 ? weightedSumOfFixedParts / totalCoeff : 0; // Re-calculate using overall sums
                 if (avgWithZeroExam >= targetAvg) {
                     message = `Moyenne cible de ${targetAvg.toFixed(2)} déjà atteinte ou dépassée (moyenne avec 0 aux examens: ${avgWithZeroExam.toFixed(2)}) ! Il faudrait une note de <strong>${neededExamAvg.toFixed(2)}/20</strong> aux examens restants.`;
                 } else {
                      // This case indicates the target average is simply too low for a positive exam score
                      message = `Impossible d'atteindre ${targetAvg.toFixed(2)}. Il faudrait une note de <strong>${neededExamAvg.toFixed(2)}/20</strong> aux examens restants.`;
                 }

            } else if (neededExamAvg <= 20) {
                message = `Pour atteindre ${targetAvg.toFixed(2)}, il vous faut en moyenne <strong>${neededExamAvg.toFixed(2)}/20</strong> aux examens restants.`;
            } else {
                message = `Impossible d'atteindre ${targetAvg.toFixed(2)}. Il faudrait <strong>${neededExamAvg.toFixed(2)}/20</strong> à l'examen.`;
            }

            document.getElementById('minExamMessage').innerHTML = `<strong>Calcul "Et Si ?"</strong><br>${message}`;
            openModal('minExamModal');


            if (neededExamAvg >= 0 && neededExamAvg <= 20) {
                 // Fill the inputs only if the required average is within the valid range [0, 20]
                 modulesToFillExam.forEach(({ examInput }) => {
                     examInput.value = neededExamAvg.toFixed(2);
                     validateGradeInput(examInput); // This will update the module average display
                 });
                 // Optionally recalculate overall average after filling inputs
                  calculerMoyenneGenerale();
             }
        }


        // --- Min Exam Grade Calculation ---
        function calculateMinExamGrade(moduleId) {
            const card = noteForm.querySelector(`.module-card[data-module-id="${moduleId}"]`);
            const moduleData = currentModulesData.find(m => m.id === moduleId);

            if (!card || !moduleData) {
                alert("Module non trouvé.");
                return;
            }
            const evals = Array.isArray(moduleData.evaluations) ? moduleData.evaluations.map(type => type.toLowerCase().replace(/\s+/g, '-')) : [];
            if (!evals.includes('examen')) {
                alert('Pas d\'examen défini pour ce module.');
                return;
            }

            const tdInput = card.querySelector(`#${moduleId}-td`);
            const tpInput = card.querySelector(`#${moduleId}-tp`);

             const tdInfo = tdInput ? parseGrade(tdInput.value) : { num: null, valid: true };
             const tpInfo = tpInput ? parseGrade(tpInput.value) : { num: null, valid: true };

             let missingPrerequisites = [];
             if (evals.includes('td') && !tdInfo.valid) missingPrerequisites.push('TD');
             if (evals.includes('tp') && !tpInfo.valid) missingPrerequisites.push('TP');

             if (missingPrerequisites.length > 0) { alert(`Entrez une note valide pour ${missingPrerequisites.join(' et ')} avant de calculer la note minimale d'examen.`); return; }


            let tdWeight = 0,
                tpWeight = 0,
                examWeight = 0;
            let moduleWeightSum = 0;
            // Weights must match the calculateModuleAverage function
            if (evals.includes('td') && evals.includes('tp') && evals.includes('examen')) { tdWeight = 0.2; tpWeight = 0.2; examWeight = 0.6; moduleWeightSum = 1.0; }
            else if (evals.includes('td') && evals.includes('examen')) { tdWeight = 0.4; examWeight = 0.6; moduleWeightSum = 1.0; }
            else if (evals.includes('tp') && evals.includes('examen')) { tpWeight = 0.4; examWeight = 0.6; moduleWeightSum = 1.0; }
            else if (evals.includes('examen')) { examWeight = 1.0; moduleWeightSum = 1.0; }
            // If exam exists but weight is 0 (or moduleWeightSum is 0 unexpectedly), it's an error
            if (examWeight <= 0 || moduleWeightSum <= 0) {
                 console.error(`Exam exists but weight is zero or total weight is zero for module ${moduleData.name}.`);
                 alert("Erreur: Structure d'évaluation invalide pour ce module.");
                 return;
            }


            const currentSumWithoutExam = (tdInfo.num ?? 0) * tdWeight + (tpInfo.num ?? 0) * tpWeight;
            const elimNote = parseFloat(moduleData.noteEliminatoire);
            // Target is the minimum required average for the module, which is max(10, elimination note if defined).
            const targetAverage = Math.max(10, isNaN(elimNote) ? 0 : elimNote);


            // Target Average = (currentSumWithoutExam + neededExamGrade * examWeight) / moduleWeightSum
            // Target Average * moduleWeightSum = currentSumWithoutExam + neededExamGrade * examWeight
            // neededExamGrade * examWeight = (Target Average * moduleWeightSum) - currentSumWithoutExam
            // neededExamGrade = ((Target Average * moduleWeightSum) - currentSumWithoutExam) / examWeight

            const neededExamGrade = ((targetAverage * moduleWeightSum) - currentSumWithoutExam) / examWeight;


            let message = '';
            if (neededExamGrade < 0) {
                // Calculate the actual average with 0 on exam to see if it's already validated
                 const avgWithZeroExam = (currentSumWithoutExam + 0 * examWeight) / moduleWeightSum;
                 if (avgWithZeroExam >= targetAverage) {
                     message = `Module déjà validé (ou validable avec 0 à l'examen). Note nécessaire: <strong>${neededExamGrade.toFixed(2)}/20</strong>.`;
                 } else {
                      // This case shouldn't typically happen if targetAverage is >= 10 or elim note
                      message = `Calculé note nécessaire négative (${neededExamGrade.toFixed(2)}). Erreur possible dans les poids ou la note éliminatoire.`;
                 }

            } else if (neededExamGrade <= 20) {
                message = `Il vous faut au moins <strong>${neededExamGrade.toFixed(2)}/20</strong> à l'examen pour valider ce module (atteindre ${targetAverage}/20).`;
            } else {
                message = `Validation impossible pour ce module. Il faudrait <strong>${neededExamGrade.toFixed(2)}/20</strong> à l'examen.`;
            }

            document.getElementById('minExamMessage').innerHTML = `<strong>${moduleData.name}</strong><br>${message}`;
            openModal('minExamModal');
        }


        // --- Enable/Disable Controls ---
        function enableDisableControls() {
            const yearSelected = !!anneeSelect.value;
            const specialtySelected = !!specialiteSelect.value;
            const semesterSelected = !!semestreSelect.value;
            const modulesReady = currentModulesData.length > 0; // Checks if modules are loaded AND filtered for the semester

            const enableActions = yearSelected && specialtySelected && semesterSelected && modulesReady;

            calculateBtn.disabled = !enableActions;
            saveBtn.disabled = !enableActions;
            loadBtn.disabled = !enableActions;
            clearBtn.disabled = !enableActions;
            targetAverageInput.disabled = !enableActions;
            const whatIfButton = document.querySelector('#what-if-section .what-if-btn');
            if (whatIfButton) {
                whatIfButton.disabled = !enableActions;
            }

            // Manage dropdown disabled states
            specialiteSelect.disabled = !yearSelected || specialties.filter(s => s.yearId === anneeSelect.value).length === 0;
            semestreSelect.disabled = !specialtySelected || allModules.filter(m => m.specialtyId === specialiteSelect.value).length === 0;


            // Manage placeholder text visibility and content
            if (!yearSelected) {
                 modulePlaceholder.textContent = 'Sélectionnez une année.';
                 modulePlaceholder.classList.remove('hidden');
             } else if (!specialtySelected) {
                 modulePlaceholder.textContent = 'Sélectionnez une spécialité.';
                  modulePlaceholder.classList.remove('hidden');
             } else if (!semesterSelected) {
                 modulePlaceholder.textContent = 'Sélectionnez un semestre.';
                  modulePlaceholder.classList.remove('hidden');
             } else if (modulesReady) {
                 modulePlaceholder.classList.add('hidden'); // Hide if modules are displayed
             } else {
                 // This case means year, spec, semester selected, but no modules were found after filtering
                 modulePlaceholder.textContent = 'Aucun module trouvé pour cette sélection.';
                 modulePlaceholder.classList.remove('hidden');
             }
        }


        // --- Event Listeners Setup ---
        anneeSelect.addEventListener('change', () => {
            specialiteSelect.value = '';
            semestreSelect.value = '';
            allModules = [];
            populateSpecialiteSelect();
        });
        specialiteSelect.addEventListener('change', () => {
            semestreSelect.value = '';
            allModules = [];
            // Only fetch modules if a specialty is selected
             if(specialiteSelect.value) {
                fetchModules();
             } else {
                 populateSemestreSelect(); // Update semester dropdown to empty/disabled state
                 enableDisableControls(); // Update buttons/placeholder
             }
        });
        semestreSelect.addEventListener('change', displayModules);


        // --- Theme Toggle Function (Copied from index.html) ---
        function toggleTheme() {
            const body = document.body;
            const themeToggleIcon = document.querySelector('.theme-toggle i');

            if (body.classList.contains('dark')) {
                body.classList.remove('dark');
                themeToggleIcon.classList.remove('fa-sun');
                themeToggleIcon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark');
                themeToggleIcon.classList.remove('fa-moon');
                themeToggleIcon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            }
            // Recalculate module averages after theme change to update text colors
            document.querySelectorAll('.module-card').forEach(card => calculateModuleAverage(card));
            // Update validation status text color
            if (calculatedResults && calculatedResults.moyenneFinale !== undefined) {
                displayGuidance(calculatedResults); // Re-display guidance to update colors
            }

        }

        // --- Particle Creation Function (Copied from index.html) ---
         function createParticles() {
             const particlesContainer = document.getElementById('particles');
             // Use HSL colors based on theme variables for particles
             const lightColors = ['hsl(var(--primary))', 'hsl(var(--ring))', 'hsl(var(--accent))', 'hsl(var(--success))', 'hsl(var(--warning))'];
             const darkColors = ['hsl(var(--primary))', 'hsl(var(--ring))', 'hsl(var(--accent))', 'hsl(var(--success))', 'hsl(var(--warning))'];

             // Function to get colors based on current theme
             function getThemeColors() {
                 return document.body.classList.contains('dark') ? darkColors : lightColors;
             }

             // Clear existing particles before adding new ones (optional, but good if theme could change)
             particlesContainer.innerHTML = '';

             const colors = getThemeColors();

             for (let i = 0; i < 30; i++) {
                 const particle = document.createElement('div');
                 particle.className = 'particle';

                 // Random position
                 const x = Math.random() * 100;
                 const y = Math.random() * 100;

                 // Random size
                 const size = Math.random() * 5 + 2;

                 // Random color
                 const color = colors[Math.floor(Math.random() * colors.length)];

                 // Random movement
                 const moveX = (Math.random() - 0.5) * 50;
                 const moveY = (Math.random() - 0.5) * 50;

                 // Set styles
                 particle.style.cssText = `
                     left: ${x}%;
                     top: ${y}%;
                     width: ${size}px;
                     height: ${size}px;
                     background-color: ${color};
                     --x: ${moveX}px;
                     --y: ${moveY}px;
                     animation-delay: ${Math.random() * 5}s;
                     /* Add animation duration variation */
                     animation-duration: ${10 + Math.random() * 10}s;
                     /* Add different animation names for variety */
                     animation-name: float, pulse${Math.floor(Math.random() * 3)}; /* Use pulse variations */
                 `;

                 particlesContainer.appendChild(particle);
             }
              // Add pulse variations if not already defined (can be added in CSS too)
              // This part can be removed if the pulse keyframes are added directly in the CSS style block
              /*
               const styleSheet = document.styleSheets[0];
               const pulseKeyframes = `@keyframes pulse { 0%, 100% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } }`;
               const pulse1Keyframes = `@keyframes pulse1 { 0%, 100% { opacity: 0.4; transform: scale(0.8); } 50% { opacity: 0.9; transform: scale(1.1); } }`;
               const pulse2Keyframes = `@keyframes pulse2 { 0%, 100% { opacity: 0.6; transform: scale(1.1); } 50% { opacity: 0.7; transform: scale(0.9); } }`;

               if (![...styleSheet.cssRules].some(rule => rule.name === 'pulse')) styleSheet.insertRule(pulseKeyframes, styleSheet.cssRules.length);
                if (![...styleSheet.cssRules].some(rule => rule.name === 'pulse1')) styleSheet.insertRule(pulse1Keyframes, styleSheet.cssRules.length);
               if (![...styleSheet.cssRules].some(rule => rule.name === 'pulse2')) styleSheet.insertRule(pulse2Keyframes, styleSheet.cssRules.length);
              */
         }


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            enableDisableControls();
            fetchInitialData();

            // --- Apply saved theme on load (Copied from index.html) ---
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                 document.body.classList.add('dark');
                 const themeToggleIcon = document.querySelector('.theme-toggle i');
                 if (themeToggleIcon) themeToggleIcon.classList.replace('fa-moon', 'fa-sun');
            }

             // --- Initialize particles after theme is set ---
             createParticles();
        });

         // Optional: Re-create particles on theme change for instant color update
          document.querySelector('.theme-toggle').addEventListener('click', () => {
             // Small delay to allow theme class to apply before creating particles
             setTimeout(createParticles, 100);
          });
    </script>
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
</body>

</html>