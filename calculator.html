<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcul de Moyenne - Université de Bejaia</title> <!-- Slightly improved title -->
    <meta name="description" content="Calculateur de moyenne simple et efficace pour les étudiants de l'Université de Bejaia."> <!-- Improved description -->
    <meta name="author" content="Amara Mehdi">
    <meta name="keywords" content="Université de Bejaia, Moyenne, Calcul, Notes, Étudiant, E-Campus"> <!-- Added keywords -->
    <meta name="robots" content="index, follow">
    <link rel="icon" type="image/png" href="assets/img/icon.png"> <!-- Make sure this path is correct -->
    <meta property="og:url" content="https://amaramehdi.github.io/moyenne-universite-bejaia/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Calcul de Moyenne Université de Bejaia">
    <meta property="og:description" content="Calculateur de moyenne simple et efficace pour les étudiants de l'Université de Bejaia.">
    <meta property="og:image"
        content="https://masterpiecer-images.s3.yandex.net/b08e69b27e0b11eeb532aaafe6635749:upscaled"> <!-- Consider a custom OG image -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" /> <!-- Updated Font Awesome -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"> <!-- Added 800 weight -->
    <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css">
    <!-- Leaflet CSS removed as it wasn't used -->
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico"> <!-- Make sure this path is correct -->
    <!-- <link rel="stylesheet" href="assets/css/floating-menu.css"> --> <!-- Assuming this is not needed -->

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7539806376887582"
        crossorigin="anonymous"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4QK3R858YJ"></script>

    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-4QK3R858YJ');
    </script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        // --- IMPORTANT: REPLACE WITH YOUR ACTUAL FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyB5XYqWKhHdiVDXJx4iOwtpxD8eUCPRfKU",
            authDomain: "universite-de-bejaia-547fc.firebaseapp.com",
            projectId: "universite-de-bejaia-547fc",
            storageBucket: "universite-de-bejaia-547fc.firebasestorage.app",
            messagingSenderId: "517622731583",
            appId: "1:517622731583:web:25453d5e01226585bf798a",
            measurementId: "G-SQ0WWSCS7B"
        };
        // ---------------------------------------------------------

        try {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.firestoreFunctions = { collection, getDocs, query, where, orderBy };
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            const placeholder = document.getElementById('module-placeholder');
            if (placeholder) {
                placeholder.textContent = 'Erreur d\'initialisation de la base de données. Vérifiez la console.';
            }
        }
    </script>

    <style>
        /* General reset and theme */
        :root {
            --primary-color: #007bff;
            --secondary-color: #0056b3;
            --accent-color: #00e6e6; /* Aqua accent */
            --bg-gradient-start: #0f0c29;
            --bg-gradient-mid: #302b63;
            --bg-gradient-end: #24243e;
            --text-light: #eee;
            --text-dark: #fff;
            --card-bg: rgba(255, 255, 255, 0.07); /* Slightly more opaque card */
            --card-border: rgba(255, 255, 255, 0.15);
            --input-bg: rgba(255, 255, 255, 0.1);
            --input-border: rgba(255, 255, 255, 0.2);
            --error-color: #e63946;
            --error-bg: rgba(230, 57, 70, 0.1);
            --success-color: var(--accent-color);
            --warning-color: #ffcc00;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --shadow-color-light: rgba(0, 0, 0, 0.2);
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            color: var(--text-dark);
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-mid), var(--bg-gradient-end));
            display: flex;
            flex-direction: column;
        }

        .container {
            width: 90%;
            max-width: 1100px; /* Slightly narrower max-width */
            margin: 0 auto;
            padding: 20px;
            flex-grow: 1; /* Allow container to grow */
        }

        /* Improved Header */
        .main-header {
            padding: 1rem 0; /* Vertical padding */
            margin-bottom: 1.5rem; /* Space below header */
            position: relative; /* For back button positioning */
        }

        .header-content {
            display: flex;
            justify-content: center; /* Center logo */
            align-items: center;
            position: relative; /* Keep context for back button */
        }

         .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent-color); /* Use accent color */
            font-weight: 500;
            font-size: 0.9rem;
            padding: 0.6rem 1.2rem; /* Slightly larger padding */
            border-radius: 9999px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
            position: absolute;
            top: 50%; /* Vertically center relative to header content */
            left: 0; /* Position to the far left */
            transform: translateY(-50%); /* Precise vertical centering */
            z-index: 10;
        }
        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.15);
            color: var(--text-dark);
            transform: translateY(-50%) scale(1.05); /* Keep vertical centering */
            box-shadow: 0 2px 10px var(--shadow-color-light);
            text-decoration: none;
        }
        .back-button i { font-size: 1rem; }

        .logo-container img {
             max-width: 220px; /* Adjusted logo size */
             height: auto;
        }

        /* Title Banner */
        .title-banner {
             background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
             color: var(--text-dark);
             padding: 1.8rem;
             border-radius: 1rem;
             box-shadow: 0 8px 20px rgba(0, 86, 179, 0.25);
             text-align: center;
             margin-bottom: 2.5rem;
        }
        .title-banner h1 {
             font-size: 2rem; /* Adjusted size */
             font-weight: 700;
             margin-bottom: 0.5rem;
             text-shadow: 1px 1px 3px var(--shadow-color-light);
        }
        .title-banner p {
            font-size: 0.95rem; /* Adjusted size */
            opacity: 0.9;
        }


        /* Main Card Styling */
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px); /* Slightly more blur */
            border-radius: 1.2rem; /* Slightly larger radius */
            padding: clamp(1.5rem, 5vw, 2.5rem); /* Responsive padding */
            box-shadow: 0 8px 32px 0 var(--shadow-color-light);
            border: 1px solid var(--card-border);
            margin-bottom: 2.5rem;
        }

        /* Selection Inputs Area */
        .selection-area {
            padding-bottom: 1.5rem; /* Only padding bottom */
            border-bottom: 1px solid var(--card-border);
            margin-bottom: 2rem;
        }

        .selection-inputs {
            display: flex;
            flex-direction: column;
            gap: 1rem; /* Adjusted gap */
        }

        .form-group { margin-bottom: 0; }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-light);
            font-size: 0.9rem; /* Slightly smaller label */
        }

        select,
        input[type="text"], /* Apply to text inputs as well */
        input[type="number"] {
            width: 100%;
            padding: 0.8rem 1rem; /* Adjust padding */
            border-radius: 0.6rem; /* Slightly smaller radius */
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text-dark);
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 230, 230, 0.3);
        }

        .selection-input {
             padding: 12px 15px;
             border-radius: 10px;
             box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
             appearance: none;
             -webkit-appearance: none;
             -moz-appearance: none;
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23fff' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
             background-repeat: no-repeat;
             background-position: right 1rem center;
             background-size: 1.2rem;
             touch-action: manipulation;
             cursor: pointer; /* Indicate it's clickable */
        }
        .selection-input:disabled {
             opacity: 0.5;
             cursor: not-allowed;
        }
        .selection-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(0, 230, 230, 0.25);
        }
        select option {
            background-color: #1e293b;
            color: var(--text-dark);
        }


        /* Module card styles */
        .module-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            box-shadow: 0 4px 15px var(--shadow-color-light);
            border-left: 5px solid var(--primary-color);
            transition: all 0.3s ease-out;
        }
        .module-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 25px var(--shadow-color);
            border-left-color: var(--accent-color);
        }

        /* Note inputs grid */
        .note-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(85px, 1fr));
            gap: 1rem;
            margin: 0.75rem 0;
        }

        .note-field label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #b0b0d0;
            margin-bottom: 0.3rem;
        }

        .custom-input {
            text-align: center;
            font-weight: 500;
        }
        .custom-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 230, 230, 0.3);
        }

        .input-error {
            border-color: var(--error-color) !important;
            background-color: var(--error-bg);
        }

        .module-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--card-border);
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        .avg-text { font-weight: 700; font-size: 1rem; }
        .elim-text { font-size: 0.8rem; font-style: italic; margin-left: 0.3rem; color: var(--error-color); }

        .min-exam-btn,
        .clear-module-btn {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: var(--text-dark);
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .clear-module-btn { background: linear-gradient(to right, var(--error-color), #b71c1c); }
        .min-exam-btn:hover,
        .clear-module-btn:hover {
            transform: translateY(-2px);
            filter: brightness(1.15);
        }

        /* Detailed results section */
        #resultats {
            transition: max-height 0.7s ease-out, opacity 0.5s ease-out; /* Smoother transitions */
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            margin-top: 2.5rem;
        }
        #resultats.visible { max-height: 2000px; opacity: 1; }

        .module-result-card {
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .module-result-card:hover {
            transform: scale(1.03);
             box-shadow: 0 4px 15px var(--shadow-color-light);
        }
        .module-result-title { font-weight: 600; color: var(--text-light); margin-bottom: 0.3rem; }
        .module-result-avg { font-weight: 700; font-size: 1.1rem; }
        .module-result-elim { font-size: 0.75rem; font-style: italic; margin-left: 0.3rem; color: var(--error-color); }

        /* General average display - Enhanced */
        .moyenne-generale {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            background-size: 250% 250%;
            color: var(--text-dark);
            border-radius: 1rem; /* Consistent radius */
            padding: 2rem 1.5rem;
            box-shadow: 0 10px 35px rgba(0, 123, 255, 0.3);
            position: relative;
            overflow: hidden;
            animation: gradientShift 7s ease infinite, subtlePulse 3s infinite alternate;
            text-align: center;
            transition: transform 0.4s ease, box-shadow 0.4s ease;
        }
        .moyenne-generale:hover {
             transform: scale(1.02);
             box-shadow: 0 14px 45px rgba(0, 123, 255, 0.4);
        }

        @keyframes subtlePulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.015); } /* Very subtle pulse */
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .moyenne-generale.validated {
            box-shadow: 0 0 20px var(--accent-color), 0 0 40px var(--primary-color); /* Accent glow */
        }

        .moyenne-generale-val {
            font-size: 3.2rem; /* Slightly adjusted */
            font-weight: 800;
            text-shadow: 0 2px 5px var(--shadow-color);
            transition: all 0.5s ease;
            margin-bottom: 0.75rem;
             line-height: 1; /* Ensure tight line height */
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 5px;
            margin-top: 1.5rem;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(to right, var(--accent-color), var(--primary-color)); /* Accent gradient */
            transition: width 1.5s cubic-bezier(0.25, 1, 0.5, 1);
            border-radius: 5px;
        }

        #validation-status {
            margin-top: 1.2rem;
            font-weight: 600;
            font-size: 1.05rem; /* Adjusted size */
            text-shadow: 1px 1px 2px var(--shadow-color-light);
            min-height: 1.5em; /* Prevent layout shift */
        }
        #validation-status.validated-status { color: var(--success-color); }
        #validation-status.eliminated-status { color: var(--error-color); }
        #validation-status.not-validated-status { color: var(--warning-color); }

        .credits-row {
            display: flex;
            justify-content: space-around;
            margin-top: 1.2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--card-border);
            font-size: 0.95rem;
        }

        /* Instagram Button */
         .instagram-btn {
             display: inline-flex;
             align-items: center;
             justify-content: center; /* Center icon */
             margin-top: 1.5rem; /* Space above button */
             padding: 0.6rem 1rem;
             border-radius: 8px;
             background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
             color: white;
             text-decoration: none;
             font-weight: 600;
             font-size: 0.9rem;
             transition: all 0.3s ease;
             box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
         }
         .instagram-btn:hover {
             transform: translateY(-2px) scale(1.05);
             box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
             filter: brightness(1.1);
         }
         .instagram-btn i {
             font-size: 1.3em; /* Larger icon */
             margin-right: 0.5rem;
         }

        /* What-if section */
        .what-if-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed var(--card-border);
            border-radius: 10px;
            padding: 1.5rem; /* Increased padding */
            margin-top: 2.5rem;
            box-shadow: 0 4px 15px var(--shadow-color-light);
        }
        .what-if-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .what-if-input {
            padding: 8px 10px; /* Adjust padding */
            border-radius: 6px;
            width: 90px;
            background: var(--input-bg);
            color: var(--text-dark);
            border: 1px solid var(--input-border);
            font-size: 0.9rem;
        }
         .what-if-input:focus {
             border-color: var(--accent-color);
             box-shadow: 0 0 0 3px rgba(0, 230, 230, 0.3);
         }
        .what-if-btn {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: var(--text-dark);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
             border: none;
             cursor: pointer;
        }
        .what-if-btn:hover {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            transform: translateY(-2px);
            filter: brightness(1.1);
        }
        .what-if-btn i { margin-right: 0.4rem; }

        /* Action buttons row */
        .action-buttons-row {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 2rem; /* Increased margin */
            padding-top: 1.5rem;
            border-top: 1px solid var(--card-border);
        }
        .action-btn {
            padding: 0.7rem 1.4rem; /* Slightly larger */
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
            cursor: pointer;
             box-shadow: 0 2px 5px var(--shadow-color-light);
        }
        .action-btn:hover {
             transform: translateY(-2px) scale(1.03);
             box-shadow: 0 4px 10px var(--shadow-color);
        }
        .action-btn:disabled {
             opacity: 0.5;
             cursor: not-allowed;
             transform: none;
             box-shadow: none;
        }

        .tooltip {
            position: absolute;
            bottom: 130%; /* Further above */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: var(--text-light);
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.75rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
            z-index: 20;
        }
        .tooltip::after {
             content: "";
             position: absolute;
             top: 100%; left: 50%; margin-left: -5px;
             border-width: 5px; border-style: solid;
             border-color: rgba(0, 0, 0, 0.85) transparent transparent transparent;
         }
         .action-btn:hover .tooltip { opacity: 1; visibility: visible; }


        .save-load-btn { background: linear-gradient(to right, var(--primary-color), var(--secondary-color)); color: var(--text-dark); }
        .clear-btn { background: linear-gradient(to right, var(--error-color), #b71c1c); color: var(--text-dark); }
        .calculate-btn { background: linear-gradient(135deg, var(--accent-color), var(--primary-color)); color: var(--text-dark); } /* Accent gradient */


        /* Loader animation */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid var(--accent-color); /* Use accent color */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            display: inline-block; /* Ensure it takes space */
        }
        .action-btn .loader { width: 18px; height: 18px; border-width: 3px; } /* Smaller loader in buttons */

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.75); /* Darker overlay */
            backdrop-filter: blur(5px); /* Blur background */
            justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: rgba(30, 41, 59, 0.95); /* Darker modal */
            backdrop-filter: blur(10px);
            padding: 2rem; /* More padding */
            border-radius: 1rem;
            text-align: center;
            max-width: 90%; width: 450px; /* Slightly wider */
            box-shadow: 0 10px 40px var(--shadow-color);
            position: relative;
            animation: slideIn 0.4s cubic-bezier(0.25, 1, 0.5, 1); /* Smoother slide */
            color: var(--text-dark);
            border: 1px solid var(--card-border);
        }
        @keyframes slideIn {
            from { transform: translateY(-30px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .modal-close {
            position: absolute; top: 0.75rem; right: 0.75rem;
            background: var(--error-color); color: var(--text-dark);
            border: none; border-radius: 50%;
            width: 30px; height: 30px; cursor: pointer;
            font-size: 1rem; line-height: 30px; text-align: center;
            transition: all 0.2s ease;
        }
        .modal-close:hover { background: #b71c1c; transform: scale(1.1); }

        .modal-buttons { display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem; }
        .modal-btn {
            padding: 0.6rem 1.8rem; /* Adjust padding */
            border-radius: 8px; font-weight: 600; cursor: pointer;
            transition: transform 0.2s ease, filter 0.2s ease;
            border: none;
             box-shadow: 0 2px 5px var(--shadow-color-light);
        }
        .modal-btn:hover { transform: scale(1.05); filter: brightness(1.1); }
        .modal-btn.confirm { background: var(--primary-color); color: var(--text-dark); }
        .modal-btn.cancel { background: var(--error-color); color: var(--text-dark); }

        /* Responsive adjustments */
        @media (min-width: 768px) {
             .selection-inputs {
                 flex-direction: row;
                 justify-content: space-between;
                 gap: 1.5rem; /* Gap between items */
             }
             .form-group {
                 flex: 1; /* Allow groups to grow equally */
                 min-width: 0; /* Prevent overflow issues with flex */
             }
             .back-button {
                 left: 1rem; /* Adjust position */
             }
        }

        @media (max-width: 768px) {
             .note-inputs { grid-template-columns: repeat(auto-fit, minmax(75px, 1fr)); } /* Adjust grid */
             .glass-card { padding: 1.2rem; }
             .module-card { padding: 1rem; }
             body { padding-bottom: 60px; } /* Space for potential bottom nav */
             .moyenne-generale-val { font-size: 2.8rem; }
             .title-banner h1 { font-size: 1.8rem; }
             .selection-inputs { flex-direction: column; gap: 1rem; }
             .form-group { width: 100%; }
             .main-header { margin-bottom: 1rem; } /* Reduce margin */
             .header-content { flex-direction: column; align-items: center;} /* Center logo above button */
             .back-button { position: static; margin-bottom: 1rem; } /* Reset button position */
             .logo-container { margin-bottom: 1.5rem; } /* Adjust space */
             .action-buttons-row { gap: 0.75rem; }
             .action-btn { padding: 0.7rem 1.2rem; }
        }

        @media (max-width: 480px) {
             .selection-input, .custom-input { font-size: 0.9rem; padding: 10px 12px; }
             .what-if-row { flex-direction: column; align-items: stretch; gap: 0.75rem; }
             .what-if-input { width: 100px; }
             footer { padding: 1.5rem 0.75rem; }
             .container { padding-left: 0.75rem; padding-right: 0.75rem; }
             .action-btn { padding: 0.7rem; font-size: 0.9rem; gap: 0.4rem; }
             .modal-content { padding: 1.5rem; width: 95%; }
             .moyenne-generale-val { font-size: 2.5rem; }
             .title-banner h1 { font-size: 1.6rem; }
             .title-banner { padding: 1.5rem; }
        }

        /* Footer styles */
        footer {
            background: rgba(15, 12, 41, 0.8); /* Darker, slightly transparent */
            backdrop-filter: blur(5px);
            color: #b0b0d0; /* Lighter gray text */
            padding: 2.5rem 1rem; /* More padding */
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.35);
            margin-top: auto; /* Stick to bottom */
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        footer a {
            color: var(--accent-color); /* Use accent color for links */
            transition: color 0.2s ease, text-shadow 0.2s ease;
        }

        footer a:hover {
            color: #fff; /* White on hover */
            text-shadow: 0 0 5px var(--accent-color); /* Glow effect */
        }

        .footer-icon {
            color: var(--text-light); /* Lighter icon color */
            transition: transform 0.3s ease, color 0.2s ease;
            font-size: 1.4rem; /* Larger icons */
        }

        .footer-icon:hover {
            transform: scale(1.2) translateY(-2px);
            color: var(--accent-color);
        }
        .footer-links {
             margin-top: 1rem;
             display: flex;
             justify-content: center;
             gap: 1.5rem; /* Space out icons */
        }
        footer p {
             margin-bottom: 0.5rem; /* Spacing between paragraphs */
             font-size: 0.9rem;
        }
        footer .copyright {
             font-size: 0.85rem;
             opacity: 0.7;
             margin-top: 1.5rem;
        }


    </style>
</head>

<body>
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-5xl flex-grow py-6">
        <header class="main-header" data-aos="fade-down">
            <div class="header-content">
                <a href="index.html" class="back-button"><i class="fas fa-arrow-left"></i> Retour</a>
                <div class="logo-container">
                     <img src="assets/img/LOGO.png" alt="Université de Bejaia" class="mx-auto">
                </div>
            </div>
        </header>

        <div class="title-banner" data-aos="zoom-in">
            <h1>Calculateur de Moyenne</h1>
            <p>Développé par <span class="font-semibold">Amara Mehdi</span></p>
        </div>

        <div class="glass-card">
            <div class="selection-area">
                <div class="selection-inputs">
                    <div class="form-group">
                        <label for="anneeSelect">Année</label>
                        <select id="anneeSelect" class="selection-input"></select>
                    </div>
                    <div class="form-group">
                        <label for="specialiteSelect">Spécialité</label>
                        <select id="specialiteSelect" class="selection-input" disabled></select>
                    </div>
                    <div class="form-group">
                        <label for="semestreSelect">Semestre</label>
                        <select id="semestreSelect" class="selection-input" disabled></select>
                    </div>
                </div>
            </div>

            <div id="noteForm" class="space-y-4">
                <p id="module-placeholder" class="text-center text-[#eee] py-8">Chargement des données... <span
                        class="loader"></span></p>
            </div>

            <div id="what-if-section" class="what-if-card hidden" data-aos="fade-up" data-aos-delay="100">
                <h3 class="text-lg font-semibold mb-3 text-[#fff]">Calcul "Et Si ?"</h3>
                <div class="what-if-row">
                    <label for="targetAverage" class="what-if-label text-[#eee]">Moyenne Cible :</label>
                    <input type="number" id="targetAverage" min="0" max="20" step="0.01" value="10.00"> <!-- Removed class, using general input style -->
                    <button onclick="calculateWhatIf()" class="what-if-btn"><i class="fas fa-calculator mr-2"></i> <!-- Changed icon -->
                        Calculer Notes Examen</button>
                </div>
            </div>

            <div class="action-buttons-row">
                <button id="saveBtn" onclick="saveGrades()" class="action-btn save-load-btn" disabled>
                    <i class="fas fa-save"></i> Sauvegarder <span id="saveLoader" class="loader hidden"></span>
                    <span class="tooltip">Sauvegarder vos notes</span>
                </button>
                <button id="loadBtn" onclick="loadGrades()" class="action-btn save-load-btn" disabled>
                    <i class="fas fa-download"></i> Charger <span id="loadLoader" class="loader hidden"></span>
                    <span class="tooltip">Charger les notes sauvegardées</span>
                </button>
                <button id="clearBtn" onclick="clearGrades()" class="action-btn clear-btn" disabled>
                    <i class="fas fa-trash-alt"></i> Effacer
                    <span class="tooltip">Effacer toutes les notes</span>
                </button>
                <button id="calculateBtn" onclick="calculerMoyenneGenerale()" class="action-btn calculate-btn"
                    disabled>
                    <i class="fas fa-chart-line mr-2"></i> Calculer Moyenne <!-- Changed icon -->
                    <span class="tooltip">Calculer la moyenne générale</span>
                </button>
            </div>

            <div id="resultats" class="mt-8" data-aos="fade-up" data-aos-delay="200">
                <h2 class="text-xl font-bold mb-4 text-center text-[#fff] border-b pb-3 border-white">Résultats
                    Détaillés</h2>
                <div id="modules-results" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"></div>
                <div id="moyenneGenerale" class="moyenne-generale">
                    <h3 class="text-lg font-semibold mb-2">Moyenne Générale</h3>
                    <div id="moyenne-generale-val" class="moyenne-generale-val">--</div>
                    <div class="progress-bar">
                        <div id="progressBarFill" class="progress-bar-fill" style="width: 0%"></div>
                    </div>
                    <p id="validation-status" class="mt-3 font-medium text-base"></p>
                    <div id="credits-results" class="credits-row">
                        <span id="credits-attempted">Crédits Tentés: --</span>
                        <span id="credits-validated">Crédits Validés: --</span>
                    </div>
                    <!-- Instagram Button -->
                    <a href="https://www.instagram.com/spot_campuselkseur/" target="_blank" rel="noopener noreferrer" class="instagram-btn">
                         <i class="fab fa-instagram"></i> Voir sur Instagram
                    </a>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-5xl">
            <p>Conçu et développé avec <i class="fas fa-heart text-red-500"></i> par <a href="mailto:mehdi.amara@tech.univ-bejaia.dz"
                    class="font-medium">Amara Mehdi</a>.</p>
            <div class="footer-links">
                <a href="#" class="footer-icon" aria-label="GitHub"><i class="fab fa-github"></i></a>
                <a href="#" class="footer-icon" aria-label="LinkedIn"><i class="fab fa-linkedin"></i></a>
                <a href="mailto:support@univ-bejaia.dz" class="footer-icon" aria-label="Email Support"><i class="fas fa-envelope"></i></a>
            </div>
             <p class="copyright">© 2025 Université de Bejaia. Tous droits réservés. | Version 0.4.9.5</p> <!-- Updated year/version -->
             <p class="text-xs opacity-70 mt-2">Pour toute question ou suggestion, <a href="mailto:mehdi.amara@tech.univ-bejaia.dz" class="underline">contactez-nous</a>.</p>
        </div>
    </footer>


    <!-- Modals -->
    <div id="minExamModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('minExamModal')" aria-label="Fermer">×</button> <!-- Added aria-label -->
            <h3 class="text-lg font-semibold mb-3">Note Minimale Examen Requis</h3>
            <p id="minExamMessage" class="text-[#eee]"></p>
        </div>
    </div>

    <div id="clearConfirmModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('clearConfirmModal')" aria-label="Fermer">×</button>
            <h3 class="text-lg font-semibold mb-3">Confirmer l'effacement</h3>
            <p class="text-[#eee]">Voulez-vous vraiment effacer toutes les notes ? Cette action est irréversible.</p>
            <div class="modal-buttons">
                <button class="modal-btn confirm" onclick="confirmClearGrades()">Oui, Effacer</button>
                <button class="modal-btn cancel" onclick="closeModal('clearConfirmModal')">Annuler</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({
            duration: 800,
            once: true,
            offset: 100
        });

        // --- DOM Element Caching ---
        const anneeSelect = document.getElementById('anneeSelect');
        const specialiteSelect = document.getElementById('specialiteSelect');
        const semestreSelect = document.getElementById('semestreSelect');
        const noteForm = document.getElementById('noteForm');
        const modulePlaceholder = document.getElementById('module-placeholder');
        const resultatsDiv = document.getElementById('resultats');
        const modulesResultsDiv = document.getElementById('modules-results');
        const moyenneGeneraleDiv = document.getElementById('moyenne-generale-val');
        const validationStatusDiv = document.getElementById('validation-status');
        const creditsAttemptedSpan = document.getElementById('credits-attempted');
        const creditsValidatedSpan = document.getElementById('credits-validated');
        const progressBarFill = document.getElementById('progressBarFill');
        const moyenneGeneraleContainer = document.getElementById('moyenneGenerale');
        const calculateBtn = document.getElementById('calculateBtn');
        const saveBtn = document.getElementById('saveBtn');
        const loadBtn = document.getElementById('loadBtn');
        const clearBtn = document.getElementById('clearBtn');
        const whatIfSection = document.getElementById('what-if-section');
        const targetAverageInput = document.getElementById('targetAverage');
        const saveLoader = document.getElementById('saveLoader');
        const loadLoader = document.getElementById('loadLoader');

        // --- State Variables ---
        let years = [];
        let specialties = [];
        let allModules = []; // Cache for modules of the selected specialty
        let currentModulesData = []; // Modules currently displayed for the selected semester

        // --- Modal Functions ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) modal.style.display = 'flex';
        }
        function closeModal(modalId) {
             const modal = document.getElementById(modalId);
             if(modal) modal.style.display = 'none';
        }

        // --- Debounce Utility ---
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // --- Event Delegation for Inputs ---
        noteForm.addEventListener('input', debounce((event) => {
            if (event.target.classList.contains('module-grade-input')) {
                 console.log(`Input event triggered for: ${event.target.id}`); // Debug
                validateGradeInput(event.target);
                 // No need to call calculateModuleAverage here, validateGradeInput handles it
            }
        }, 350)); // Slightly increased debounce time


        // --- Data Fetching ---
        async function fetchInitialData() {
            if (!window.db || !window.firestoreFunctions) {
                console.error("Firestore non initialisé. Impossible de récupérer les données.");
                modulePlaceholder.textContent = 'Erreur: Connexion base de données échouée.';
                return;
            }
            modulePlaceholder.innerHTML = 'Chargement initial... <span class="loader"></span>';
            try {
                const [yearsSnapshot, specialtiesSnapshot] = await Promise.all([
                    window.firestoreFunctions.getDocs(window.firestoreFunctions.query(
                        window.firestoreFunctions.collection(window.db, 'years'),
                        window.firestoreFunctions.orderBy('order', 'asc')
                    )),
                    window.firestoreFunctions.getDocs(window.firestoreFunctions.collection(window.db, 'specialties'))
                ]);

                years = yearsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                specialties = specialtiesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                populateAnneeSelect();
                modulePlaceholder.textContent = 'Sélectionnez une année, spécialité et semestre.';
            } catch (error) {
                console.error('Erreur fetchInitialData:', error);
                modulePlaceholder.textContent = 'Erreur de chargement initial. Vérifiez la connexion.';
            } finally {
                 enableDisableControls(); // Update control states after fetching
            }
        }

        async function fetchModules() {
             if (!window.db || !window.firestoreFunctions) {
                console.error("Firestore non initialisé. Impossible de récupérer les modules.");
                 modulePlaceholder.textContent = 'Erreur: Chargement modules impossible.';
                 return;
            }
            const selectedSpecialtyId = specialiteSelect.value;
            allModules = []; // Reset cache before fetching
            populateSemestreSelect(); // Update semester dropdown (will show 'loading' or 'none')

            if (!selectedSpecialtyId) {
                return; // Exit if no specialty selected
            }

            modulePlaceholder.innerHTML = 'Chargement des modules... <span class="loader"></span>';
            try {
                const modulesQuery = window.firestoreFunctions.query(
                    window.firestoreFunctions.collection(window.db, 'modules'),
                    window.firestoreFunctions.where('specialtyId', '==', selectedSpecialtyId)
                );
                const modulesSnapshot = await window.firestoreFunctions.getDocs(modulesQuery);
                allModules = modulesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`Fetched ${allModules.length} modules for specialty ${selectedSpecialtyId}`);
            } catch (error) {
                console.error('Erreur fetchModules:', error);
                modulePlaceholder.textContent = 'Erreur chargement modules.';
            } finally {
                populateSemestreSelect(); // Populate semesters based on fetched modules
            }
        }


        // --- Dropdown Population ---
        function populateAnneeSelect() {
            anneeSelect.innerHTML = '<option value="">-- Sélection Année --</option>';
            years.forEach(year => {
                const option = new Option(year.name, year.id); // Use Option constructor
                anneeSelect.add(option);
            });
            anneeSelect.disabled = false;
            populateSpecialiteSelect();
        }

        function populateSpecialiteSelect() {
            const selectedYearId = anneeSelect.value;
            specialiteSelect.innerHTML = '<option value="">-- Sélection Spécialité --</option>';
            specialiteSelect.disabled = !selectedYearId;

            semestreSelect.innerHTML = '<option value="">-- Sélection Semestre --</option>';
            semestreSelect.disabled = true;

            resetCalculatorState(); // Clear form and results

            if (selectedYearId) {
                const filteredSpecialties = specialties.filter(s => s.yearId === selectedYearId);
                if (filteredSpecialties.length > 0) {
                    filteredSpecialties.forEach(spec => {
                        const option = new Option(spec.name, spec.id);
                        specialiteSelect.add(option);
                    });
                    specialiteSelect.disabled = false;
                } else {
                     specialiteSelect.innerHTML = '<option value="">-- Aucune Spécialité --</option>';
                }
                fetchModules(); // Fetch modules for the selected year
            } else {
                modulePlaceholder.textContent = 'Sélectionnez une année.';
            }
             enableDisableControls();
        }

        function populateSemestreSelect() {
            const selectedSpecialtyId = specialiteSelect.value;
            semestreSelect.innerHTML = '<option value="">-- Sélection Semestre --</option>';
            semestreSelect.disabled = !selectedSpecialtyId || allModules.length === 0;

            resetCalculatorState(); // Clear form and results

            if (selectedSpecialtyId && allModules.length > 0) {
                const semesterKeys = [...new Set(allModules.map(m => m.semesterKey).filter(Boolean))].sort(); // Filter out undefined/null keys
                if (semesterKeys.length > 0) {
                    semesterKeys.forEach(key => {
                        const option = new Option(key, key); // Display key directly
                        semestreSelect.add(option);
                    });
                    semestreSelect.disabled = false;
                } else {
                     semestreSelect.innerHTML = '<option value="">-- Aucun Semestre --</option>';
                     modulePlaceholder.textContent = 'Aucun semestre défini pour cette spécialité.';
                }
            } else if (selectedSpecialtyId) {
                 modulePlaceholder.textContent = 'Chargement des modules ou aucun module trouvé.';
            } else {
                 modulePlaceholder.textContent = 'Sélectionnez une année et une spécialité.';
            }
             enableDisableControls();
        }

         // --- Reset UI State ---
         function resetCalculatorState() {
             noteForm.innerHTML = '';
             currentModulesData = [];
             resultatsDiv.classList.remove('visible');
             whatIfSection.classList.add('hidden');
             modulePlaceholder.classList.remove('hidden');
             // Reset overall average display
             moyenneGeneraleDiv.textContent = '--';
             validationStatusDiv.textContent = '';
             validationStatusDiv.className = 'mt-3 font-medium text-base';
             creditsAttemptedSpan.textContent = 'Crédits Tentés: --';
             creditsValidatedSpan.textContent = 'Crédits Validés: --';
             progressBarFill.style.width = '0%';
             moyenneGeneraleContainer.classList.remove('validated');
         }


        // --- Module Display & Card Creation ---
        function displayModules() {
            const selectedSpecialtyId = specialiteSelect.value;
            const selectedSemesterKey = semestreSelect.value;

            resetCalculatorState(); // Start fresh

            if (selectedSpecialtyId && selectedSemesterKey) {
                currentModulesData = allModules.filter(m => m.semesterKey === selectedSemesterKey);

                if (currentModulesData.length > 0) {
                    currentModulesData.forEach((module, index) => {
                        const card = createModuleCard(module, index);
                        noteForm.appendChild(card);
                    });
                    modulePlaceholder.classList.add('hidden');
                    whatIfSection.classList.remove('hidden');
                    loadGrades(); // Attempt to load grades for this selection
                    const firstInput = noteForm.querySelector('.module-grade-input');
                    if (firstInput) firstInput.focus();
                } else {
                    modulePlaceholder.textContent = 'Aucun module trouvé pour ce semestre.';
                }
            } else {
                 if (!selectedSpecialtyId) modulePlaceholder.textContent = 'Sélectionnez une spécialité.';
                 else if (!selectedSemesterKey) modulePlaceholder.textContent = 'Sélectionnez un semestre.';
            }
             enableDisableControls();
        }

        function createModuleCard(module, index) {
             // Simplified card creation (styles handled by CSS)
            const card = document.createElement('div');
            card.className = 'module-card';
            card.setAttribute('data-aos', 'fade-up');
            card.setAttribute('data-aos-delay', index * 50);
            card.dataset.moduleId = module.id;
            card.dataset.coefficient = module.coefficient || 0; // Default coefficient
            card.dataset.credits = module.credits || 0;       // Default credits
            card.dataset.noteElim = module.noteEliminatoire ?? ''; // Use nullish coalescing

            const evaluations = Array.isArray(module.evaluations) ? module.evaluations : [];
            let inputsHTML = evaluations.map(type => {
                const inputId = `${module.id}-${type.toLowerCase()}`;
                return `
                    <div class="note-field">
                        <label for="${inputId}">${type}</label>
                        <input type="text" id="${inputId}" inputmode="decimal" class="custom-input module-grade-input" placeholder="--">
                    </div>
                `;
            }).join('');

            if (evaluations.length === 0) {
                 inputsHTML = '<p class="text-xs text-gray-400 col-span-full text-center">Aucun type d\'évaluation défini.</p>'; // Span full width
            }

            const hasExam = evaluations.includes('Examen');
            const minExamButtonHTML = hasExam ? `<button class="min-exam-btn" onclick="calculateMinExamGrade('${module.id}')">Note Min. Examen</button>` : '';

            card.innerHTML = `
                <h3 class="text-base font-semibold mb-2 text-[#fff]">${module.name || 'Module Sans Nom'}</h3>
                <div class="flex flex-wrap gap-2 mb-3 text-xs">
                    <span class="bg-rgba(255, 255, 255, 0.05) text-[#eee] px-2 py-1 rounded-full">Coef: ${module.coefficient || 'N/A'}</span>
                    <span class="bg-rgba(255, 255, 255, 0.05) text-[#eee] px-2 py-1 rounded-full">Crédits: ${module.credits || 'N/A'}</span>
                    ${module.noteEliminatoire !== undefined ? `<span class="bg-[#2a1a1a] text-[#e63946] px-2 py-1 rounded-full">Élim: ${module.noteEliminatoire}</span>` : ''}
                </div>
                <div class="note-inputs">${inputsHTML}</div>
                <div class="module-footer">
                    <div class="avg-text" id="avg-${module.id}">Moy: --</div>
                    <div class="flex gap-2">
                        ${minExamButtonHTML}
                        <button class="clear-module-btn" onclick="clearModuleGrades('${module.id}')">Effacer</button>
                    </div>
                </div>
            `;
            return card;
        }


        // --- Input Handling & Validation ---
        function validateGradeInput(inputElement) {
            let value = inputElement.value.trim();
             const card = inputElement.closest('.module-card'); // Get parent card

            if (value === '') {
                inputElement.classList.remove('input-error');
                 if (card) calculateModuleAverage(card); // Recalculate average when cleared
                return;
            }

            value = value.replace(',', '.').replace(/[^0-9.]/g, ''); // Allow only numbers and dot
            const parts = value.split('.');
            if (parts.length > 2) value = parts[0] + '.' + parts.slice(1).join(''); // Only one dot
            // Allow partial input like "1." or "." temporarily but mark as error
            const isPartial = value === '.' || (value.endsWith('.') && value.length > 1 && isNaN(parseFloat(value.slice(0, -1))));

            inputElement.value = value; // Update input field

            const numericValue = parseFloat(value); // Try parsing

            if (isPartial || isNaN(numericValue) || numericValue < 0 || numericValue > 20) {
                inputElement.classList.add('input-error');
                 // Clear module average display if input is invalid/partial
                 if (card) {
                     const avgDisplay = card.querySelector('.avg-text');
                     if (avgDisplay) avgDisplay.textContent = 'Moy: --';
                 }
            } else {
                inputElement.classList.remove('input-error');
                if (card) calculateModuleAverage(card); // Calculate only if fully valid
            }
        }

        function parseGrade(value) {
            if (!value || typeof value !== 'string') return { num: null, valid: false };
            value = value.trim();
            if (value === '' || value === '.') return { num: null, valid: false };

            const cleaned = value.replace(',', '.');
            // Handle "1." -> parse as 1, but only if it's the only dot
            const num = parseFloat(cleaned.endsWith('.') && cleaned.indexOf('.') === cleaned.length - 1 ? cleaned.slice(0, -1) : cleaned);

            const isValid = !isNaN(num) && num >= 0 && num <= 20;
            return { num: isValid ? num : null, valid: isValid };
        }


        // --- Calculation Logic ---
        function calculateModuleAverage(moduleCardElement) {
             if (!moduleCardElement) return { average: null, isEliminated: false, isValid: false };

            const moduleId = moduleCardElement.dataset.moduleId;
            const moduleData = currentModulesData.find(m => m.id === moduleId);
            const avgDisplay = moduleCardElement.querySelector(`#avg-${moduleId}`); // Cache selector

            if (!moduleData || !avgDisplay) {
                 if(avgDisplay) avgDisplay.textContent = 'Moy: Err'; // Indicate error finding data
                 return { average: null, isEliminated: false, isValid: false };
            }

            const evals = Array.isArray(moduleData.evaluations) ? moduleData.evaluations : [];
            if (evals.length === 0) {
                 avgDisplay.textContent = 'Moy: N/A';
                 avgDisplay.style.color = '#ccc';
                 return { average: null, isEliminated: false, isValid: false };
            }

            const grades = {};
            let allInputsValidAndFilled = true;

            for (const type of evals) {
                const input = moduleCardElement.querySelector(`#${moduleId}-${type.toLowerCase()}`);
                const gradeInfo = input ? parseGrade(input.value) : { num: null, valid: false };
                grades[type.toLowerCase()] = gradeInfo;
                if (!gradeInfo.valid) {
                    allInputsValidAndFilled = false;
                }
            }

             // If any input is invalid/empty, show '--' and return invalid
             if (!allInputsValidAndFilled) {
                 avgDisplay.textContent = 'Moy: --';
                 avgDisplay.style.color = '#ccc';
                 return { average: null, isEliminated: false, isValid: false };
             }


            let sum = 0, weightSum = 0;
            const elimNote = parseFloat(moduleCardElement.dataset.noteElim);
            let isEliminated = false;

            const hasTD = evals.includes('TD');
            const hasTP = evals.includes('TP');
            const hasExam = evals.includes('Examen');

            // Calculate weighted sum based on defined evals
            if (hasTD && hasTP && hasExam) {
                 sum += (grades['td']?.num ?? 0) * 0.2 + (grades['tp']?.num ?? 0) * 0.2 + (grades['examen']?.num ?? 0) * 0.6;
                 weightSum = 1.0;
             } else if (hasTP && hasExam) {
                 sum += (grades['tp']?.num ?? 0) * 0.4 + (grades['examen']?.num ?? 0) * 0.6;
                 weightSum = 1.0;
             } else if (hasTD && hasExam) {
                 sum += (grades['td']?.num ?? 0) * 0.4 + (grades['examen']?.num ?? 0) * 0.6;
                 weightSum = 1.0;
             } else if (hasExam) {
                 sum += (grades['examen']?.num ?? 0) * 1.0;
                 weightSum = 1.0;
             } else if (hasTP) {
                 sum += (grades['tp']?.num ?? 0) * 1.0;
                 weightSum = 1.0;
             } else if (hasTD) {
                 sum += (grades['td']?.num ?? 0) * 1.0;
                 weightSum = 1.0;
             }
             // If none match, weightSum remains 0

            const average = weightSum > 0 ? sum / weightSum : null;

            if (average !== null && !isNaN(elimNote) && average < elimNote) {
                isEliminated = true;
            }

            // Update display
            const avgText = average !== null ? average.toFixed(2) : '--';
            avgDisplay.textContent = `Moy: ${avgText}${isEliminated ? ' (Élim.)' : ''}`;
            avgDisplay.style.color = average !== null
                ? (average >= 10 && !isEliminated ? 'var(--success-color)' : 'var(--error-color)')
                : '#ccc';

            return { average, isEliminated, isValid: average !== null };
        }

        function calculerMoyenneGenerale() {
            let totalWeightedSum = 0,
                totalCoeff = 0,
                totalCreditsAttempted = 0,
                totalCreditsValidated = 0,
                hasEliminations = false;
            let allModulesHaveValidAverage = true;

            const moduleCards = document.querySelectorAll('.module-card');
             if (moduleCards.length === 0) {
                 alert("Aucun module affiché pour calculer la moyenne.");
                 return;
             }

            // First pass: ensure all module averages can be calculated
            moduleCards.forEach(card => {
                const result = calculateModuleAverage(card);
                if (!result.isValid) {
                    allModulesHaveValidAverage = false;
                    // Highlight the problematic module card (optional)
                     // card.style.borderColor = 'var(--warning-color)';
                } else {
                    // Reset border if previously highlighted (optional)
                     // card.style.borderColor = ''; // Or set back to default
                }
            });

             // Update detailed results display first
             modulesResultsDiv.innerHTML = '';
             currentModulesData.forEach(module => {
                 const card = noteForm.querySelector(`.module-card[data-module-id="${module.id}"]`);
                 const result = card ? calculateModuleAverage(card) : { average: null, isEliminated: false, isValid: false };
                 const moduleResultCard = document.createElement('div');
                 moduleResultCard.className = 'module-result-card';
                 const avgText = result.average !== null ? result.average.toFixed(2) : '--';
                 const elimText = result.isEliminated ? '<span class="module-result-elim">(Élim.)</span>' : '';
                 const color = result.isValid
                     ? (result.average >= 10 && !result.isEliminated ? 'var(--success-color)' : 'var(--error-color)')
                     : '#ccc';
                 moduleResultCard.innerHTML = `
                     <div class="module-result-title">${module.name || 'Module Inconnu'}</div>
                     <div class="module-result-avg" style="color: ${color}">${avgText} ${elimText}</div>
                 `;
                 modulesResultsDiv.appendChild(moduleResultCard);
             });

            if (!allModulesHaveValidAverage) {
                alert("Veuillez entrer toutes les notes valides (0-20) pour chaque module avant de calculer la moyenne générale.");
                // Update UI to reflect error state
                moyenneGeneraleDiv.textContent = '--';
                validationStatusDiv.textContent = 'Notes manquantes/invalides';
                validationStatusDiv.className = 'mt-3 font-medium text-base not-validated-status'; // Use warning color
                creditsAttemptedSpan.textContent = 'Crédits Tentés: --';
                creditsValidatedSpan.textContent = 'Crédits Validés: --';
                progressBarFill.style.width = '0%';
                resultatsDiv.classList.add('visible');
                moyenneGeneraleContainer.classList.remove('validated');
                return;
            }

            // Second pass: Calculate totals now that we know all modules are valid
            moduleCards.forEach(card => {
                 const result = calculateModuleAverage(card); // Get the validated result again
                 const coeff = parseFloat(card.dataset.coefficient) || 0;
                 const credits = parseFloat(card.dataset.credits) || 0;

                 totalWeightedSum += result.average * coeff;
                 totalCoeff += coeff;
                 totalCreditsAttempted += credits;

                 if (result.average >= 10 && !result.isEliminated) {
                     totalCreditsValidated += credits;
                 }
                 if (result.isEliminated) {
                     hasEliminations = true;
                 }
            });


            // Calculate and display final results
            const moyenneFinale = totalCoeff > 0 ? totalWeightedSum / totalCoeff : null;
            moyenneGeneraleDiv.textContent = moyenneFinale !== null ? moyenneFinale.toFixed(2) : '--';
            const isValidated = moyenneFinale !== null && moyenneFinale >= 10 && !hasEliminations;

            validationStatusDiv.className = 'mt-3 font-medium text-base'; // Reset classes
            if (isValidated) {
                validationStatusDiv.textContent = 'Semestre Validé';
                validationStatusDiv.classList.add('validated-status');
                moyenneGeneraleContainer.classList.add('validated');
            } else if (hasEliminations) {
                validationStatusDiv.textContent = 'Non Validé (Élimination)';
                validationStatusDiv.classList.add('eliminated-status');
                moyenneGeneraleContainer.classList.remove('validated');
            } else {
                validationStatusDiv.textContent = 'Non Validé';
                validationStatusDiv.classList.add('not-validated-status');
                moyenneGeneraleContainer.classList.remove('validated');
            }

            creditsAttemptedSpan.textContent = `Crédits Tentés: ${totalCreditsAttempted}`;
            creditsValidatedSpan.textContent = `Crédits Validés: ${totalCreditsValidated}`;

            const progress = moyenneFinale !== null ? Math.min(100, (moyenneFinale / 20) * 100) : 0;
            progressBarFill.style.width = `${progress}%`;

            resultatsDiv.classList.add('visible');
            resultatsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // --- Storage Functions ---
        function getStorageKey() {
            const year = anneeSelect.value;
            const spec = specialiteSelect.value;
            const sem = semestreSelect.value;
            return year && spec && sem ? `@calculatorGrades_${year}_${spec}_${sem}` : null;
        }

        function saveGrades() {
            const key = getStorageKey();
            if (!key) return alert('Sélectionnez Année, Spécialité et Semestre.');
            const gradesToSave = {};
            let hasGrades = false;
            noteForm.querySelectorAll('.module-grade-input').forEach(input => { // Target inputs within noteForm
                const card = input.closest('.module-card');
                if (!card) return;
                const moduleId = card.dataset.moduleId;
                const type = input.id.split('-').pop(); // Get last part (td, tp, examen)
                if (!moduleId || !type) return;
                if (!gradesToSave[moduleId]) gradesToSave[moduleId] = {};
                gradesToSave[moduleId][type] = input.value;
                if (input.value.trim() !== '') hasGrades = true;
            });

            // No alert if saving empty state
            // if (!hasGrades) { return alert("Aucune note à sauvegarder."); }

            saveLoader.classList.remove('hidden');
            saveBtn.disabled = true;
            try {
                localStorage.setItem(key, JSON.stringify(gradesToSave));
                setTimeout(() => {
                    saveBtn.innerHTML = '<i class="fas fa-check"></i> Sauvegardé';
                    setTimeout(() => {
                        saveBtn.innerHTML = '<i class="fas fa-save"></i> Sauvegarder';
                        saveBtn.disabled = false; // Re-enable based on controls logic if needed
                        enableDisableControls(); // Re-evaluate button states
                    }, 1500);
                    saveLoader.classList.add('hidden');
                }, 300);
            } catch (e) {
                console.error("Erreur sauvegarde localStorage:", e);
                alert("Erreur lors de la sauvegarde.");
                saveLoader.classList.add('hidden');
                enableDisableControls();
            }
        }

        function loadGrades() {
            const key = getStorageKey();
            const wasClicked = event?.target && event.target.closest('#loadBtn'); // Check if click originated from button

            if (!key) {
                if (wasClicked) alert('Sélectionnez Année, Spécialité et Semestre pour charger.');
                return;
            }

            loadLoader.classList.remove('hidden');
            loadBtn.disabled = true;
            const savedGrades = localStorage.getItem(key);

            setTimeout(() => {
                let loadedSuccessfully = false;
                if (savedGrades) {
                    try {
                        const parsedGrades = JSON.parse(savedGrades);
                        noteForm.querySelectorAll('.module-grade-input').forEach(input => { // Target inputs within noteForm
                             const card = input.closest('.module-card');
                             if (!card) return;
                             const moduleId = card.dataset.moduleId;
                             const type = input.id.split('-').pop();
                             if (!moduleId || !type) return;
                             input.value = parsedGrades?.[moduleId]?.[type] ?? '';
                             validateGradeInput(input); // Validate after setting value
                        });
                        loadedSuccessfully = true;
                        if (wasClicked) {
                             loadBtn.innerHTML = '<i class="fas fa-check"></i> Chargé';
                             setTimeout(() => {
                                 loadBtn.innerHTML = '<i class="fas fa-download"></i> Charger';
                                 enableDisableControls(); // Re-evaluate button states
                             }, 1500);
                         }
                    } catch (e) {
                        console.error("Erreur analyse localStorage:", e);
                        if (wasClicked) alert("Erreur lors du chargement des notes sauvegardées.");
                    }
                } else {
                    if (wasClicked) alert('Aucune note sauvegardée pour cette sélection.');
                    // Clear inputs if nothing was saved for this specific selection
                     noteForm.querySelectorAll('.module-grade-input').forEach(input => {
                         input.value = '';
                         input.classList.remove('input-error');
                          const card = input.closest('.module-card');
                          if (card) calculateModuleAverage(card); // Update display
                     });
                }
                loadLoader.classList.add('hidden');
                if (!wasClicked || !loadedSuccessfully) { // Re-enable immediately if not clicked or failed
                    enableDisableControls();
                }
                // No need to reattach listeners due to event delegation
            }, 300);
        }


        function clearGrades() {
            openModal('clearConfirmModal');
        }

        function confirmClearGrades() {
            noteForm.querySelectorAll('.module-grade-input').forEach(input => { // Target inputs within noteForm
                input.value = '';
                input.classList.remove('input-error');
                const card = input.closest('.module-card');
                if(card) calculateModuleAverage(card);
            });
            resultatsDiv.classList.remove('visible');
            moyenneGeneraleDiv.textContent = '--';
            validationStatusDiv.textContent = '';
            validationStatusDiv.className = 'mt-3 font-medium text-base';
            creditsAttemptedSpan.textContent = 'Crédits Tentés: --';
            creditsValidatedSpan.textContent = 'Crédits Validés: --';
            progressBarFill.style.width = '0%';
            moyenneGeneraleContainer.classList.remove('validated');

            const key = getStorageKey();
            if (key) {
                localStorage.removeItem(key);
                console.log("Cleared saved grades for key:", key);
            }

            clearBtn.innerHTML = '<i class="fas fa-check"></i> Effacé';
            setTimeout(() => {
                clearBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Effacer';
            }, 1500);

            closeModal('clearConfirmModal');
             // No need to reattach listeners
        }

        function clearModuleGrades(moduleId) {
            const card = noteForm.querySelector(`.module-card[data-module-id="${moduleId}"]`); // Target within noteForm
            if (card) {
                card.querySelectorAll('.module-grade-input').forEach(input => {
                    input.value = '';
                    input.classList.remove('input-error');
                });
                 calculateModuleAverage(card);
                 // Optionally show subtle feedback instead of alert
                 const avgDisplay = card.querySelector('.avg-text');
                 if(avgDisplay) {
                     avgDisplay.style.transition = 'color 0.3s ease';
                     avgDisplay.style.color = 'var(--warning-color)'; // Flash yellow
                     setTimeout(() => { avgDisplay.style.color = ''; }, 500); // Revert color
                 }
            }
        }

        // --- "What If" Calculation ---
        function calculateWhatIf() {
            const targetAvgInput = document.getElementById('targetAverage');
            let targetAvg;
            try {
                targetAvg = parseFloat(targetAvgInput.value.replace(',', '.'));
                if (isNaN(targetAvg) || targetAvg < 0 || targetAvg > 20) throw new Error("Invalid range");
                targetAvgInput.classList.remove('input-error');
            } catch (e) {
                targetAvgInput.classList.add('input-error');
                alert('Moyenne cible invalide (entrez une valeur entre 0 et 20).');
                return;
            }

            let weightedSum = 0, totalCoeff = 0, examWeightCoeff = 0;
            let canCalculate = true, missingInputs = false;
            const modulesToFill = [];

            currentModulesData.forEach(module => {
                if (!canCalculate) return;
                const card = noteForm.querySelector(`.module-card[data-module-id="${module.id}"]`);
                if (!card) { canCalculate = false; return; }

                const evals = Array.isArray(module.evaluations) ? module.evaluations : [];
                const coeff = parseFloat(module.coefficient) || 0;
                totalCoeff += coeff;

                const tdInput = card.querySelector(`#${module.id}-td`);
                const tpInput = card.querySelector(`#${module.id}-tp`);
                const examInput = card.querySelector(`#${module.id}-examen`);

                const tdInfo = tdInput ? parseGrade(tdInput.value) : { num: null };
                const tpInfo = tpInput ? parseGrade(tpInput.value) : { num: null };
                const examInfo = examInput ? parseGrade(examInput.value) : { num: null };

                const hasTD = evals.includes('TD');
                const hasTP = evals.includes('TP');
                const hasExam = evals.includes('Examen');

                if ((hasTD && tdInfo.num === null) || (hasTP && tpInfo.num === null)) {
                     missingInputs = true;
                }

                let sumWithoutExam = 0;
                let examWeight = 0;

                if (hasTD && hasTP && hasExam) { sumWithoutExam = (tdInfo.num ?? 0) * 0.2 + (tpInfo.num ?? 0) * 0.2; examWeight = 0.6; }
                else if (hasTP && hasExam) { sumWithoutExam = (tpInfo.num ?? 0) * 0.4; examWeight = 0.6; }
                else if (hasTD && hasExam) { sumWithoutExam = (tdInfo.num ?? 0) * 0.4; examWeight = 0.6; }
                else if (hasExam) { examWeight = 1.0; }
                else { // No exam, contribute its average if possible
                    const moduleAvgResult = calculateModuleAverage(card);
                    if(moduleAvgResult.isValid) { weightedSum += moduleAvgResult.average * coeff; }
                    else { missingInputs = true; } // Treat uncalculable non-exam module as missing input
                    return;
                }

                if (!missingInputs) { // Only add non-exam part if TD/TP were valid (or not present)
                    weightedSum += sumWithoutExam * coeff;
                }

                if (hasExam && examInput) {
                    if (examInfo.num === null) {
                        modulesToFill.push({ card, examInput, examWeight, coeff });
                        examWeightCoeff += examWeight * coeff;
                    } else {
                        weightedSum += examInfo.num * examWeight * coeff; // Add existing exam contribution
                    }
                } else if (hasExam && !examInput) {
                     console.warn(`Exam input missing for module ${module.name}`);
                     canCalculate = false;
                }
            });

            if (missingInputs) { alert('Veuillez entrer toutes les notes valides pour TD et TP avant d\'utiliser le calcul "Et Si?".'); return; }
            if (!canCalculate) { alert('Erreur lors de la préparation du calcul "Et Si?".'); return; }
            if (modulesToFill.length === 0) { alert('Tous les examens sont déjà remplis.'); return; }
            if (examWeightCoeff <= 0) { alert('Erreur: Pondération des examens invalide.'); return; }

            const neededTotalExamWeightedSum = (targetAvg * totalCoeff) - weightedSum;
            const neededExamAvg = neededTotalExamWeightedSum / examWeightCoeff;

            if (neededExamAvg > 20) { alert(`Impossible d’atteindre ${targetAvg.toFixed(2)}. Il faudrait ${neededExamAvg.toFixed(2)}/20 aux examens restants.`); return; }
            if (neededExamAvg < 0) { alert(`Moyenne cible de ${targetAvg.toFixed(2)} déjà atteinte ! Note nécessaire aux examens: ${neededExamAvg.toFixed(2)}/20.`); return; }

            modulesToFill.forEach(({ examInput }) => {
                examInput.value = neededExamAvg.toFixed(2);
                validateGradeInput(examInput);
            });

            alert(`Examens remplis avec ${neededExamAvg.toFixed(2)}/20 pour tenter d'atteindre ${targetAvg.toFixed(2)}.`);
            // Re-calculate main average after filling inputs (optional)
            // calculerMoyenneGenerale();
        }


        // --- Min Exam Grade Calculation ---
        function calculateMinExamGrade(moduleId) {
            const card = noteForm.querySelector(`.module-card[data-module-id="${moduleId}"]`);
            const moduleData = currentModulesData.find(m => m.id === moduleId);

            if (!card || !moduleData) { alert("Module non trouvé."); return; }
            const evals = Array.isArray(moduleData.evaluations) ? moduleData.evaluations : [];
            if (!evals.includes('Examen')) { alert('Pas d’examen défini pour ce module.'); return; }

            const tdInput = card.querySelector(`#${moduleId}-td`);
            const tpInput = card.querySelector(`#${moduleId}-tp`);
            const tdInfo = tdInput ? parseGrade(tdInput.value) : { num: null };
            const tpInfo = tpInput ? parseGrade(tpInput.value) : { num: null };

            const hasTD = evals.includes('TD');
            const hasTP = evals.includes('TP');
            let missingPrerequisites = [];
            if (hasTD && tdInfo.num === null) missingPrerequisites.push('TD');
            if (hasTP && tpInfo.num === null) missingPrerequisites.push('TP');

            if (missingPrerequisites.length > 0) { alert(`Entrez une note valide pour ${missingPrerequisites.join(' et ')}.`); return; }

            let tdWeight = 0, tpWeight = 0, examWeight = 0;
            if (hasTD && hasTP) { tdWeight = 0.2; tpWeight = 0.2; examWeight = 0.6; }
            else if (hasTP) { tpWeight = 0.4; examWeight = 0.6; }
            else if (hasTD) { tdWeight = 0.4; examWeight = 0.6; }
            else { examWeight = 1.0; }

            if (examWeight <= 0) { alert("Erreur: Pondération d'examen invalide."); return; }

            const currentSum = (tdInfo.num ?? 0) * tdWeight + (tpInfo.num ?? 0) * tpWeight;
            const target = Math.max(10, parseFloat(moduleData.noteEliminatoire) || 0);
            const neededExamGrade = (target - currentSum) / examWeight;

            let message = '';
            if (neededExamGrade <= 0) { message = `Module déjà validé (ou validable avec 0). Note nécessaire: ${neededExamGrade.toFixed(2)}/20.`; }
            else if (neededExamGrade > 20) { message = `Validation impossible. Il faudrait <strong>${neededExamGrade.toFixed(2)}/20</strong> à l'examen.`; }
            else { message = `Il vous faut au moins <strong>${neededExamGrade.toFixed(2)}/20</strong> à l'examen pour atteindre ${target}/20.`; }

            document.getElementById('minExamMessage').innerHTML = `<strong>${moduleData.name}</strong><br>${message}`;
            openModal('minExamModal');
        }


        // --- Enable/Disable Controls ---
        function enableDisableControls() {
            const yearSelected = !!anneeSelect.value;
            const specialtySelected = !!specialiteSelect.value;
            const semesterSelected = !!semestreSelect.value;
            const modulesReady = currentModulesData.length > 0;

            const enableActions = yearSelected && specialtySelected && semesterSelected && modulesReady;

            calculateBtn.disabled = !enableActions;
            saveBtn.disabled = !enableActions;
            loadBtn.disabled = !enableActions; // Enable load if selection is complete
            clearBtn.disabled = !enableActions;
            targetAverageInput.disabled = !enableActions;
            document.querySelector('.what-if-btn').disabled = !enableActions;

            // Ensure dropdowns are correctly enabled/disabled based *only* on previous selections
            specialiteSelect.disabled = !yearSelected;
            semestreSelect.disabled = !specialtySelected;
        }


        // --- Event Listeners Setup ---
        anneeSelect.addEventListener('change', () => {
            specialiteSelect.value = ''; // Reset specialty
            semestreSelect.value = '';   // Reset semester
            allModules = [];             // Clear module cache
            populateSpecialiteSelect();  // Trigger update chain
        });
        specialiteSelect.addEventListener('change', () => {
            semestreSelect.value = '';   // Reset semester
            allModules = [];             // Clear module cache
            fetchModules();              // Fetch modules for new specialty
        });
        semestreSelect.addEventListener('change', displayModules); // Display modules for selected semester


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            enableDisableControls(); // Set initial disabled state
            fetchInitialData();
        });
    </script>
</body>

</html>