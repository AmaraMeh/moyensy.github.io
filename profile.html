<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Étudiant - ISET'COM</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcul de Moyenne Université de Bejaia</title>
    <meta name="description" content="Calcul de Moyenne Université de Bejaia">
    <meta name="author" content="Amara Mehdi">
    <meta name="keywords" content="Université de Bejaia, Moyenne, Calcul">
    <meta name="robots" content="index, follow">
    <link rel="icon" type="image/png" href="assets/img/icon.png">
    <meta property="og:url" content="https://amaramehdi.github.io/moyenne-universite-bejaia/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Calcul de Moyenne Université de Bejaia">
    <meta property="og:description" content="Calcul de Moyenne Université de Bejaia">
    <meta property="og:image" content="https://masterpiecer-images.s3.yandex.net/b08e69b27e0b11eeb532aaafe6635749:upscaled">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico">
    <!-- <link rel="stylesheet" href="assets/css/floating-menu.css"> -->
    <style>
    /* Color scheme moved to blue-cyan from teal-green */
    :root {
        --primary-color: #0891b2; /* Cyan-600 */
        --primary-dark: #0e7490; /* Cyan-700 */
        --secondary-color: #3b82f6; /* Blue-500 */
        --secondary-dark: #2563eb; /* Blue-600 */
        --accent-color: #06b6d4; /* Cyan-500 */
        --light-bg: #ecfeff; /* Cyan-50 */
        --light-surface: rgba(236, 254, 255, 0.95); /* Cyan-50 with opacity */
        --text-on-dark: #f0fdfa; /* Cyan-50 */
        --text-on-light: #164e63; /* Cyan-900 */
    }

    body {
        background: linear-gradient(135deg, #cffafe 0%, #67e8f9 100%); /* Cyan-100 to Cyan-300 */
        font-family: 'Poppins', sans-serif;
    }

    .glass-card {
        background: rgba(240, 253, 250, 0.85); /* Cyan-50 with opacity */
        backdrop-filter: blur(12px);
        border: 1px solid rgba(103, 232, 249, 0.3); /* Cyan-300 with opacity */
        border-radius: 1rem;
        box-shadow: 0 8px 32px rgba(6, 182, 212, 0.15); /* Cyan-500 shadow */
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .glass-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(6, 182, 212, 0.25); /* Enhanced Cyan-500 shadow on hover */
    }

    .profile-header {
        background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%) !important;
        border-radius: 0.75rem 0.75rem 0 0;
    }

    .button-primary {
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        color: white;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
    }

    .button-primary:hover {
        background: linear-gradient(to right, var(--primary-dark), var(--secondary-dark));
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 16px rgba(6, 182, 212, 0.4);
    }

    .button-danger {
        background: linear-gradient(135deg, #f87171 0%, #ef4444 100%); /* Red-400 to Red-500 */
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .button-danger:hover {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); /* Red-500 to Red-600 */
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 16px rgba(239, 68, 68, 0.4);
    }

    .info-group {
        background: rgba(240, 253, 250, 0.8); /* Cyan-50 with opacity */
        backdrop-filter: blur(8px);
        border-radius: 0.75rem;
        padding: 1.25rem;
        border: 1px solid rgba(103, 232, 249, 0.2); /* Cyan-300 with opacity */
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.1);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .info-group:hover {
        border-color: rgba(6, 182, 212, 0.4); /* Cyan-500 with opacity */
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(6, 182, 212, 0.15);
    }

    .info-group h3 {
        color: var(--primary-color);
        font-weight: 600;
        letter-spacing: 0.05em;
    }

    #profileCompletionBadge {
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    #profileCompletionBadge.bg-green-100 {
        background-color: rgba(6, 182, 212, 0.25); /* Cyan-500 with opacity */
        color: var(--text-on-light);
    }

    #completeProfileBtn {
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        color: white;
        box-shadow: 0 4px 10px rgba(6, 182, 212, 0.25);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    #completeProfileBtn:hover {
        background: linear-gradient(to right, var(--primary-dark), var(--secondary-dark));
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 15px rgba(6, 182, 212, 0.35);
    }

    /* For the modal */
    #modalContent {
        background: var(--light-surface);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(103, 232, 249, 0.3);
        box-shadow: 0 25px 50px rgba(6, 182, 212, 0.25);
    }

    /* Enhanced animations */
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
            transform: scale(1);
        }
        50% {
            opacity: 0.85;
            transform: scale(1.15);
        }
    }

    /* Better skeleton loader */
    .skeleton {
        background-color: rgba(103, 232, 249, 0.15);
        background: linear-gradient(90deg, 
            rgba(103, 232, 249, 0.15) 25%, 
            rgba(6, 182, 212, 0.25) 50%, 
            rgba(103, 232, 249, 0.15) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.8s infinite;
        border-radius: 4px;
    }
    
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }

    /* Text shadow for better visibility on colored backgrounds */
    .text-on-gradient {
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* Better form inputs */
    .form-input {
        background: rgba(240, 253, 250, 0.9);
        border: 1px solid rgba(6, 182, 212, 0.25);
        transition: all 0.3s ease;
    }
    
    .form-input:focus {
        border-color: rgba(6, 182, 212, 0.7);
        box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);
        background: rgba(240, 253, 250, 1);
    }

    /* Radio button styles */
    .radio-button-label {
        background: rgba(240, 253, 250, 0.9);
        border: 1px solid rgba(6, 182, 212, 0.25);
        transition: all 0.3s ease;
    }

    .peer:checked + .radio-button-label {
        background: rgba(6, 182, 212, 0.15);
        border-color: var(--primary-color);
        color: var(--primary-dark);
    }

    /* Loading blur effect */
    .loading-blur {
        display: none; /* Hide instead of blur */
    }

    /* Loading spinner animation */
    .loading-spinner {
        display: none; /* Hide spinner */
    }

    @keyframes spin {
        to { transform: none; } /* Disable animation */
    }

    /* Loading overlay fade transition */
    #loadingOverlay {
        display: none !important; /* Force hide */
    }

    /* Smooth transitions for student card */
    .student-card-container {
        max-width: 300px;
        width: 100%;
        transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
    }

    /* Loading overlay fade transition */
    #loadingOverlay {
        transition: opacity 0.3s ease;
    }

    /* Feature card hover effects */
    .feature-card {
        border: 1px solid rgba(103, 232, 249, 0.2);
        transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
    }

    .feature-card:hover {
        border-color: rgba(6, 182, 212, 0.5);
        box-shadow: 0 10px 20px rgba(6, 182, 212, 0.15);
    }

    .feature-card:hover .w-12 {
        transform: scale(1.1);
        background-color: rgba(6, 182, 212, 0.2);
    }

    .feature-card .w-12 {
        transition: all 0.3s ease;
    }

    /* Animated icon on hover */
    .feature-card:hover i {
        animation: pulse-gentle 1.5s infinite;
    }

    @keyframes pulse-gentle {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.15);
        }
        100% {
            transform: scale(1);
        }
    }

    /* Glass card styling for popups */
    .glass-card {
        background: rgba(255, 255, 255, 0.85);
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 2rem;
    }
    
    /* Close button styling */
    .close-popup-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background-color: #ef4444;
        color: white;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }
    
    .close-popup-btn:hover {
        background-color: #dc2626;
        transform: scale(1.05);
    }
    
    /* Popup content styling */
    .popup-content {
        max-height: 70vh;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(34, 197, 94, 0.5) rgba(229, 231, 235, 0.5);
    }
    
    .popup-content::-webkit-scrollbar {
        width: 8px;
    }
    
    .popup-content::-webkit-scrollbar-track {
        background: rgba(229, 231, 235, 0.5);
        border-radius: 4px;
    }
    
    .popup-content::-webkit-scrollbar-thumb {
        background: rgba(34, 197, 94, 0.5);
        border-radius: 4px;
    }
    
    .popup-content::-webkit-scrollbar-thumb:hover {
        background: rgba(34, 197, 94, 0.7);
    }
    
    /* Module button styling */
    .module-btn {
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: inline-flex;
        align-items: center;
    }
    
    .module-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.15);
    }
    
    .module-btn:active {
        transform: translateY(0px);
    }
    
    /* Radio button styling */
    .radio-button-label {
        position: relative;
        transition: all 0.3s ease;
    }
    
    .radio-button-label:hover {
        transform: translateY(-2px);
    }
    
    input[type="radio"].peer:checked + .radio-button-label {
        background-color: #f0f9ff;
        border-color: #3b82f6;
        color: #1e40af;
        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
    }
    
    /* Animation for modal appearance */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .glass-card {
        animation: slideIn 0.3s ease-out forwards;
    }
</style>
</head>
<body>
    <!-- Add logo header -->
    <header class="w-full py-4">
        <div class="container mx-auto px-4 flex justify-center md:justify-start items-center">
            <a href="index.html" class="flex items-center gap-2 transition-transform hover:scale-105">
                <img src="assets/img/logo.png" alt="Campus Elkseur Logo" class="h-12">
            </a>
        </div>
    </header>
    
    <!-- Add this profile card container -->
    <div class="container mx-auto px-4 py-8">
        <div class="glass-card max-w-4xl mx-auto overflow-hidden">
            <!-- Profile header section -->
            <div class="profile-header p-8 text-white">
                <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
                    <div class="w-32 h-32 rounded-full bg-white/20 flex items-center justify-center overflow-hidden border-4 border-white/30 shadow-lg">
                        <i class="fas fa-user-graduate text-4xl"></i>
                    </div>
                    <div class="text-center md:text-left">
                        <h1 id="profileName" class="text-3xl font-bold">Chargement...</h1>
                        <p id="studentSpeciality" class="text-lg opacity-90 mt-1">Chargement...</p>
                        <div class="mt-4 flex flex-wrap gap-3 justify-center md:justify-start">
                            <span id="profileCompletionBadge" class="px-3 py-1 rounded-full text-sm font-medium hidden">
                                Profil 0% complet
                            </span>
                            <button id="completeProfileBtn" class="px-4 py-1.5 rounded-full text-sm font-medium flex items-center gap-2">
                                <i class="fas fa-user-edit"></i> Compléter le profil
                            </button>
                            <button id="checkStudentsBtn" class="px-4 py-1.5 rounded-full text-sm font-medium flex items-center gap-2 bg-white/30 hover:bg-white/50 text-white transition-all">
                                <i class="fas fa-users"></i> Liste des étudiants
                            </button>
                            <button id="notificationsBtn" class="px-4 py-1.5 rounded-full text-sm font-medium flex items-center gap-2 bg-white/30 hover:bg-white/50 text-white transition-all relative">
                                <i class="fas fa-bell"></i> Notifications
                                <span id="notificationBadge" class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-red-500 text-white text-xs flex items-center justify-center shadow-md hidden">0</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Profile info section - fix the nesting -->
            <div class="p-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="info-group transform transition hover:scale-105" data-aos="fade-up" data-aos-delay="100">
                        <h3 class="text-sm uppercase text-cyan-700 font-medium mb-2">Matricule</h3>
                        <p id="studentId" class="info-value text-cyan-900 font-medium"></p>
                    </div>
                    <div class="info-group transform transition hover:scale-105" data-aos="fade-up" data-aos-delay="200">
                        <h3 class="text-sm uppercase text-cyan-700 font-medium mb-2">Email</h3>
                        <p id="profileEmail" class="info-value text-cyan-900 font-medium"></p>
                    </div>
                    <div class="info-group transform transition hover:scale-105" data-aos="fade-up" data-aos-delay="300">
                        <h3 class="text-sm uppercase text-cyan-700 font-medium mb-2">Téléphone</h3>
                        <p id="phoneNumber" class="info-value text-cyan-900 font-medium"></p>
                    </div>
                    <div id="residenceInfo" class="info-group transform transition hover:scale-105" data-aos="fade-up" data-aos-delay="400">
                        <h3 class="text-sm uppercase text-cyan-700 font-medium mb-2">Résidence</h3>
                        <p id="residenceValue" class="info-value text-cyan-900 font-medium"></p>
                    </div>
                    <div class="info-group transform transition hover:scale-105" data-aos="fade-up" data-aos-delay="500">
                        <h3 class="text-sm uppercase text-cyan-700 font-medium mb-2">Année académique</h3>
                        <p id="academicYear" class="info-value text-cyan-900 font-medium"></p>
                    </div>
                    <div class="info-group transform transition hover:scale-105" data-aos="fade-up" data-aos-delay="600">
                        <h3 class="text-sm uppercase text-cyan-700 font-medium mb-2">Genre</h3>
                        <p id="gender" class="info-value text-cyan-900 font-medium"></p>
                    </div>
                    <div id="instagramInfo" class="info-group transform transition hover:scale-105" data-aos="fade-up" data-aos-delay="700">
                        <h3 class="text-sm uppercase text-cyan-700 font-medium mb-2">Instagram</h3>
                        <p id="instagramValue" class="info-value text-cyan-900 font-medium flex items-center">
                            <!-- Will be populated with Instagram username or N/A -->
                        </p>
                    </div>
                </div>
                <div class="mt-8 flex justify-end" data-aos="fade-up" data-aos-delay="700">
                    <button id="logoutButton" class="button-danger px-5 py-2 text-white rounded-md flex items-center gap-2 shadow-md font-medium">
                        <i class="fas fa-sign-out-alt"></i> Déconnexion
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Profile Completion Modal -->
    <div id="profileModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden backdrop-filter backdrop-blur-sm transition-all duration-300">
        <div class="max-w-md w-full max-h-[90vh] overflow-y-auto shadow-2xl transform transition-all scale-95 opacity-0 rounded-xl glass-card" id="modalContent">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Finaliser votre profil</h2>
                <button id="closeModalBtn" class="close-popup-btn px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all duration-300 flex items-center gap-2">
                    <i class="fas fa-times"></i><span>Fermer</span>
                </button>
            </div>
            <div class="p-6 bg-white bg-opacity-95 rounded-lg popup-content">
                <form id="profileCompletionForm" class="space-y-5">
                    <!-- Form fields with updated styling -->
                    <div class="mb-4">
                        <label for="wilaya" class="block text-sm font-medium text-gray-800 mb-2">Wilaya</label>
                        <select id="wilaya" name="wilaya" class="form-input w-full px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 border border-gray-300">
                            <option value="">Sélectionner une wilaya</option>
                            <option value="bejaia">Béjaïa</option>
                            <option value="alger">Alger</option>
                            <option value="tizi-ouzou">Tizi-Ouzou</option>
                            <option value="setif">Sétif</option>
                            <option value="autre">Autre</option>
                        </select>
                        <p id="wilayaError" class="mt-1 text-sm text-red-600 hidden"></p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="commune" class="block text-sm font-medium text-gray-800 mb-2">Commune</label>
                        <select id="commune" name="commune" class="form-input w-full px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 border border-gray-300" disabled>
                            <option value="">Sélectionner d'abord une wilaya</option>
                        </select>
                        <p id="communeError" class="mt-1 text-sm text-red-600 hidden"></p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="birthdate" class="block text-sm font-medium text-gray-800 mb-2">Date de naissance</label>
                        <input type="date" id="birthdate" name="birthdate" class="form-input w-full px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 border border-gray-300">
                        <p id="birthdateError" class="mt-1 text-sm text-red-600 hidden"></p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="instagram" class="block text-sm font-medium text-gray-800 mb-2">Instagram (optionnel)</label>
                        <div class="relative rounded-md">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fab fa-instagram text-pink-500"></i>
                            </div>
                            <input type="text" id="instagram" name="instagram" placeholder="nom_utilisateur" class="form-input w-full pl-10 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 border border-gray-300">
                        </div>
                        <p id="instagramError" class="mt-1 text-sm text-red-600 hidden"></p>
                    </div>
                    
                    <!-- Updated gender radio buttons with new styling -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-800 mb-2">Genre</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="relative">
                                <input type="radio" id="gender-male" name="gender" value="Masculin" class="hidden peer" required>
                                <label for="gender-male" class="radio-button-label flex items-center justify-center p-3 text-gray-700 rounded-md cursor-pointer hover:bg-blue-50 transition-all border border-gray-200">
                                    <i class="fas fa-mars mr-2 text-blue-600"></i>
                                    Masculin
                                </label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gender-female" name="gender" value="Féminin" class="hidden peer" required>
                                <label for="gender-female" class="radio-button-label flex items-center justify-center p-3 text-gray-700 rounded-md cursor-pointer hover:bg-pink-50 transition-all border border-gray-200">
                                    <i class="fas fa-venus mr-2 text-pink-500"></i>
                                    Féminin
                                </label>
                            </div>
                        </div>
                        <p id="genderError" class="mt-1 text-sm text-red-600 hidden"></p>
                    </div>

                    <div class="mb-4">
                        <label for="phoneNumber" class="block text-sm font-medium text-gray-800 mb-2">Téléphone</label>
                        <div class="relative rounded-md">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-phone text-green-500"></i>
                            </div>
                            <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="+213 or 0..." class="form-input w-full pl-10 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 border border-gray-300">
                        </div>
                        <p id="phoneNumberError" class="mt-1 text-sm text-red-600 hidden"></p>
                    </div>
                    
                    <div class="flex justify-end pt-2">
                        <button type="submit" class="module-btn bg-blue-500 hover:bg-blue-600 px-5 py-2.5 rounded-md text-white font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transform transition-all hover:scale-105 duration-300 shadow-lg">
                            <i class="fas fa-save mr-2"></i> Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Replace the existing studentsModal div with this more colorful version -->
    <div id="studentsModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden backdrop-filter backdrop-blur-sm transition-all duration-300">
        <div class="max-w-2xl w-full max-h-[80vh] overflow-hidden shadow-xl transform transition-all scale-95 opacity-0 rounded-lg" id="studentsModalContent">
            <!-- Colorful gradient header -->
            <div class="p-4 border-b bg-gradient-to-r from-red-500 via-purple-500 to-blue-500 animate-gradient-x">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-bold text-white text-on-gradient flex items-center">
                        <i class="fas fa-users mr-2"></i> Liste des étudiants
                    </h2>
                    <button id="closeStudentsModalBtn" class="text-white hover:text-pink-100 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Colorful filter options -->
            <div class="p-3 bg-gradient-to-r from-green-50 to-blue-50 border-b border-blue-100">
                <div class="flex flex-wrap items-center gap-2">
                    <span class="text-xs font-medium bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-blue-500">Filtrer par:</span>
                    <div class="flex gap-1">
                        <button id="filterAllBtn" class="px-2 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-blue-500 to-cyan-400 text-white transition-all">
                            Tous
                        </button>
                        <button id="filterSpecialityBtn" class="px-2 py-1 rounded-full text-xs font-medium bg-white border border-cyan-200 text-cyan-700 transition-all">
                            Ma spécialité
                        </button>
                    </div>
                    <div class="ml-auto">
                        <div class="relative">
                            <input type="text" id="searchStudents" placeholder="Rechercher..." class="form-input pl-7 pr-3 py-1 rounded-full text-xs border-cyan-300 focus:border-purple-400">
                            <i class="fas fa-search absolute left-2.5 top-1/2 transform -translate-y-1/2 text-cyan-500 text-xs"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Students list - with colorful cards -->
            <div class="bg-gradient-to-b from-white to-blue-50 backdrop-blur-sm">
                <div class="p-3 overflow-y-auto" style="max-height: 60vh;">
                    <div id="studentsListContainer">
                        <!-- For each student in your list, render something like this -->
                        <div class="student-card-container p-4 bg-white rounded-lg shadow-md mb-4">
                            <h3 class="text-lg font-semibold">John Doe</h3>
                            <p class="text-sm text-gray-600">Speciality - 2ème année</p>
                            <div class="flex gap-3 mt-2">
                                <!-- Other buttons -->
                                <button class="send-message-btn module-btn bg-blue-500 hover:bg-blue-600"
                                    data-userid="STUDENT_UID_HERE">
                                    <i class="fas fa-paper-plane"></i> Message
                                </button>
                            </div>
                        </div>
                        <!-- ... -->
                    </div>
                    <div id="noStudentsMessage" class="hidden py-6 text-center text-gray-500">
                        <i class="fas fa-user-slash mb-2 text-2xl text-gray-400"></i>
                        <p>Aucun étudiant trouvé</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this notifications modal before the script tags -->
    <div id="notificationsModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden backdrop-filter backdrop-blur-sm transition-all duration-300">
        <div class="max-w-md w-full max-h-[80vh] overflow-hidden shadow-xl transform transition-all scale-95 opacity-0 rounded-lg" id="notificationsModalContent">
            <!-- Notifications header with gradient -->
            <div class="p-4 border-b bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 animate-gradient-x">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-bold text-white text-on-gradient flex items-center">
                        <i class="fas fa-bell mr-2"></i> Notifications
                    </h2>
                    <button id="closeNotificationsModalBtn" class="text-white hover:text-pink-100 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Notifications filter tabs -->
            <div class="bg-white border-b border-gray-200">
                <div class="flex">
                    <button id="allNotificationsTab" class="flex-1 py-2 px-4 font-medium text-sm text-center border-b-2 border-pink-500 text-pink-500">
                        Toutes
                    </button>
                    <button id="friendRequestsTab" class="flex-1 py-2 px-4 font-medium text-sm text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Demandes d'amis
                    </button>
                    <button id="messagesTab" class="flex-1 py-2 px-4 font-medium text-sm text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Messages
                    </button>
                </div>
            </div>
            
            <!-- Notifications content -->
            <div class="bg-gradient-to-b from-white to-pink-50 backdrop-blur-sm">
                <div class="overflow-y-auto" style="max-height: 60vh;">
                    <div id="notificationsContainer" class="p-2 space-y-2">
                        <!-- Notifications will be added here -->
                        <div class="skeleton h-16 rounded-md"></div>
                        <div class="skeleton h-16 rounded-md"></div>
                        <div class="skeleton h-16 rounded-md"></div>
                    </div>
                    <div id="noNotificationsMessage" class="hidden py-8 text-center text-gray-500">
                        <i class="fas fa-bell-slash mb-2 text-2xl text-gray-400"></i>
                        <p>Aucune notification</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init();
        document.addEventListener('DOMContentLoaded', function() {
            // Profile completion button click handler
            document.getElementById('completeProfileBtn').addEventListener('click', function(e) {
                e.preventDefault();
                const modal = document.getElementById('profileModal');
                const modalContent = document.getElementById('modalContent');
                
                // Show modal
                modal.classList.remove('hidden');
                
                // Animate content after a small delay
                setTimeout(() => {
                    modalContent.classList.add('scale-100', 'opacity-100');
                    modalContent.classList.remove('scale-95', 'opacity-0');
                }, 50);
            });

            // Close modal button click handler
            document.getElementById('closeModalBtn').addEventListener('click', function(e) {
                e.preventDefault();
                const modal = document.getElementById('profileModal');
                const modalContent = document.getElementById('modalContent');
                
                // Animate content out
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');
                
                // Hide modal after animation completes
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            });

            // Form submission handler
            document.getElementById('profileCompletionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                console.log("Form submitted - validation will happen in the module script");
                // The actual validation and data update happens in the module script
            });

            // Initialize the students modal
        });

        // Add this script to your existing AOS initialization

        AOS.init({
            duration: 800,         // Animation duration (ms)
            easing: 'ease-out-cubic', // Animation easing
            once: false,           // Animation only once
            mirror: true,          // Animation works in both directions
            offset: 50,            // Offset (px) from original trigger point
            delay: 100,            // Default delay for animations
            anchorPlacement: 'top-bottom' // Anchor placement
        });

        // Add this to enhance element entrance animations
        document.querySelectorAll('[data-aos]').forEach((elem, index) => {
            // Add staggered delays to elements
            if (!elem.getAttribute('data-aos-delay')) {
                elem.setAttribute('data-aos-delay', (index % 5) * 100 + 100);
            }
        });

        // Add this to the end of the script section with AOS initialization
        document.querySelectorAll('.feature-card').forEach((card, index) => {
            // Add staggered animation delays to feature cards
            card.setAttribute('data-aos-delay', ((index % 5) * 100) + 50);
        });
    </script>
    <script type="module">
    // Replace the entire script type="module" section 
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { getFirestore, doc, getDoc, updateDoc, collection, getDocs, query, where, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js';

    // Then add these functions to the script section

    // Fetch students from Firestore
    async function fetchStudents() {
        try {
            const studentsQuery = collection(db, 'users');
            const studentsSnapshot = await getDocs(studentsQuery);
            
            const students = [];
            studentsSnapshot.forEach(doc => {
                // Add student data with ID
                students.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            return students;
        } catch (error) {
            console.error('Error fetching students:', error);
            showNotification('error', 'Erreur lors du chargement des étudiants');
            return [];
        }
    }

    // Initialize students modal and functionality
    function initStudentsModal() {
        const currentUser = auth.currentUser;
        let currentUserData = null;
        let allStudents = [];
        
        // Get current user data for filtering
        async function getCurrentUserData() {
            if (!currentUser) return null;
            
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    return userDoc.data();
                }
            } catch (error) {
                console.error('Error fetching current user data:', error);
            }
            return null;
        }
        
        // Update the renderStudents function in the initStudentsModal function
        function renderStudents(students) {
            const container = document.getElementById('studentsListContainer');
            const noStudentsMessage = document.getElementById('noStudentsMessage');
            
            if (!students.length) {
                container.innerHTML = '';
                noStudentsMessage.classList.remove('hidden');
                return;
            }
            
            noStudentsMessage.classList.add('hidden');
            
            // Colorful gradients for student cards (cycling through colors)
            const gradients = [
                'from-cyan-500 to-blue-500',
                'from-blue-500 to-purple-500',
                'from-purple-500 to-pink-500',
                'from-pink-500 to-red-500',
                'from-red-500 to-orange-500',
                'from-orange-500 to-yellow-500',
                'from-yellow-500 to-green-500',
                'from-green-500 to-teal-500',
                'from-teal-500 to-cyan-500'
            ];
            
            container.innerHTML = students.map((student, index) => {
                // Select gradient based on index (cycling through the array)
                const gradient = gradients[index % gradients.length];
                
                return `
                <div class="student-card p-4 bg-white/90 rounded-md border-l-4 border-${gradient.split(' ')[0].replace('from-', '')} hover:-translate-y-1 transition-all duration-300 hover:shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-bl ${gradient} opacity-10 rounded-bl-full"></div>
                    <div class="flex items-center gap-3 relative z-10">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-r ${gradient} flex items-center justify-center text-white text-sm font-bold shadow-md">
                            ${student.fullName ? student.fullName.charAt(0).toUpperCase() : 'U'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-medium text-gray-900 text-sm truncate">${student.fullName || 'Étudiant'}</h3>
                            <p class="text-xs text-gray-700 truncate">${student.speciality || 'Non spécifié'}</p>
                            ${student.instagram ? `
                            <a href="https://instagram.com/${student.instagram}" target="_blank" class="flex items-center text-xs text-pink-600 hover:text-pink-700 transition-colors mt-1">
                                <i class="fab fa-instagram mr-1"></i>${student.instagram}
                            </a>` : ''}
                        </div>
                    </div>
                    
                    <div class="mt-3 pt-3 border-t border-gray-100 flex gap-2">
                        <button class="add-friend-btn flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white text-xs py-1.5 px-2 rounded-md hover:shadow-md transition-all flex items-center justify-center" 
                                data-user-id="${student.id}">
                            <i class="fas fa-user-plus mr-1"></i> Ajouter
                        </button>
                        <button class="send-message-btn flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-xs py-1.5 px-2 rounded-md hover:shadow-md transition-all flex items-center justify-center"
                                data-user-id="${student.id}">
                            <i class="fas fa-paper-plane mr-1"></i> Message
                        </button>
                    </div>
                </div>
                `;
            }).join('');
            
            // Add event listeners to all friend and message buttons
            document.querySelectorAll('.add-friend-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const userId = btn.dataset.userId;
                    sendFriendRequest(userId);
                });
            });
            
            document.querySelectorAll('.send-message-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const userId = btn.dataset.userId;
                    openMessageDialog(userId);
                });
            });
        }

        // Add these functions for friend requests
        async function sendFriendRequest(targetUserId) {
            try {
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    showNotification('error', 'Vous devez être connecté pour envoyer une demande d\'ami');
                    return;
                }
                
                // Check if a request already exists
                const requestStatus = await checkFriendRequestStatus(currentUser.uid, targetUserId);
                
                if (requestStatus === 'sent') {
                    showNotification('error', 'Vous avez déjà envoyé une demande à cet étudiant');
                    return;
                } else if (requestStatus === 'received') {
                    showNotification('error', 'Cet étudiant vous a déjà envoyé une demande');
                    return;
                } else if (requestStatus === 'friends') {
                    showNotification('error', 'Vous êtes déjà ami avec cet étudiant');
                    return;
                }
                
                // Create new friend request
                const friendRequestsRef = collection(db, 'friendRequests');
                await addDoc(friendRequestsRef, {
                    senderId: currentUser.uid,
                    recipientId: targetUserId,
                    status: 'pending',
                    timestamp: serverTimestamp()
                });
                
                showNotification('success', 'Demande d\'ami envoyée avec succès');
                
                // Update button appearance
                const btn = document.querySelector(`.add-friend-btn[data-user-id="${targetUserId}"]`);
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-clock mr-1"></i> En attente';
                    btn.classList.remove('from-green-500', 'to-emerald-600');
                    btn.classList.add('from-yellow-500', 'to-amber-600');
                    btn.disabled = true;
                }
            } catch (error) {
                console.error('Error sending friend request:', error);
                showNotification('error', 'Erreur lors de l\'envoi de la demande d\'ami');
            }
        }
        
        async function checkFriendRequestStatus(userId1, userId2) {
            try {
                // Check if they are already friends
                const friendsRef = doc(db, 'friends', userId1);
                const friendsDoc = await getDoc(friendsRef);
                
                if (friendsDoc.exists() && friendsDoc.data().friendIds && 
                    friendsDoc.data().friendIds.includes(userId2)) {
                    return 'friends';
                }
                
                // Check for pending requests in both directions
                const sentRequestsQuery = query(
                    collection(db, 'friendRequests'),
                    where('senderId', '==', userId1),
                    where('recipientId', '==', userId2),
                    where('status', '==', 'pending')
                );
                
                const receivedRequestsQuery = query(
                    collection(db, 'friendRequests'),
                    where('senderId', '==', userId2),
                    where('recipientId', '==', userId1),
                    where('status', '==', 'pending')
                );
                
                const sentRequests = await getDocs(sentRequestsQuery);
                const receivedRequests = await getDocs(receivedRequestsQuery);
                
                if (!sentRequests.empty) {
                    return 'sent';
                }
                
                if (!receivedRequests.empty) {
                    return 'received';
                }
                
                return 'none';
            } catch (error) {
                console.error('Error checking friend request status:', error);
                return 'error';
            }
        }
        
        // Open the students modal
        document.getElementById('checkStudentsBtn').addEventListener('click', async function() {
            const modal = document.getElementById('studentsModal');
            const modalContent = document.getElementById('studentsModalContent');
            
            // Show modal
            modal.classList.remove('hidden');
            
            // Animate content after a small delay
            setTimeout(() => {
                modalContent.classList.add('scale-100', 'opacity-100');
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 50);
            
            // Show loading state
            const container = document.getElementById('studentsListContainer');
            container.innerHTML = `
                <div class="skeleton h-28 rounded-lg"></div>
                <div class="skeleton h-28 rounded-lg"></div>
                <div class="skeleton h-28 rounded-lg"></div>
            `;
            
            // Fetch current user data and all students
            currentUserData = await getCurrentUserData();
            allStudents = await fetchStudents();
            
            // Render all students initially
            renderStudents(allStudents);
            
            // Set active filter button
            document.getElementById('filterAllBtn').classList.add('bg-cyan-600', 'text-white');
            document.getElementById('filterAllBtn').classList.remove('bg-white', 'border', 'text-cyan-700');
            document.getElementById('filterSpecialityBtn').classList.add('bg-white', 'border', 'border-cyan-200', 'text-cyan-700');
            document.getElementById('filterSpecialityBtn').classList.remove('bg-cyan-600', 'text-white');
        });
        
        // Filter buttons functionality
        document.getElementById('filterAllBtn').addEventListener('click', function() {
            // Update active button state
            this.classList.add('bg-cyan-600', 'text-white');
            this.classList.remove('bg-white', 'border', 'text-cyan-700');
            document.getElementById('filterSpecialityBtn').classList.add('bg-white', 'border', 'border-cyan-200', 'text-cyan-700');
            document.getElementById('filterSpecialityBtn').classList.remove('bg-cyan-600', 'text-white');
            
            // Show all students
            renderStudents(allStudents);
        });
        
        document.getElementById('filterSpecialityBtn').addEventListener('click', function() {
            // Update active button state
            this.classList.add('bg-cyan-600', 'text-white');
            this.classList.remove('bg-white', 'border', 'text-cyan-700');
            document.getElementById('filterAllBtn').classList.add('bg-white', 'border', 'border-cyan-200', 'text-cyan-700');
            document.getElementById('filterAllBtn').classList.remove('bg-cyan-600', 'text-white');
            
            // Filter students by speciality if current user data exists
            if (currentUserData && currentUserData.speciality) {
                const filteredStudents = allStudents.filter(student => 
                    student.speciality === currentUserData.speciality && 
                    student.id !== currentUser.uid // Exclude current user
                );
                renderStudents(filteredStudents);
            } else {
                renderStudents([]);
                showNotification('error', 'Votre spécialité n\'est pas définie dans votre profil');
            }
        });
        
        // Search functionality
        document.getElementById('searchStudents').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            if (searchTerm === '') {
                // If search is cleared, respect current filter
                const showingSpeciality = document.getElementById('filterSpecialityBtn').classList.contains('bg-cyan-600');
                if (showingSpeciality && currentUserData && currentUserData.speciality) {
                    const filteredStudents = allStudents.filter(student => 
                        student.speciality === currentUserData.speciality && 
                        student.id !== currentUser.uid
                    );
                    renderStudents(filteredStudents);
                } else {
                    renderStudents(allStudents);
                }
                return;
            }
            
            // Filter students by search term
            const filteredStudents = allStudents.filter(student => {
                const name = student.fullName || '';
                const speciality = student.speciality || '';
                const instagram = student.instagram || '';
                
                return name.toLowerCase().includes(searchTerm) || 
                       speciality.toLowerCase().includes(searchTerm) ||
                       instagram.toLowerCase().includes(searchTerm);
            });
            
            renderStudents(filteredStudents);
        });
        
        // Close modal button
        document.getElementById('closeStudentsModalBtn').addEventListener('click', function() {
            const modal = document.getElementById('studentsModal');
            const modalContent = document.getElementById('studentsModalContent');
            
            // Animate content out
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            // Hide modal after animation completes
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        });
    }

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyB5XYqWKhHdiVDXJx4iOwtpxD8eUCPRfKU",
        authDomain: "universite-de-bejaia-547fc.firebaseapp.com",
        projectId: "universite-de-bejaia-547fc",
        storageBucket: "universite-de-bejaia-547fc.firebasestorage.app",
        messagingSenderId: "517622731583", 
        appId: "1:517622731583:web:25453d5e01226585bf798a",
        measurementId: "G-SQ0WWSCS7B"
    };

    // Initialize Firebase services
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Commune data
    const communesByWilaya = {
        "bejaia": ["Béjaïa", "Tazmalt", "Akbou", "Sidi-Aïch", "Aokas", "Tichy", "Souk El Ténine", "Amizour", "El Kseur", "Barbacha", "Kherrata", "Oued Ghir", "Boudjellil", "Ifri Ouzellaguen", "Seddouk"],
        "alger": ["Alger Centre", "Bab El Oued", "Bir Mourad Raïs", "Hussein Dey", "Hydra", "Kouba"],
        "tizi-ouzou": ["Tizi-Ouzou", "Azazga", "Tigzirt", "Draâ Ben Khedda", "Aïn El Hammam", "Boghni"],
        "setif": ["Sétif", "El Eulma", "Aïn El Kebira", "Bougaa", "Aïn Oulmene", "Djemila"],
        "autre": ["Autre"]
    };

    // Profile completion percentage calculation (modified to remove academicYear)
    function calculateProfileCompletion(userData) {
        const requiredFields = ['fullName', 'email', 'matricule', 'speciality', 'phoneNumber'];
        const optionalFields = ['wilaya', 'commune', 'birthdate', 'instagram', 'gender'];
        
        let completedRequired = 0;
        requiredFields.forEach(field => {
            if (userData[field]) completedRequired++;
        });
        
        let completedOptional = 0;
        optionalFields.forEach(field => {
            if (userData[field]) completedOptional++;
        });
        
        const requiredPercentage = (completedRequired / requiredFields.length) * 70;
        const optionalPercentage = (completedOptional / optionalFields.length) * 30;
        
        return Math.round(requiredPercentage + optionalPercentage);
    }

    // Loading states with blur effect
    function showLoadingState() {
        // Empty function - loading state removed
        console.log("Loading state disabled");
    }

    function hideLoadingState() {
        // Empty function - loading state removed
        console.log("Hide loading state disabled");
        
        // Remove any existing loading overlays (just in case)
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.remove();
        }
    }

    // Update UI with user data (modified to remove interests)
    function updateUIWithUserData(userData) {
        console.log("Updating UI with user data:", userData);
        hideLoadingState();
        
        if (!userData) {
            console.error("No user data provided to updateUIWithUserData");
            return;
        }
        
        // Update name and basic info
        if (userData.fullName) {
            document.getElementById('profileName').textContent = userData.fullName;
            console.log("Set profile name to:", userData.fullName);
        } else {
            document.getElementById('profileName').textContent = 'N/A';
        }
        
        // Email
        if (userData.email) {
            document.getElementById('profileEmail').textContent = userData.email;
        } else {
            document.getElementById('profileEmail').textContent = 'N/A';
        }
        
        // Matricule
        if (userData.matricule) {
            document.getElementById('studentId').textContent = userData.matricule;
        } else {
            document.getElementById('studentId').textContent = 'N/A';
        }
        
        // Speciality
        let specialityText = userData.speciality || 'N/A';
        if (userData.speciality && userData.year) {
            specialityText += ` - ${userData.year}ème année`;
        }
        document.getElementById('studentSpeciality').textContent = specialityText;
        
        // Other fields
        document.getElementById('phoneNumber').textContent = userData.phoneNumber || 'N/A';
        document.getElementById('academicYear').textContent = userData.academicYear || 'N/A';
        document.getElementById('gender').textContent = userData.gender || 'N/A';

        // Residence info
        if (userData.wilaya && userData.commune) {
            document.getElementById('residenceInfo').classList.remove('hidden');
            document.getElementById('residenceValue').textContent = `${userData.commune}, ${userData.wilaya}`;
        } else {
            document.getElementById('residenceInfo').classList.add('hidden');
        }

        // Instagram info display
        if (userData.instagram) {
            document.getElementById('instagramInfo').classList.remove('hidden');
            const instagramValue = document.getElementById('instagramValue');
            instagramValue.innerHTML = `
                <a href="https://instagram.com/${userData.instagram}" target="_blank" class="flex items-center hover:text-cyan-600 transition-colors">
                    <i class="fab fa-instagram mr-2 text-pink-500"></i>
                    ${userData.instagram}
                    <i class="fas fa-external-link-alt text-xs ml-2 text-cyan-500"></i>
                </a>
            `;
        } else {
            document.getElementById('instagramInfo').classList.add('hidden');
        }

        // Update profile completion badge and button
        const completion = calculateProfileCompletion(userData);
        const badge = document.getElementById('profileCompletionBadge');
        const completeBtn = document.getElementById('completeProfileBtn');
        
        badge.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800', 'bg-green-100', 'text-green-800');
        
        if (completion < 70) {
            badge.textContent = `Profil ${completion}% complet`;
            badge.classList.add('bg-red-100', 'text-red-800');
            completeBtn.innerHTML = '<i class="fas fa-user-edit"></i> Finaliser le profil';
        } else if (completion < 100) {
            badge.textContent = `Profil ${completion}% complet`;
            badge.classList.add('bg-yellow-100', 'text-yellow-800');
            completeBtn.innerHTML = '<i class="fas fa-user-edit"></i> Finaliser le profil';
        } else {
            badge.textContent = `Profil complet`;
            badge.classList.add('bg-green-100', 'text-green-800');
            completeBtn.innerHTML = '<i class="fas fa-user-edit"></i> Modifier le profil';
        }
        
        console.log("UI update completed");
    }

    // Handle wilaya and commune selection
    document.getElementById('wilaya').addEventListener('change', function() {
        const wilayaValue = this.value;
        const communeSelect = document.getElementById('commune');
        
        // Clear current options
        communeSelect.innerHTML = '';
        
        if (wilayaValue) {
            communeSelect.removeAttribute('disabled');
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Sélectionner une commune';
            communeSelect.appendChild(defaultOption);
            
            // Add communes for selected wilaya
            const communes = communesByWilaya[wilayaValue] || [];
            communes.forEach(commune => {
                const option = document.createElement('option');
                option.value = commune.toLowerCase().replace(/ /g, '-');
                option.textContent = commune;
                communeSelect.appendChild(option);
            });
        } else {
            communeSelect.setAttribute('disabled', 'disabled');
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'Sélectionner d\'abord une wilaya';
            communeSelect.appendChild(option);
        }
    });

    // Form validation for Profile Completion (modified to handle radio buttons)
    document.getElementById('profileCompletionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        let isValid = true;
        const wilaya = document.getElementById('wilaya').value;
        const commune = document.getElementById('commune').value;
        const birthdate = document.getElementById('birthdate').value;
        const instagram = document.getElementById('instagram').value;
        const phoneNumber = document.getElementById('phoneNumber').value;
        
        // Get gender from radio buttons instead of select element
        const maleRadio = document.getElementById('gender-male');
        const femaleRadio = document.getElementById('gender-female');
        const gender = maleRadio.checked ? maleRadio.value : (femaleRadio.checked ? femaleRadio.value : '');
        
        // Validate wilaya and commune
        if (!wilaya) {
            document.getElementById('wilayaError').textContent = 'Veuillez sélectionner une wilaya';
            document.getElementById('wilayaError').classList.remove('hidden');
            isValid = false;
        } else {
            document.getElementById('wilayaError').classList.add('hidden');
        }
        
        if (!commune) {
            document.getElementById('communeError').textContent = 'Veuillez sélectionner une commune';
            document.getElementById('communeError').classList.remove('hidden');
            isValid = false;
        } else {
            document.getElementById('communeError').classList.add('hidden');
        }
        
        // Validate birthdate
        if (!birthdate) {
            document.getElementById('birthdateError').textContent = 'Veuillez entrer votre date de naissance';
            document.getElementById('birthdateError').classList.remove('hidden');
            isValid = false;
        } else {
            const date = new Date(birthdate);
            const minDate = new Date('2000-01-01');
            const maxDate = new Date('2009-12-31');
            
            if (date < minDate || date > maxDate) {
                document.getElementById('birthdateError').textContent = 'La date doit être entre 2000 et 2009';
                document.getElementById('birthdateError').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('birthdateError').classList.add('hidden');
            }
        }
        
        // Validate Instagram if provided
        if (instagram) {
            const regex = /^[a-zA-Z0-9_.]{1,30}$/;
            if (!regex.test(instagram)) {
                document.getElementById('instagramError').textContent = 'Format de nom d\'utilisateur Instagram invalide';
                document.getElementById('instagramError').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('instagramError').classList.add('hidden');
            }
        } else {
            document.getElementById('instagramError').classList.add('hidden');
        }

        // Validate gender using radio buttons
        if (!gender) {
            document.getElementById('genderError').textContent = 'Veuillez sélectionner votre genre';
            document.getElementById('genderError').classList.remove('hidden');
            isValid = false;
        } else {
            document.getElementById('genderError').classList.add('hidden');
        }

        // Validate phone number
        if (phoneNumber) {
            const phoneRegex = /^(\+213|0)[567][0-9]{8}$/;
            if (!phoneRegex.test(phoneNumber)) {
                document.getElementById('phoneNumberError').textContent = 'Format de numéro de téléphone invalide';
                document.getElementById('phoneNumberError').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('phoneNumberError').classList.add('hidden');
            }
        }
        
        // If all validations pass, update profile
        if (isValid) {
            try {
                const user = auth.currentUser;
                if (user) {
                    // Show a subtle loading indicator
                    const submitBtn = document.querySelector('#profileCompletionForm button[type="submit"]');
                    const originalBtnText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Enregistrement...';
                    submitBtn.disabled = true;
                    
                    const userRef = doc(db, 'users', user.uid);
                    
                    // Prepare user data update
                    const updateData = {
                        wilaya: wilaya,
                        commune: commune,
                        birthdate: birthdate,
                        gender: gender
                    };
                    
                    if (instagram) {
                        updateData.instagram = instagram;
                    }

                    if (phoneNumber) {
                        updateData.phoneNumber = phoneNumber;
                    }
                    
                    // Update in Firestore
                    await updateDoc(userRef, updateData);
                    console.log("User profile updated in Firestore:", updateData);
                    
                    // Close modal and refresh data
                    const modal = document.getElementById('profileModal');
                    const modalContent = document.getElementById('modalContent');
                    
                    // Animate content out
                    modalContent.classList.remove('scale-100', 'opacity-100');
                    modalContent.classList.add('scale-95', 'opacity-0');
                    
                    // Hide modal after animation completes
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        
                        // Fetch updated user data
                        getDoc(userRef).then((updatedSnap) => {
                            if (updatedSnap.exists()) {
                                updateUIWithUserData(updatedSnap.data());
                            }
                        });
                        
                        // Show success notification instead of alert
                        const notification = document.createElement('div');
                        notification.className = 'fixed top-4 right-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded shadow-md z-50 transform transition-all duration-500 translate-x-full';
                        notification.innerHTML = '<div class="flex items-center"><i class="fas fa-check-circle mr-2"></i> Profil mis à jour avec succès!</div>';
                        document.body.appendChild(notification);
                        
                        // Animate notification
                        setTimeout(() => {
                            notification.classList.remove('translate-x-full');
                        }, 100);
                        
                        // Remove notification after delay
                        setTimeout(() => {
                            notification.classList.add('translate-x-full');
                            setTimeout(() => notification.remove(), 500);
                        }, 4000);
                    }, 300);
                    
                    // Reset button
                    submitBtn.innerHTML = originalBtnText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                
                // Show error notification instead of alert
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-md z-50 transform transition-all duration-500 translate-x-full';
                notification.innerHTML = '<div class="flex items-center"><i class="fas fa-exclamation-circle mr-2"></i> Une erreur est survenue. Veuillez réessayer.</div>';
                document.body.appendChild(notification);
                
                // Animate notification
                setTimeout(() => {
                    notification.classList.remove('translate-x-full');
                }, 100);
                
                // Remove notification after delay
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => notification.remove(), 500);
                }, 4000);
                
                // Reset submit button
                const submitBtn = document.querySelector('#profileCompletionForm button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Enregistrer';
                submitBtn.disabled = false;
            }
        }
    });

    // Initialize page
    async function initializePage() {
        console.log("Starting page initialization...");
        try {
            // Check if user is authenticated
            const user = auth.currentUser;
            
            if (!user) {
                console.log("No authenticated user found, redirecting to login page");
                window.location.href = 'auth.html';
                return;
            }

            console.log("User authenticated:", user.uid);
            
            // Get user document from Firestore
            const userRef = doc(db, 'users', user.uid);
            console.log("Fetching document from:", userRef.path);
            
            const userSnap = await getDoc(userRef);
            
            if (userSnap.exists()) {
                const userData = userSnap.data();
                console.log("User data fetched successfully:", userData);
                
                // Update UI with fetched data
                updateUIWithUserData(userData);
                
                // Populate form fields for the modal
                populateFormFields(userData);
            } else {
                console.log("No user document found in Firestore for ID:", user.uid);
                
                // Create a minimal user object instead of showing an error
                const minimalUserData = {
                    fullName: user.displayName || "Utilisateur",
                    email: user.email || "Non défini",
                    matricule: "Non défini",
                    speciality: "Non défini"
                };
                
                // Update UI with minimal data
                updateUIWithUserData(minimalUserData);
                
                // Start profile completion flow automatically
                setTimeout(() => {
                    document.getElementById('completeProfileBtn')?.click();
                }, 1000);
            }
        } catch (error) {
            console.error('Error fetching user data:', error);
            
            // Create a fallback user object
            const fallbackUserData = {
                fullName: "Erreur de connexion",
                email: "Veuillez rafraîchir la page",
                matricule: "---",
                speciality: "---"
            };
            
            // Update UI with fallback data
            updateUIWithUserData(fallbackUserData);
            
            // Show error notification
            showNotification('error', 'Impossible de charger les données. Veuillez rafraîchir la page.');
            
            // Retry loading after a delay
            setTimeout(() => {
                window.location.reload();
            }, 5000);
        }
    }

    // Helper function to populate form fields
    function populateFormFields(userData) {
        // Only proceed if elements exist
        if (!document.getElementById('wilaya')) {
            console.log("Form elements not found - form might not be loaded yet");
            return;
        }

        console.log("Populating form fields with:", userData);
        
        // Set wilaya and trigger change event to populate communes
        if (userData.wilaya) {
            document.getElementById('wilaya').value = userData.wilaya;
            const event = new Event('change');
            document.getElementById('wilaya').dispatchEvent(event);
            
            // Set commune value after communes are populated
            if (userData.commune) {
                setTimeout(() => {
                    try {
                        const communeSelect = document.getElementById('commune');
                        const communeValue = userData.commune.toLowerCase().replace(/ /g, '-');
                        
                        // Check if option exists before setting
                        const optionExists = Array.from(communeSelect.options).some(option => option.value === communeValue);
                        if (optionExists) {
                            communeSelect.value = communeValue;
                        } else {
                            console.warn(`Commune option ${communeValue} not found in select`);
                        }
                    } catch (e) {
                        console.error("Error setting commune value:", e);
                    }
                }, 300); // Increased timeout to ensure options are loaded
            }
        }
        
        // Set other form fields
        if (userData.birthdate) document.getElementById('birthdate').value = userData.birthdate;
        if (userData.instagram) document.getElementById('instagram').value = userData.instagram;
        
        // Set gender radio buttons correctly
        if (userData.gender) {
            const maleRadio = document.getElementById('gender-male');
            const femaleRadio = document.getElementById('gender-female');
            
            if (userData.gender === 'Masculin' && maleRadio) {
                maleRadio.checked = true;
            } else if (userData.gender === 'Féminin' && femaleRadio) {
                femaleRadio.checked = true;
            }
        }
        
        // Set phone number
        if (userData.phoneNumber) document.getElementById('phoneNumber').value = userData.phoneNumber;
    }

    // Handle logout with better error handling
    document.getElementById('logoutButton').addEventListener('click', async () => {
        console.log("Logout button clicked");
        try {
            // Sign out from Firebase
            await signOut(auth);
            console.log("User signed out successfully");
            
            // Clear any local storage data
            localStorage.removeItem('userData');
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            
            // Redirect to auth page
            window.location.href = 'auth.html';
        } catch (error) {
            console.error('Error during logout:', error);
            alert('Une erreur est survenue lors de la déconnexion. Veuillez réessayer.');
        }
    });

    // Ensure DOM is ready before trying to access elements
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM content loaded, checking Firebase initialization...");
        
        // Add safe event listener function that checks if element exists
        function addSafeEventListener(selector, eventType, callback) {
            const element = document.getElementById(selector);
            if (element) {
                element.addEventListener(eventType, callback);
            } else {
                console.warn(`Element with ID '${selector}' not found in the DOM`);
            }
        }
        
        // Profile completion button
        addSafeEventListener('completeProfileBtn', 'click', function(e) {
            e.preventDefault();
            const modal = document.getElementById('profileModal');
            const modalContent = document.getElementById('modalContent');
            
            if (modal && modalContent) {
                // Show modal
                modal.classList.remove('hidden');
                
                // Animate content after a small delay
                setTimeout(() => {
                    modalContent.classList.add('scale-100', 'opacity-100');
                    modalContent.classList.remove('scale-95', 'opacity-0');
                }, 50);
            }
        });

        // Close modal button
        addSafeEventListener('closeModalBtn', 'click', function(e) {
            e.preventDefault();
            const modal = document.getElementById('profileModal');
            const modalContent = document.getElementById('modalContent');
            
            if (modal && modalContent) {
                // Animate content out
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');
                
                // Hide modal after animation completes
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        });

        // Form submission handler 
        addSafeEventListener('profileCompletionForm', 'submit', function(e) {
            e.preventDefault();
            console.log("Form submitted - validation will happen in the module script");
        });
    });

    // Add this at the end of your script to ensure immediate auth check

    // Check authentication status immediately when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        // Check if we need to wait for Firebase to initialize
        if (auth) {
            // Firebase is already initialized, check auth state
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in, initialize the page
                    initializePage();
                } else {
                    // No user is signed in, redirect to auth
                    console.log("No user is signed in, redirecting to auth.html");
                    window.location.href = 'auth.html';
                }
            });
        } else {
            console.log("Firebase Auth not yet initialized");
            // Could add a retry mechanism here if needed
        }
    });

    // Replace the auth check code at the bottom of the script

    // Wait for both DOM and Firebase to be ready before initializing
    function initWhenReady() {
        // Check if both DOM is ready and Firebase Auth is available
        if (document.readyState === 'complete') {
            console.log("DOM is ready, checking Firebase Auth");
            
            // Give Firebase more time to initialize if needed
            if (typeof auth === 'undefined') {
                console.log("Firebase Auth not yet available, retrying...");
                setTimeout(initWhenReady, 500); // Increased timeout for Firebase initialization
                return;
            }
            
            console.log("Firebase Auth is available, checking authentication");
            
            // Check authentication state
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("User is authenticated:", user.uid);
                    initializePage();
                } else {
                    console.log("No authenticated user, redirecting to auth.html");
                    window.location.href = 'auth.html';
                }
            });
        } else {
            // Wait for DOM to be ready
            console.log("DOM not yet ready, waiting...");
            setTimeout(initWhenReady, 100);
        }
    }

    // Start the initialization process
    initWhenReady();

    // Remove duplicate event listeners and initialization code
    // Remove these sections:
    // - The duplicate DOMContentLoaded event listener that calls checkFirebaseAuth
    // - The duplicate form submission handler

    // Add this function to the module section if not already there

    // Helper function to show notifications
    function showNotification(type, message) {
        const notificationClass = type === 'success' ? 
            'bg-green-100 border-green-500 text-green-700' : 
            'bg-red-100 border-red-500 text-red-700';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 ${notificationClass} border-l-4 p-4 rounded shadow-md z-50 transform transition-all duration-500 translate-x-full`;
        notification.innerHTML = `<div class="flex items-center"><i class="fas ${icon} mr-2"></i> ${message}</div>`;
        document.body.appendChild(notification);
        
        // Animate notification
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);
        
        // Remove notification after delay
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => notification.remove(), 500);
        }, 4000);
    }

    // Initialize students modal
    initStudentsModal();
</script>
<script>
    // Add this to your existing script section
    document.addEventListener('DOMContentLoaded', function() {
        // Profile completion button click handler
        document.getElementById('completeProfileBtn').addEventListener('click', function(e) {
            e.preventDefault();
            const modal = document.getElementById('profileModal');
            const modalContent = document.getElementById('modalContent');
            
            // Show modal
            modal.classList.remove('hidden');
            
            // Animate content after a small delay
            setTimeout(() => {
                modalContent.classList.add('scale-100', 'opacity-100');
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 50);
        });

        // Close modal button click handler
        document.getElementById('closeModalBtn').addEventListener('click', function(e) {
            e.preventDefault();
            const modal = document.getElementById('profileModal');
            const modalContent = document.getElementById('modalContent');
            
            // Animate content out
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            // Hide modal after animation completes
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        });
        
        // Close modal when clicking outside
        document.getElementById('profileModal').addEventListener('click', function(e) {
            if (e.target === this) {
                const modalContent = document.getElementById('modalContent');
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');
                
                setTimeout(() => {
                    this.classList.add('hidden');
                }, 300);
            }
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Listen for clicks on any message button
        document.querySelectorAll('.send-message-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                const targetUserId = this.getAttribute('data-userid');
                // Navigate to chatting.html with the targetUserId as a URL parameter
                window.location.href = `chatting.html?userId=${targetUserId}`;
            });
        });
    });
</script>
</body>
</html>