<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Étudiant - ISET'COM</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcul de Moyenne Université de Bejaia</title>
    <meta name="description" content="Calcul de Moyenne Université de Bejaia">
    <meta name="author" content="Amara Mehdi">
    <meta name="keywords" content="Université de Bejaia, Moyenne, Calcul">
    <meta name="robots" content="index, follow">
    <link rel="icon" type="image/png" href="assets/img/icon.png">
    <meta property="og:url" content="https://amaramehdi.github.io/moyenne-universite-bejaia/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Calcul de Moyenne Université de Bejaia">
    <meta property="og:description" content="Calcul de Moyenne Université de Bejaia">
    <meta property="og:image" content="https://masterpiecer-images.s3.yandex.net/b08e69b27e0b11eeb532aaafe6635749:upscaled">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico">
    <!-- <link rel="stylesheet" href="assets/css/floating-menu.css"> -->
    <style>
    /* Color scheme moved to blue-cyan from teal-green */
    :root {
        --primary-color: #0891b2; /* Cyan-600 */
        --primary-dark: #0e7490; /* Cyan-700 */
        --secondary-color: #3b82f6; /* Blue-500 */
        --secondary-dark: #2563eb; /* Blue-600 */
        --accent-color: #06b6d4; /* Cyan-500 */
        --light-bg: #ecfeff; /* Cyan-50 */
        --light-surface: rgba(236, 254, 255, 0.95); /* Cyan-50 with opacity */
        --text-on-dark: #f0fdfa; /* Cyan-50 */
        --text-on-light: #164e63; /* Cyan-900 */
    }

    body {
        background: linear-gradient(135deg, #cffafe 0%, #67e8f9 100%); /* Cyan-100 to Cyan-300 */
        font-family: 'Poppins', sans-serif;
    }

    .glass-card {
        background: rgba(240, 253, 250, 0.85); /* Cyan-50 with opacity */
        backdrop-filter: blur(12px);
        border: 1px solid rgba(103, 232, 249, 0.3); /* Cyan-300 with opacity */
        border-radius: 1rem;
        box-shadow: 0 8px 32px rgba(6, 182, 212, 0.15); /* Cyan-500 shadow */
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .glass-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(6, 182, 212, 0.25); /* Enhanced Cyan-500 shadow on hover */
    }

    .profile-header {
        background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%) !important;
        border-radius: 0.75rem 0.75rem 0 0;
    }

    .button-primary {
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        color: white;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
    }

    .button-primary:hover {
        background: linear-gradient(to right, var(--primary-dark), var(--secondary-dark));
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 16px rgba(6, 182, 212, 0.4);
    }

    .button-danger {
        background: linear-gradient(135deg, #f87171 0%, #ef4444 100%); /* Red-400 to Red-500 */
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .button-danger:hover {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); /* Red-500 to Red-600 */
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 16px rgba(239, 68, 68, 0.4);
    }

    .info-group {
        background: rgba(240, 253, 250, 0.8); /* Cyan-50 with opacity */
        backdrop-filter: blur(8px);
        border-radius: 0.75rem;
        padding: 1.25rem;
        border: 1px solid rgba(103, 232, 249, 0.2); /* Cyan-300 with opacity */
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.1);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .info-group:hover {
        border-color: rgba(6, 182, 212, 0.4); /* Cyan-500 with opacity */
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(6, 182, 212, 0.15);
    }

    .info-group h3 {
        color: var(--primary-color);
        font-weight: 600;
        letter-spacing: 0.05em;
    }

    #profileCompletionBadge {
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    #profileCompletionBadge.bg-green-100 {
        background-color: rgba(6, 182, 212, 0.25); /* Cyan-500 with opacity */
        color: var(--text-on-light);
    }

    #completeProfileBtn {
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        color: white;
        box-shadow: 0 4px 10px rgba(6, 182, 212, 0.25);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    #completeProfileBtn:hover {
        background: linear-gradient(to right, var(--primary-dark), var(--secondary-dark));
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 15px rgba(6, 182, 212, 0.35);
    }

    /* For the modal */
    #modalContent {
        background: var(--light-surface);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(103, 232, 249, 0.3);
        box-shadow: 0 25px 50px rgba(6, 182, 212, 0.25);
    }

    /* Enhanced animations */
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
            transform: scale(1);
        }
        50% {
            opacity: 0.85;
            transform: scale(1.15);
        }
    }

    /* Better skeleton loader */
    .skeleton {
        background-color: rgba(103, 232, 249, 0.15);
        background: linear-gradient(90deg, 
            rgba(103, 232, 249, 0.15) 25%, 
            rgba(6, 182, 212, 0.25) 50%, 
            rgba(103, 232, 249, 0.15) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.8s infinite;
        border-radius: 4px;
    }
    
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }

    /* Text shadow for better visibility on colored backgrounds */
    .text-on-gradient {
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* Better form inputs */
    .form-input {
        background: rgba(240, 253, 250, 0.9);
        border: 1px solid rgba(6, 182, 212, 0.25);
        transition: all 0.3s ease;
    }
    
    .form-input:focus {
        border-color: rgba(6, 182, 212, 0.7);
        box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);
        background: rgba(240, 253, 250, 1);
    }

    /* Radio button styles */
    .radio-button-label {
        background: rgba(240, 253, 250, 0.9);
        border: 1px solid rgba(6, 182, 212, 0.25);
        transition: all 0.3s ease;
    }

    .peer:checked + .radio-button-label {
        background: rgba(6, 182, 212, 0.15);
        border-color: var(--primary-color);
        color: var(--primary-dark);
    }
</style>
</head>
<body class="flex flex-col min-h-screen bg-gray-50" data-aos-easing="ease-out-cubic">
    <header class="mb-12 mt-8" data-aos="fade-down">
        <div class="header-container flex justify-center items-center px-4 py-6">
            <img src="assets/img/LOGO.png" alt="ISET'COM" class="max-w-[150px]">
        </div>
    </header>

    <!-- Main Profile Content -->
    <main class="flex-grow container mx-auto px-4 pb-12">
        <!-- Profile Card -->
        <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden transform transition-all duration-300 hover:shadow-xl" data-aos="fade-up">
            <!-- Profile Header - Updated with gradient background -->
            <div class="profile-header p-8 flex flex-col md:flex-row items-center gap-6" data-aos="fade-down" data-aos-duration="800">
                <div class="avatar-container relative" data-aos="zoom-in" data-aos-delay="300">
                    <div class="w-32 h-32 rounded-full bg-white overflow-hidden flex items-center justify-center border-4 border-cyan-100 shadow-inner">
                        <img id="userAvatar" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0iY3VycmVudENvbG9yIj48cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0xMCAyYTQgNCAwIDEwMCA4IDQgNCAwIDAwMC04em0wIDEwYTYgNiAwIDEwMC0xMiA2IDYgMCAwMDAgMTJ6bTAgMmE4IDggMCAxMTAtMTYgOCA4IDAgMDEwIDE2eiIgY2xpcC1ydWxlPSJldmVub2RkIi8+PHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBkPSJNMTAgMTIuNWE1LjUgNS41IDAgMTEwIDExIDUuNSA1LjUgMCAwMTAtMTF6bTcgNS41YTcgNyAwIDExLTE0IDAgNyA3IDAgMDE3LTcgNyA3IDAgMDE3IDd6IiBjbGlwLXJ1bGU9ImV2ZW5vZGQiLz48L3N2Zz4=" alt="Photo de profil" class="w-full h-full object-cover">
                        <div id="avatarOverlay" class="absolute inset-0 bg-black bg-opacity-40 opacity-0 hover:opacity-100 transition-opacity flex items-center justify-center cursor-pointer">
                            <i class="fas fa-camera text-white text-2xl"></i>
                        </div>
                    </div>
                    <input type="file" id="avatarUpload" accept="image/*" class="hidden">
                    <p class="avatar-hint text-cyan-50 mt-2 opacity-90 text-shadow">JPEG, PNG ou GIF • Max 2MB</p>
                </div>
                <div class="text-center md:text-left" data-aos="fade-up" data-aos-delay="400">
                    <h1 class="text-2xl md:text-3xl font-bold text-cyan-50 text-on-gradient">
                        <span id="profileName" class="info-value skeleton"></span>
                        <span id="verifiedCheckmark" class="verified-checkmark text-cyan-50 hidden">
                            <i class="fas fa-check-circle"></i>
                        </span>
                    </h1>
                    <p class="text-cyan-100 mb-4"><span id="studentSpeciality" class="info-value skeleton"></span></p>
                    <div class="flex flex-wrap items-center gap-3 mt-3">
                        <span id="profileCompletionBadge" class="px-3 py-1 text-xs font-medium rounded-full bg-cyan-700 bg-opacity-25 text-cyan-50 backdrop-filter backdrop-blur-sm border border-cyan-200 border-opacity-30">Profil à 80% complet</span>
                        <button id="completeProfileBtn" class="px-4 py-2 rounded-md text-sm transition-all flex items-center gap-2 font-medium">
                            <i class="fas fa-user-edit"></i> Finaliser le profil
                        </button>
                    </div>
                </div>
            </div>

            <!-- Profile Info - Updated with better spacing and style -->
            <div class="p-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="info-group transform transition hover:scale-105" data-aos="fade-up" data-aos-delay="100">
                        <h3 class="text-sm uppercase text-cyan-700 font-medium mb-2">Matricule</h3>
                        <p id="studentId" class="info-value skeleton text-cyan-900 font-medium"></p>
                    </div>
                    <div class="info-group transform transition hover:scale-105" data-aos="fade-up" data-aos-delay="200">
                        <h3 class="text-sm uppercase text-cyan-700 font-medium mb-2">Email</h3>
                        <p id="profileEmail" class="info-value skeleton text-cyan-900 font-medium"></p>
                    </div>
                    <div class="info-group transform transition hover:scale-105" data-aos="fade-up" data-aos-delay="300">
                        <h3 class="text-sm uppercase text-cyan-700 font-medium mb-2">Téléphone</h3>
                        <p id="phoneNumber" class="info-value skeleton text-cyan-900 font-medium"></p>
                    </div>
                    <div id="residenceInfo" class="info-group transform transition hover:scale-105" data-aos="fade-up" data-aos-delay="400">
                        <h3 class="text-sm uppercase text-cyan-700 font-medium mb-2">Résidence</h3>
                        <p id="residenceValue" class="info-value skeleton text-cyan-900 font-medium"></p>
                    </div>
                    <div class="info-group transform transition hover:scale-105" data-aos="fade-up" data-aos-delay="500">
                        <h3 class="text-sm uppercase text-cyan-700 font-medium mb-2">Année académique</h3>
                        <p id="academicYear" class="info-value skeleton text-cyan-900 font-medium"></p>
                    </div>
                    <div class="info-group transform transition hover:scale-105" data-aos="fade-up" data-aos-delay="600">
                        <h3 class="text-sm uppercase text-cyan-700 font-medium mb-2">Genre</h3>
                        <p id="gender" class="info-value skeleton text-cyan-900 font-medium"></p>
                    </div>
                </div>
                <div class="mt-8 flex justify-end" data-aos="fade-up" data-aos-delay="700">
                    <button id="logoutButton" class="button-danger px-5 py-2 text-white rounded-md flex items-center gap-2 shadow-md font-medium">
                        <i class="fas fa-sign-out-alt"></i> Déconnexion
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Profile Completion Modal -->
    <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden backdrop-filter backdrop-blur-sm transition-all duration-300">
        <div class="max-w-md w-full max-h-[90vh] overflow-y-auto shadow-2xl transform transition-all scale-95 opacity-0 rounded-xl" id="modalContent">
            <div class="p-6 border-b bg-gradient-to-r from-cyan-600 to-blue-500">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-white text-on-gradient">Finaliser votre profil</h2>
                    <button id="closeModalBtn" class="text-white hover:text-cyan-100 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 bg-cyan-50 bg-opacity-95">
                <form id="profileCompletionForm" class="space-y-5">
                    <!-- Form fields with updated styling -->
                    <div class="mb-4">
                        <label for="wilaya" class="block text-sm font-medium text-cyan-900 mb-2">Wilaya</label>
                        <select id="wilaya" name="wilaya" class="form-input w-full px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                            <option value="">Sélectionner une wilaya</option>
                            <option value="bejaia">Béjaïa</option>
                            <option value="alger">Alger</option>
                            <option value="tizi-ouzou">Tizi-Ouzou</option>
                            <option value="setif">Sétif</option>
                            <option value="autre">Autre</option>
                        </select>
                        <p id="wilayaError" class="mt-1 text-sm text-red-600 hidden"></p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="commune" class="block text-sm font-medium text-cyan-900 mb-2">Commune</label>
                        <select id="commune" name="commune" class="form-input w-full px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" disabled>
                            <option value="">Sélectionner d'abord une wilaya</option>
                        </select>
                        <p id="communeError" class="mt-1 text-sm text-red-600 hidden"></p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="birthdate" class="block text-sm font-medium text-cyan-900 mb-2">Date de naissance</label>
                        <input type="date" id="birthdate" name="birthdate" class="form-input w-full px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                        <p id="birthdateError" class="mt-1 text-sm text-red-600 hidden"></p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="instagram" class="block text-sm font-medium text-cyan-900 mb-2">Instagram (optionnel)</label>
                        <div class="relative rounded-md">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fab fa-instagram text-cyan-500"></i>
                            </div>
                            <input type="text" id="instagram" name="instagram" placeholder="nom_utilisateur" class="form-input w-full pl-10 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                        </div>
                        <p id="instagramError" class="mt-1 text-sm text-red-600 hidden"></p>
                    </div>
                    
                    <!-- Updated gender radio buttons with new styling -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-cyan-900 mb-2">Genre</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="relative">
                                <input type="radio" id="gender-male" name="gender" value="Masculin" class="hidden peer" required>
                                <label for="gender-male" class="radio-button-label flex items-center justify-center p-3 text-cyan-700 rounded-md cursor-pointer hover:bg-cyan-100 transition-all">
                                    <i class="fas fa-mars mr-2"></i>
                                    Masculin
                                </label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gender-female" name="gender" value="Féminin" class="hidden peer" required>
                                <label for="gender-female" class="radio-button-label flex items-center justify-center p-3 text-cyan-700 rounded-md cursor-pointer hover:bg-cyan-100 transition-all">
                                    <i class="fas fa-venus mr-2"></i>
                                    Féminin
                                </label>
                            </div>
                        </div>
                        <p id="genderError" class="mt-1 text-sm text-red-600 hidden"></p>
                    </div>

                    <div class="mb-4">
                        <label for="phoneNumber" class="block text-sm font-medium text-cyan-900 mb-2">Téléphone</label>
                        <div class="relative rounded-md">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-phone text-cyan-500"></i>
                            </div>
                            <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="+213 or 0..." class="form-input w-full pl-10 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                        </div>
                        <p id="phoneNumberError" class="mt-1 text-sm text-red-600 hidden"></p>
                    </div>
                    
                    <div class="flex justify-end pt-2">
                        <button type="submit" class="button-primary px-5 py-2.5 rounded-md text-white font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 transform transition-all hover:scale-105 duration-300 shadow-lg">
                            <i class="fas fa-save mr-2"></i> Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init();
        document.addEventListener('DOMContentLoaded', function() {
            // Profile completion button click handler
            document.getElementById('completeProfileBtn').addEventListener('click', function(e) {
                e.preventDefault();
                const modal = document.getElementById('profileModal');
                const modalContent = document.getElementById('modalContent');
                
                // Show modal
                modal.classList.remove('hidden');
                
                // Animate content after a small delay
                setTimeout(() => {
                    modalContent.classList.add('scale-100', 'opacity-100');
                    modalContent.classList.remove('scale-95', 'opacity-0');
                }, 50);
            });

            // Close modal button click handler
            document.getElementById('closeModalBtn').addEventListener('click', function(e) {
                e.preventDefault();
                const modal = document.getElementById('profileModal');
                const modalContent = document.getElementById('modalContent');
                
                // Animate content out
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');
                
                // Hide modal after animation completes
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            });

            // Avatar upload click handler
            document.getElementById('avatarOverlay').addEventListener('click', function() {
                document.getElementById('avatarUpload').click();
            });

            // Avatar upload change handler
            document.getElementById('avatarUpload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('userAvatar').src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Form submission handler
            document.getElementById('profileCompletionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                console.log("Form submitted - validation will happen in the module script");
                // The actual validation and data update happens in the module script
            });
        });

        // Add this script to your existing AOS initialization

        AOS.init({
            duration: 800,         // Animation duration (ms)
            easing: 'ease-out-cubic', // Animation easing
            once: false,           // Animation only once
            mirror: true,          // Animation works in both directions
            offset: 50,            // Offset (px) from original trigger point
            delay: 100,            // Default delay for animations
            anchorPlacement: 'top-bottom' // Anchor placement
        });

        // Add this to enhance element entrance animations
        document.querySelectorAll('[data-aos]').forEach((elem, index) => {
            // Add staggered delays to elements
            if (!elem.getAttribute('data-aos-delay')) {
                elem.setAttribute('data-aos-delay', (index % 5) * 100 + 100);
            }
        });
    </script>
    <script type="module">
    // Replace the entire script type="module" section 
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { getFirestore, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js';
    
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyB5XYqWKhHdiVDXJx4iOwtpxD8eUCPRfKU",
        authDomain: "universite-de-bejaia-547fc.firebaseapp.com",
        projectId: "universite-de-bejaia-547fc",
        storageBucket: "universite-de-bejaia-547fc.firebasestorage.app",
        messagingSenderId: "517622731583", 
        appId: "1:517622731583:web:25453d5e01226585bf798a",
        measurementId: "G-SQ0WWSCS7B"
    };

    // Initialize Firebase services
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Commune data
    const communesByWilaya = {
        "bejaia": ["Béjaïa", "Tazmalt", "Akbou", "Sidi-Aïch", "Aokas", "Tichy", "Souk El Ténine", "Amizour", "El Kseur", "Barbacha", "Kherrata", "Oued Ghir", "Boudjellil", "Ifri Ouzellaguen", "Seddouk"],
        "alger": ["Alger Centre", "Bab El Oued", "Bir Mourad Raïs", "Hussein Dey", "Hydra", "Kouba"],
        "tizi-ouzou": ["Tizi-Ouzou", "Azazga", "Tigzirt", "Draâ Ben Khedda", "Aïn El Hammam", "Boghni"],
        "setif": ["Sétif", "El Eulma", "Aïn El Kebira", "Bougaa", "Aïn Oulmene", "Djemila"],
        "autre": ["Autre"]
    };

    // Profile completion percentage calculation (modified to remove academicYear)
    function calculateProfileCompletion(userData) {
        const requiredFields = ['fullName', 'email', 'matricule', 'speciality', 'phoneNumber'];
        const optionalFields = ['wilaya', 'commune', 'birthdate', 'instagram', 'gender'];
        
        let completedRequired = 0;
        requiredFields.forEach(field => {
            if (userData[field]) completedRequired++;
        });
        
        let completedOptional = 0;
        optionalFields.forEach(field => {
            if (userData[field]) completedOptional++;
        });
        
        const requiredPercentage = (completedRequired / requiredFields.length) * 70;
        const optionalPercentage = (completedOptional / optionalFields.length) * 30;
        
        return Math.round(requiredPercentage + optionalPercentage);
    }

    // Loading states
    function showLoadingState() {
        document.querySelectorAll('.info-value').forEach(el => {
            el.classList.add('skeleton');
            el.style.height = '20px';
            el.style.width = '150px';
            el.textContent = '';
        });
        
        // Hide the buttons and badges during loading
        if (document.getElementById('profileCompletionBadge')) {
            document.getElementById('profileCompletionBadge').classList.add('hidden');
        }
        
        if (document.getElementById('completeProfileBtn')) {
            document.getElementById('completeProfileBtn').classList.add('hidden');
        }
    }

    function hideLoadingState() {
        document.querySelectorAll('.info-value').forEach(el => {
            el.classList.remove('skeleton');
            el.style.height = '';
            el.style.width = '';
        });
        
        // Show the buttons and badges after loading
        if (document.getElementById('profileCompletionBadge')) {
            document.getElementById('profileCompletionBadge').classList.remove('hidden');
        }
        
        if (document.getElementById('completeProfileBtn')) {
            document.getElementById('completeProfileBtn').classList.remove('hidden');
        }
    }

    // Update UI with user data (modified to remove interests)
    function updateUIWithUserData(userData) {
        console.log("Updating UI with user data:", userData);
        hideLoadingState();
        
        if (!userData) {
            console.error("No user data provided to updateUIWithUserData");
            return;
        }
        
        // Update name and basic info
        if (userData.fullName) {
            document.getElementById('profileName').textContent = userData.fullName;
            console.log("Set profile name to:", userData.fullName);
        } else {
            document.getElementById('profileName').textContent = 'N/A';
        }
        
        // Email
        if (userData.email) {
            document.getElementById('profileEmail').textContent = userData.email;
        } else {
            document.getElementById('profileEmail').textContent = 'N/A';
        }
        
        // Matricule
        if (userData.matricule) {
            document.getElementById('studentId').textContent = userData.matricule;
        } else {
            document.getElementById('studentId').textContent = 'N/A';
        }
        
        // Speciality
        let specialityText = userData.speciality || 'N/A';
        if (userData.speciality && userData.year) {
            specialityText += ` - ${userData.year}ème année`;
        }
        document.getElementById('studentSpeciality').textContent = specialityText;
        
        // Other fields
        document.getElementById('phoneNumber').textContent = userData.phoneNumber || 'N/A';
        document.getElementById('academicYear').textContent = userData.academicYear || 'N/A';
        document.getElementById('gender').textContent = userData.gender || 'N/A';

        // Residence info
        if (userData.wilaya && userData.commune) {
            document.getElementById('residenceInfo').classList.remove('hidden');
            document.getElementById('residenceValue').textContent = `${userData.commune}, ${userData.wilaya}`;
        } else {
            document.getElementById('residenceInfo').classList.add('hidden');
        }

        // Avatar
        if (userData.avatarURL) {
            document.getElementById('userAvatar').src = userData.avatarURL;
        } else {
            document.getElementById('userAvatar').src = 'assets/img/default-avatar.png';
        }

        // Update profile completion badge and button
        const completion = calculateProfileCompletion(userData);
        const badge = document.getElementById('profileCompletionBadge');
        const completeBtn = document.getElementById('completeProfileBtn');
        
        badge.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800', 'bg-green-100', 'text-green-800');
        
        if (completion < 70) {
            badge.textContent = `Profil ${completion}% complet`;
            badge.classList.add('bg-red-100', 'text-red-800');
            completeBtn.innerHTML = '<i class="fas fa-user-edit"></i> Finaliser le profil';
        } else if (completion < 100) {
            badge.textContent = `Profil ${completion}% complet`;
            badge.classList.add('bg-yellow-100', 'text-yellow-800');
            completeBtn.innerHTML = '<i class="fas fa-user-edit"></i> Finaliser le profil';
        } else {
            badge.textContent = `Profil complet`;
            badge.classList.add('bg-green-100', 'text-green-800');
            completeBtn.innerHTML = '<i class="fas fa-user-edit"></i> Modifier le profil';
        }
        
        console.log("UI update completed");
    }

    // Handle wilaya and commune selection
    document.getElementById('wilaya').addEventListener('change', function() {
        const wilayaValue = this.value;
        const communeSelect = document.getElementById('commune');
        
        // Clear current options
        communeSelect.innerHTML = '';
        
        if (wilayaValue) {
            communeSelect.removeAttribute('disabled');
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Sélectionner une commune';
            communeSelect.appendChild(defaultOption);
            
            // Add communes for selected wilaya
            const communes = communesByWilaya[wilayaValue] || [];
            communes.forEach(commune => {
                const option = document.createElement('option');
                option.value = commune.toLowerCase().replace(/ /g, '-');
                option.textContent = commune;
                communeSelect.appendChild(option);
            });
        } else {
            communeSelect.setAttribute('disabled', 'disabled');
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'Sélectionner d\'abord une wilaya';
            communeSelect.appendChild(option);
        }
    });

    // Avatar upload handling
    document.getElementById('avatarOverlay').addEventListener('click', () => {
        document.getElementById('avatarUpload').click();
    });

    document.getElementById('avatarUpload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validate file type and size
        const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
        if (!validTypes.includes(file.type)) {
            alert('Veuillez sélectionner une image (JPEG, PNG ou GIF)');
            return;
        }
        
        if (file.size > 2 * 1024 * 1024) {
            alert('L\'image ne doit pas dépasser 2 MB');
            return;
        }
        
        // Preview image
        const reader = new FileReader();
        reader.onload = (event) => {
            document.getElementById('userAvatar').src = event.target.result;
        };
        reader.readAsDataURL(file);
        
        // Upload to Firebase Storage
        try {
            const user = auth.currentUser;
            if (user) {
                const storageRef = ref(storage, `avatars/${user.uid}`);
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);
                
                // Update user profile with new avatar URL
                const userRef = doc(db, 'users', user.uid);
                await updateDoc(userRef, {
                    avatarURL: downloadURL
                });
                
                console.log('Avatar updated successfully');
            }
        } catch (error) {
            console.error('Error uploading avatar:', error);
            alert('Erreur lors du téléchargement de l\'image');
        }
    });

    // Form validation for Profile Completion (modified to handle radio buttons)
    document.getElementById('profileCompletionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        let isValid = true;
        const wilaya = document.getElementById('wilaya').value;
        const commune = document.getElementById('commune').value;
        const birthdate = document.getElementById('birthdate').value;
        const instagram = document.getElementById('instagram').value;
        const phoneNumber = document.getElementById('phoneNumber').value;
        
        // Get gender from radio buttons instead of select element
        const maleRadio = document.getElementById('gender-male');
        const femaleRadio = document.getElementById('gender-female');
        const gender = maleRadio.checked ? maleRadio.value : (femaleRadio.checked ? femaleRadio.value : '');
        
        // Validate wilaya and commune
        if (!wilaya) {
            document.getElementById('wilayaError').textContent = 'Veuillez sélectionner une wilaya';
            document.getElementById('wilayaError').classList.remove('hidden');
            isValid = false;
        } else {
            document.getElementById('wilayaError').classList.add('hidden');
        }
        
        if (!commune) {
            document.getElementById('communeError').textContent = 'Veuillez sélectionner une commune';
            document.getElementById('communeError').classList.remove('hidden');
            isValid = false;
        } else {
            document.getElementById('communeError').classList.add('hidden');
        }
        
        // Validate birthdate
        if (!birthdate) {
            document.getElementById('birthdateError').textContent = 'Veuillez entrer votre date de naissance';
            document.getElementById('birthdateError').classList.remove('hidden');
            isValid = false;
        } else {
            const date = new Date(birthdate);
            const minDate = new Date('2000-01-01');
            const maxDate = new Date('2009-12-31');
            
            if (date < minDate || date > maxDate) {
                document.getElementById('birthdateError').textContent = 'La date doit être entre 2000 et 2009';
                document.getElementById('birthdateError').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('birthdateError').classList.add('hidden');
            }
        }
        
        // Validate Instagram if provided
        if (instagram) {
            const regex = /^[a-zA-Z0-9_.]{1,30}$/;
            if (!regex.test(instagram)) {
                document.getElementById('instagramError').textContent = 'Format de nom d\'utilisateur Instagram invalide';
                document.getElementById('instagramError').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('instagramError').classList.add('hidden');
            }
        } else {
            document.getElementById('instagramError').classList.add('hidden');
        }

        // Validate gender using radio buttons
        if (!gender) {
            document.getElementById('genderError').textContent = 'Veuillez sélectionner votre genre';
            document.getElementById('genderError').classList.remove('hidden');
            isValid = false;
        } else {
            document.getElementById('genderError').classList.add('hidden');
        }

        // Validate phone number
        if (phoneNumber) {
            const phoneRegex = /^(\+213|0)[567][0-9]{8}$/;
            if (!phoneRegex.test(phoneNumber)) {
                document.getElementById('phoneNumberError').textContent = 'Format de numéro de téléphone invalide';
                document.getElementById('phoneNumberError').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('phoneNumberError').classList.add('hidden');
            }
        }
        
        // If all validations pass, update profile
        if (isValid) {
            try {
                const user = auth.currentUser;
                if (user) {
                    const userRef = doc(db, 'users', user.uid);
                    
                    // Prepare user data update - REMOVED academicYear
                    const updateData = {
                        wilaya: wilaya,
                        commune: commune,
                        birthdate: birthdate,
                        gender: gender
                    };
                    
                    if (instagram) {
                        updateData.instagram = instagram;
                    }

                    if (phoneNumber) {
                        updateData.phoneNumber = phoneNumber;
                    }
                    
                    // Update in Firestore
                    await updateDoc(userRef, updateData);
                    console.log("User profile updated in Firestore:", updateData);
                    
                    // Close modal and refresh data
                    const modal = document.getElementById('profileModal');
                    const modalContent = document.getElementById('modalContent');
                    
                    // Animate content out
                    modalContent.classList.remove('scale-100', 'opacity-100');
                    modalContent.classList.add('scale-95', 'opacity-0');
                    
                    // Hide modal after animation completes
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        
                        // Fetch updated user data
                        getDoc(userRef).then((updatedSnap) => {
                            if (updatedSnap.exists()) {
                                updateUIWithUserData(updatedSnap.data());
                            }
                        });
                        
                        alert('Profil mis à jour avec succès!');
                    }, 300);
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Une erreur est survenue lors de la mise à jour du profil');
            }
        }
    });

    // Initialize page
    async function initializePage() {
        console.log("Starting page initialization...");
        showLoadingState();

        try {
            // Check if user is authenticated
            const user = auth.currentUser;
            
            if (!user) {
                console.error("No authenticated user found, redirecting to login page");
                window.location.href = 'auth.html';
                return;
            }

            console.log("User authenticated:", user.uid);
            
            // Get user document from Firestore
            const userRef = doc(db, 'users', user.uid);
            console.log("Fetching document from:", userRef.path);
            
            const userSnap = await getDoc(userRef);
            
            if (userSnap.exists()) {
                const userData = userSnap.data();
                console.log("User data fetched successfully:", userData);
                
                // Update UI with fetched data
                updateUIWithUserData(userData);
                
                // Populate form fields for the modal
                populateFormFields(userData);
            } else {
                console.error("No user document found in Firestore for ID:", user.uid);
                alert("Erreur: Impossible de trouver votre profil. Veuillez vous reconnecter.");
            }
        } catch (error) {
            console.error('Error fetching user data:', error);
            alert("Une erreur est survenue lors du chargement de votre profil");
        } finally {
            hideLoadingState();
        }
    }

    // Helper function to populate form fields
    function populateFormFields(userData) {
        // Only proceed if elements exist
        if (!document.getElementById('wilaya')) {
            console.log("Form elements not found - form might not be loaded yet");
            return;
        }

        console.log("Populating form fields with:", userData);
        
        // Set wilaya and trigger change event to populate communes
        if (userData.wilaya) {
            document.getElementById('wilaya').value = userData.wilaya;
            const event = new Event('change');
            document.getElementById('wilaya').dispatchEvent(event);
            
            // Set commune value after communes are populated
            if (userData.commune) {
                setTimeout(() => {
                    try {
                        const communeSelect = document.getElementById('commune');
                        const communeValue = userData.commune.toLowerCase().replace(/ /g, '-');
                        
                        // Check if option exists before setting
                        const optionExists = Array.from(communeSelect.options).some(option => option.value === communeValue);
                        if (optionExists) {
                            communeSelect.value = communeValue;
                        } else {
                            console.warn(`Commune option ${communeValue} not found in select`);
                        }
                    } catch (e) {
                        console.error("Error setting commune value:", e);
                    }
                }, 300); // Increased timeout to ensure options are loaded
            }
        }
        
        // Set other form fields
        if (userData.birthdate) document.getElementById('birthdate').value = userData.birthdate;
        if (userData.instagram) document.getElementById('instagram').value = userData.instagram;
        
        // Set gender radio buttons correctly
        if (userData.gender) {
            const maleRadio = document.getElementById('gender-male');
            const femaleRadio = document.getElementById('gender-female');
            
            if (userData.gender === 'Masculin' && maleRadio) {
                maleRadio.checked = true;
            } else if (userData.gender === 'Féminin' && femaleRadio) {
                femaleRadio.checked = true;
            }
        }
        
        // Set phone number
        if (userData.phoneNumber) document.getElementById('phoneNumber').value = userData.phoneNumber;
    }

    // Handle logout with better error handling
    document.getElementById('logoutButton').addEventListener('click', async () => {
        console.log("Logout button clicked");
        try {
            // Sign out from Firebase
            await signOut(auth);
            console.log("User signed out successfully");
            
            // Clear any local storage data
            localStorage.removeItem('userData');
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            
            // Redirect to auth page
            window.location.href = 'auth.html';
        } catch (error) {
            console.error('Error during logout:', error);
            alert('Une erreur est survenue lors de la déconnexion. Veuillez réessayer.');
        }
    });

    // Ensure DOM is ready before trying to access elements
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM content loaded, checking Firebase initialization...");
        
        // Add safe event listener function that checks if element exists
        function addSafeEventListener(selector, eventType, callback) {
            const element = document.getElementById(selector);
            if (element) {
                element.addEventListener(eventType, callback);
            } else {
                console.warn(`Element with ID '${selector}' not found in the DOM`);
            }
        }
        
        // Profile completion button
        addSafeEventListener('completeProfileBtn', 'click', function(e) {
            e.preventDefault();
            const modal = document.getElementById('profileModal');
            const modalContent = document.getElementById('modalContent');
            
            if (modal && modalContent) {
                // Show modal
                modal.classList.remove('hidden');
                
                // Animate content after a small delay
                setTimeout(() => {
                    modalContent.classList.add('scale-100', 'opacity-100');
                    modalContent.classList.remove('scale-95', 'opacity-0');
                }, 50);
            }
        });

        // Close modal button
        addSafeEventListener('closeModalBtn', 'click', function(e) {
            e.preventDefault();
            const modal = document.getElementById('profileModal');
            const modalContent = document.getElementById('modalContent');
            
            if (modal && modalContent) {
                // Animate content out
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');
                
                // Hide modal after animation completes
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        });

        // Avatar upload click handler
        addSafeEventListener('avatarOverlay', 'click', function() {
            const avatarUpload = document.getElementById('avatarUpload');
            if (avatarUpload) {
                avatarUpload.click();
            }
        });

        // Avatar upload change handler
        addSafeEventListener('avatarUpload', 'change', function(e) {
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        userAvatar.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        // Form submission handler 
        addSafeEventListener('profileCompletionForm', 'submit', function(e) {
            e.preventDefault();
            console.log("Form submitted - validation will happen in the module script");
        });
    });

    // Add this at the end of your script to ensure immediate auth check

    // Check authentication status immediately when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        // Check if we need to wait for Firebase to initialize
        if (auth) {
            // Firebase is already initialized, check auth state
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in, initialize the page
                    initializePage();
                } else {
                    // No user is signed in, redirect to auth
                    console.log("No user is signed in, redirecting to auth.html");
                    window.location.href = 'auth.html';
                }
            });
        } else {
            console.log("Firebase Auth not yet initialized");
            // Could add a retry mechanism here if needed
        }
    });

    // Replace the auth check code at the bottom of the script

    // Wait for both DOM and Firebase to be ready before initializing
    function initWhenReady() {
        // Check if both DOM is ready and Firebase Auth is available
        if (document.readyState === 'complete' && typeof auth !== 'undefined') {
            console.log("Both DOM and Firebase Auth are ready, checking authentication");
            
            // Check authentication state
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("User is authenticated:", user.uid);
                    initializePage();
                } else {
                    console.log("No authenticated user, redirecting to auth.html");
                    window.location.href = 'auth.html';
                }
            });
        } else {
            // Try again in a moment
            setTimeout(initWhenReady, 100);
        }
    }

    // Start the initialization process
    initWhenReady();

    // Remove duplicate event listeners and initialization code
    // Remove these sections:
    // - The duplicate DOMContentLoaded event listener that calls checkFirebaseAuth
    // - The duplicate form submission handler
</script>
</body>
</html>