<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentification - ISET'COM</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/auth.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body class="flex flex-col min-h-screen bg-gray-50">
    <!-- Top banner -->
    <div>
        <script type="text/javascript">
            aclib.runBanner({
                zoneId: '9521434',
            });
        </script>
    </div>

    <header class="mb-12 mt-8" data-aos="fade-down">
        <div class="header-container flex justify-between items-center px-4">
            <a href="index.html" class="back-button hover:scale-110 transform transition-all duration-300">
                <i class="fas fa-arrow-left"></i>
                Retour
            </a>
            <img src="assets/img/LOGO.png" alt="ISET'COM" class="max-w-[200px]">
        </div>
    </header>

    <div class="container mx-auto px-4 max-w-6xl flex-grow flex justify-center items-center">
        <div class="glass-card w-full max-w-md p-8 rounded-lg shadow-lg" data-aos="fade-up">
            <div class="tabs flex justify-center mb-6">
                <button class="tab-btn active" data-tab="login">Connexion</button>
                <button class="tab-btn" data-tab="register">Inscription</button>
            </div>
            
            <!-- Login Form -->
            <div id="login" class="tab-content active">
                <h1 class="text-3xl font-bold mb-8 text-center text-gray-800">Connexion</h1>
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label for="emailLogin" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="emailLogin" class="custom-input" required>
                    </div>
                    <div>
                        <label for="passwordLogin" class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                        <input type="password" id="passwordLogin" class="custom-input" required>
                    </div>
                    <div class="text-center mt-8">
                        <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transform hover:scale-105 transition-all duration-300 shadow-lg">
                            <i class="fas fa-sign-in-alt mr-2"></i>
                            Se connecter
                        </button>
                    </div>
                </form>
            </div>

            <!-- Registration Form -->
            <div id="register" class="tab-content">
                <h1 class="text-3xl font-bold mb-8 text-center text-gray-800">Inscription</h1>
                <form id="registerForm" class="space-y-6">
                    <div>
                        <label for="fullNameRegister" class="block text-sm font-medium text-gray-700 mb-2">Nom complet</label>
                        <input type="text" id="fullNameRegister" class="custom-input" required>
                    </div>
                    <div>
                        <label for="matriculeRegister" class="block text-sm font-medium text-gray-700 mb-2">Numéro d'immatriculation</label>
                        <input type="text" id="matriculeRegister" class="custom-input" required>
                    </div>
                    <div>
                        <label for="yearRegister" class="block text-sm font-medium text-gray-700 mb-2">Année d'étude</label>
                        <select id="yearRegister" class="custom-input" required onchange="updateSpecialities()">
                            <option value="">Sélectionnez votre année</option>
                            <option value="1">1ère année</option>
                            <option value="2">2ème année</option>
                            <option value="3">3ème année</option>
                            <option value="4">4ème année (Master 1)</option>
                            <option value="5">5ème année (Master 2)</option>
                        </select>
                    </div>
                    <div>
                        <label for="specialityRegister" class="block text-sm font-medium text-gray-700 mb-2">Spécialité</label>
                        <select id="specialityRegister" class="custom-input" required>
                            <option value="">Sélectionnez d'abord une année</option>
                        </select>
                    </div>
                    <div>
                        <label for="emailRegister" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="emailRegister" class="custom-input" required>
                    </div>
                    <div>
                        <label for="passwordRegister" class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                        <input type="password" id="passwordRegister" class="custom-input" required>
                    </div>
                    <div>
                        <label for="phoneNumberRegister" class="block text-sm font-medium text-gray-700 mb-2">Numéro de téléphone</label>
                        <input type="text" id="phoneNumberRegister" class="custom-input" required>
                    </div>
                    <div class="text-center mt-8">
                        <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transform hover:scale-105 transition-all duration-300 shadow-lg">
                            <i class="fas fa-user-plus mr-2"></i>
                            S'inscrire
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Middle banner -->
    <div>
        <script type="text/javascript">
            aclib.runBanner({
                zoneId: '9521434',
            });
        </script>
    </div>

    <footer class="text-center text-gray-600 text-sm py-4">
        <div>&copy; 2025 Université de Bejaia. Développé par <a href="mailto:mehdi.amara@tech.univ-bejaia.dz" class="text-blue-500 hover:text-blue-700">Amara Mehdi</a></div>
    </footer>

    <!-- Popup Box -->
    <div id="popupBox" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="glass-card w-full max-w-md p-8 rounded-lg shadow-lg text-center">
            <h2 class="text-2xl font-bold mb-4">Bienvenue sur notre plateforme</h2>
            <div class="space-y-4">
                <button id="homeButton" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transform hover:scale-105 transition-all duration-300 shadow-lg">Accédez écran accueil</button>
                <button id="coursesButton" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transform hover:scale-105 transition-all duration-300 shadow-lg">Espace cours</button>
                <button id="profileButton" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transform hover:scale-105 transition-all duration-300 shadow-lg">Profil</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        // Initialize AOS
        AOS.init({
            duration: 800,
            once: true
        });

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB5XYqWKhHdiVDXJx4iOwtpxD8eUCPRfKU",
            authDomain: "universite-de-bejaia-547fc.firebaseapp.com",
            projectId: "universite-de-bejaia-547fc",
            storageBucket: "universite-de-bejaia-547fc.firebasestorage.app",
            messagingSenderId: "517622731583",
            appId: "1:517622731583:web:25453d5e01226585bf798a",
            measurementId: "G-SQ0WWSCS7B"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Add this after your existing Firebase configuration
        const specialities = {
            1: [
                "Science et Technologie LMD",
                "Informatique LMD",
                "Biologie",
                "Mathématiques",
                "Science de la matière",
                "Science et Technologie Ingénieur",
                "Informatique ING",
                "Architecture",
                "Médecine",
                "Pharmacie",
                "Droit",
                "SEGC",
                "Langue Française",
                "Langue Arabe",
                "Langue Tamazight",
                "Langue Anglaise",
                "Science Sociale",
                "Traduction"
            ],
            2: [
                "Génie des Procédés",
                "Automatique",
                "Exploitation des mines",
                // ... add all 2nd year specialties
            ],
            3: [
                "Génie des Procédés",
                "Automatique",
                "Exploitation des mines",
                // ... add all 3rd year specialties
            ]
        };

        function updateSpecialities() {
            const yearSelect = document.getElementById('yearRegister');
            const specialitySelect = document.getElementById('specialityRegister');
            const year = yearSelect.value;

            // Clear current options
            specialitySelect.innerHTML = '<option value="">Sélectionnez votre spécialité</option>';

            if (year && specialities[year]) {
                specialities[year].forEach(speciality => {
                    const option = document.createElement('option');
                    option.value = speciality;
                    option.textContent = speciality;
                    specialitySelect.appendChild(option);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Tab Handling
            const tabs = document.querySelectorAll('.tab-btn');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });

            // Registration Handler
            document.getElementById('registerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('emailRegister').value;
                const password = document.getElementById('passwordRegister').value;
                const fullName = document.getElementById('fullNameRegister').value;
                const phoneNumber = document.getElementById('phoneNumberRegister').value;
                const matricule = document.getElementById('matriculeRegister').value;
                const year = document.getElementById('yearRegister').value;
                const speciality = document.getElementById('specialityRegister').value;

                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    
                    await db.collection('users').doc(userCredential.user.uid).set({
                        fullName,
                        email,
                        phoneNumber,
                        matricule,
                        year,
                        speciality,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Show success message and redirect to login
                    alert('Inscription réussie! Vous pouvez maintenant vous connecter.');
                    document.querySelector('[data-tab="login"]').click();
                    document.getElementById('registerForm').reset();
                } catch (error) {
                    handleAuthError(error);
                }
            });

            // Login Handler
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('emailLogin').value;
                const password = document.getElementById('passwordLogin').value;

                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    
                    if (userCredential.user) {
                        // Get user data from Firestore
                        const userDoc = await db.collection('users').doc(userCredential.user.uid).get();
                        if (userDoc.exists) {
                            // Store user data in localStorage
                            localStorage.setItem('userData', JSON.stringify(userDoc.data()));
                            localStorage.setItem('userId', userCredential.user.uid);
                            localStorage.setItem('token', await userCredential.user.getIdToken());

                            // Show success popup
                            const popupBox = document.getElementById('popupBox');
                            const popupTitle = popupBox.querySelector('h2');
                            popupTitle.classList.add('text-green-600');
                            popupTitle.textContent = 'Connexion réussie!';
                            popupBox.style.display = 'flex';
                            popupBox.classList.remove('hidden');
                        }
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    handleAuthError(error);
                }
            });

            // Auth State Listener
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    console.log('User logged in:', user.uid);
                } else {
                    // User is signed out
                    console.log('User signed out');
                }
            });

            // Popup Handlers
            document.getElementById('homeButton').addEventListener('click', () => {
                window.location.href = 'index.html';
            });

            document.getElementById('coursesButton').addEventListener('click', () => {
                window.location.href = 'courses.html';
            });

            document.getElementById('profileButton').addEventListener('click', () => {
                window.location.href = 'profile.html';
            });

            // Error Handling
            function handleAuthError(error) {
                let message = "Une erreur est survenue";
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        message = "Cet email est déjà utilisé";
                        break;
                    case 'auth/invalid-email':
                        message = "Email invalide";
                        break;
                    case 'auth/weak-password':
                        message = "Le mot de passe doit contenir au moins 6 caractères";
                        break;
                    case 'auth/wrong-password':
                        message = "Mot de passe incorrect";
                        break;
                    case 'auth/user-not-found':
                        message = "Utilisateur non trouvé";
                        break;
                }
                alert(message);
            }

            // Add this to ensure popup can be closed
            document.addEventListener('click', (e) => {
                const popupBox = document.getElementById('popupBox');
                if (e.target === popupBox) {
                    popupBox.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>